<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- This file was created with the aha Ansi HTML Adapter. http://ziz.delphigl.com/tool_aha.php -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xml+xhtml; charset=UTF-8" />
<title>stdin</title>
</head>
<body>
<pre>
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
added: sip-proxy/src/gov/nist/sip/proxy/Chargement.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ Chargement.java:3 @</span><span style="font-weight:bold;text-decoration:blink;"></span>
<span style="color:green;"></span><span style="color:green;">package gov.nist.sip.proxy;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">public class Chargement {</span>
<span style="color:green;"></span>	<span style="color:green;">public static Double normalChargement = 0.03;</span>
<span style="color:green;"></span>	<span style="color:green;">public static Double premiumChargement = 0.01;</span>
<span style="color:green;"></span><span style="color:green;">}</span>
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/Proxy.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ Proxy.java:25 @</span><span style="font-weight:bold;text-decoration:blink;"> import gov.nist.javax.sip.header.*;</span>
/*
import sim.java.net.*;
//endif
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">*/</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;"> </span><span style="color:green;font-weight:bold;">*/</span>


/** Proxy Entry point.
<span style="color:teal;">@ Proxy.java:39 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> import sim.java.net.*;</span>
 *
 */
public class Proxy implements SipListener  {
<span style="color:red;">    </span>
<span style="color:red;">    protected LinkedList listeningPoints;</span>
<span style="color:red;">    // Map the server transactions with the client transactions</span>
<span style="color:red;">    protected SipStack sipStack;</span>
<span style="color:red;">    protected SipProvider defaultProvider;</span>
<span style="color:red;">    </span>
<span style="color:red;">    protected MessageFactory messageFactory;</span>
<span style="color:red;">    protected HeaderFactory headerFactory;</span>
<span style="color:red;">    protected AddressFactory addressFactory;</span>
<span style="color:red;">    </span>
<span style="color:red;">    protected Configuration configuration;</span>
<span style="color:red;">    protected PresenceServer presenceServer;</span>
<span style="color:red;">  </span>
<span style="color:red;">    protected Registrar registrar;</span>
<span style="color:red;">    protected ProxyUtilities proxyUtilities;</span>
<span style="color:red;">    protected Authentication authentication;</span>
<span style="color:red;">    protected RequestForwarding requestForwarding;</span>
<span style="color:red;">    protected ResponseForwarding responseForwarding;</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">   </span>
<span style="color:red;">    public RequestForwarding getRequestForwarding() {</span>
<span style="color:red;">        return requestForwarding;</span>
<span style="color:red;">    }</span>
<span style="color:red;">     </span>
<span style="color:red;">    public ResponseForwarding getResponseForwarding() {</span>
<span style="color:red;">        return responseForwarding;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public AddressFactory getAddressFactory() {</span>
<span style="color:red;">        return addressFactory;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public MessageFactory getMessageFactory() {</span>
<span style="color:red;">        return messageFactory;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public HeaderFactory getHeaderFactory() {</span>
<span style="color:red;">        return headerFactory;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public Registrar getRegistrar() {</span>
<span style="color:red;">        return registrar;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">        </span>
<span style="color:red;">    public boolean isPresenceServer() {</span>
<span style="color:red;">        return configuration.enablePresenceServer;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public PresenceServer getPresenceServer() {</span>
<span style="color:red;">            return presenceServer;</span>
<span style="color:red;">    }</span>
<span style="color:red;">   </span>
<span style="color:red;">    public ProxyUtilities getProxyUtilities() {</span>
<span style="color:red;">        return proxyUtilities;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public SipStack getSipStack() {</span>
<span style="color:red;">        return sipStack;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public Configuration getConfiguration() {</span>
<span style="color:red;">        return configuration;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    /** get the first allocated provider.</span>
<span style="color:red;">    */</span>
<span style="color:red;">    public SipProvider getSipProvider() {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected LinkedList listeningPoints;</span>
<span style="color:green;"></span>	<span style="color:green;">// Map the server transactions with the client transactions</span>
<span style="color:green;"></span>	<span style="color:green;">protected SipStack sipStack;</span>
<span style="color:green;"></span>	<span style="color:green;">protected SipProvider defaultProvider;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected MessageFactory messageFactory;</span>
<span style="color:green;"></span>	<span style="color:green;">protected HeaderFactory headerFactory;</span>
<span style="color:green;"></span>	<span style="color:green;">protected AddressFactory addressFactory;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected Configuration configuration;</span>
<span style="color:green;"></span>	<span style="color:green;">protected PresenceServer presenceServer;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected Registrar registrar;</span>
<span style="color:green;"></span>	<span style="color:green;">protected ProxyUtilities proxyUtilities;</span>
<span style="color:green;"></span>	<span style="color:green;">protected Authentication authentication;</span>
<span style="color:green;"></span>	<span style="color:green;">protected RequestForwarding requestForwarding;</span>
<span style="color:green;"></span>	<span style="color:green;">protected ResponseForwarding responseForwarding;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public RequestForwarding getRequestForwarding() {</span>
<span style="color:green;"></span>		<span style="color:green;">return requestForwarding;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public ResponseForwarding getResponseForwarding() {</span>
<span style="color:green;"></span>		<span style="color:green;">return responseForwarding;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public AddressFactory getAddressFactory() {</span>
<span style="color:green;"></span>		<span style="color:green;">return addressFactory;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public MessageFactory getMessageFactory() {</span>
<span style="color:green;"></span>		<span style="color:green;">return messageFactory;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public HeaderFactory getHeaderFactory() {</span>
<span style="color:green;"></span>		<span style="color:green;">return headerFactory;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Registrar getRegistrar() {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrar;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean isPresenceServer() {</span>
<span style="color:green;"></span>		<span style="color:green;">return configuration.enablePresenceServer;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public PresenceServer getPresenceServer() {</span>
<span style="color:green;"></span>		<span style="color:green;">return presenceServer;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public ProxyUtilities getProxyUtilities() {</span>
<span style="color:green;"></span>		<span style="color:green;">return proxyUtilities;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public SipStack getSipStack() {</span>
<span style="color:green;"></span>		<span style="color:green;">return sipStack;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Configuration getConfiguration() {</span>
<span style="color:green;"></span>		<span style="color:green;">return configuration;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">/** get the first allocated provider.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public SipProvider getSipProvider() {</span>
		return this.defaultProvider;
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public Authentication getAuthentication() {</span>
<span style="color:red;">        return authentication;</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public boolean managesDomain( String domainAddress ) {</span>
<span style="color:red;">       return   configuration.hasDomain(domainAddress) || </span>
<span style="color:red;">		registrar.hasRegistration(&quot;sip:&quot;+domainAddress);</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    /** Creates new Proxy */</span>
<span style="color:red;">    public Proxy(String confFile) throws Exception{</span>
<span style="color:red;">      </span>
<span style="color:red;">	this.listeningPoints = new LinkedList();</span>
<span style="color:red;">        if (confFile==null) {</span>
<span style="color:red;">            System.out.println</span>
<span style="color:red;">            (&quot;ERROR: Set the configuration file flag: &quot; +</span>
<span style="color:red;">            &quot;USE: -cf configuration_file_location.xml&quot;  );</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            try {</span>
<span style="color:red;">               </span>
<span style="color:red;">                // First, let's parse the configuration file.</span>
<span style="color:red;">                ProxyConfigurationHandler handler=</span>
<span style="color:red;">                new ProxyConfigurationHandler(confFile);</span>
<span style="color:red;">                configuration=handler.getConfiguration();</span>
<span style="color:red;">                if (configuration==null ||</span>
<span style="color:red;">                !configuration.isValidConfiguration()) {</span>
<span style="color:red;">                    System.out.println</span>
<span style="color:red;">                    (&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:red;">                    &quot; Correct the errors first.&quot;);</span>
<span style="color:red;">                    throw new Exception</span>
<span style="color:red;">		    (&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:red;">                    &quot; Correct the errors first.&quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                else {</span>
<span style="color:red;">                  </span>
<span style="color:red;">                    proxyUtilities=new ProxyUtilities(this);</span>
<span style="color:red;">                    presenceServer=new PresenceServer(this);</span>
<span style="color:red;">                    registrar=new Registrar(this);</span>
<span style="color:red;">                    requestForwarding=new RequestForwarding(this);</span>
<span style="color:red;">                    responseForwarding=new ResponseForwarding(this);</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            catch (Exception ex) {</span>
<span style="color:red;">                System.out.println</span>
<span style="color:red;">                (&quot;ERROR: exception raised while initializing the proxy&quot;);</span>
<span style="color:red;">                ex.printStackTrace();</span>
<span style="color:red;">                throw new Exception</span>
<span style="color:red;">		(&quot;ERROR: exception raised while initializing the proxy&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">   </span>
<span style="color:red;">   </span>
<span style="color:red;">    /** This is a listener method.</span>
<span style="color:red;">     */ </span>
<span style="color:red;">    public void processRequest(RequestEvent requestEvent) {</span>
<span style="color:red;">        Request request = requestEvent.getRequest();</span>
<span style="color:red;">        </span>
<span style="color:red;">        SipProvider sipProvider = (SipProvider) requestEvent.getSource();</span>
<span style="color:red;">        ServerTransaction serverTransaction=requestEvent.getServerTransaction();</span>
<span style="color:red;">        try {</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (ProxyDebug.debug)</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">                (&quot;\n****************************************************&quot;+</span>
<span style="color:red;">                &quot;\nRequest &quot; + request.getMethod() +</span>
<span style="color:red;">			&quot; received:\n&quot;+request.toString());</span>
<span style="color:red;">            </span>
<span style="color:red;">       </span>
<span style="color:red;">            if (ProxyDebug.debug) </span>
<span style="color:red;">                 ProxyUtilities.printTransaction(serverTransaction);</span>
<span style="color:red;">               </span>
<span style="color:red;">       </span>
<span style="color:red;">            </span>
<span style="color:red;">/*******************************************************************************/</span>
<span style="color:red;">/***********************  PROXY BEHAVIOR    ************************************/</span>
<span style="color:red;">/*******************************************************************************/</span>
<span style="color:red;">            </span>
<span style="color:red;">            /* RFC 3261: 16.2:</span>
<span style="color:red;">             * For all new requests, including any with unknown methods, an element</span>
<span style="color:red;">             * intending to proxy the request MUST:</span>
<span style="color:red;">             *</span>
<span style="color:red;">             * 1. Validate the request (Section 16.3)</span>
<span style="color:red;">             *</span>
<span style="color:red;">             * 2. Preprocess routing information (Section 16.4)</span>
<span style="color:red;">             *</span>
<span style="color:red;">             * 3. Determine target(s) for the request (Section 16.5)</span>
<span style="color:red;">             *</span>
<span style="color:red;">             * 4. Forward the request to each target (Section 16.6)</span>
<span style="color:red;">             *</span>
<span style="color:red;">             * 5. Process all responses (Section 16.7)</span>
<span style="color:red;">             */</span>
<span style="color:red;">            </span>
<span style="color:red;">/*******************************************************************************/</span>
<span style="color:red;">/***************************** 1. Validate the request (Section 16.3) **********/</span>
<span style="color:red;">/*******************************************************************************/</span>
<span style="color:red;">             </span>
<span style="color:red;">           /*</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Authentication getAuthentication() {</span>
<span style="color:green;"></span>		<span style="color:green;">return authentication;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean managesDomain( String domainAddress ) {</span>
<span style="color:green;"></span>		<span style="color:green;">return   configuration.hasDomain(domainAddress) ||</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">registrar.hasRegistration(&quot;sip:&quot;+domainAddress);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** Creates new Proxy */</span>
<span style="color:green;"></span>	<span style="color:green;">public Proxy(String confFile) throws Exception{</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">this.listeningPoints = new LinkedList();</span>
<span style="color:green;"></span>		<span style="color:green;">if (confFile==null) {</span>
<span style="color:green;"></span>			<span style="color:green;">System.out.println</span>
<span style="color:green;"></span>			<span style="color:green;">(&quot;ERROR: Set the configuration file flag: &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot;USE: -cf configuration_file_location.xml&quot;  );</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">try {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">// First, let's parse the configuration file.</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyConfigurationHandler handler=</span>
<span style="color:green;"></span>						<span style="color:green;">new ProxyConfigurationHandler(confFile);</span>
<span style="color:green;"></span>				<span style="color:green;">configuration=handler.getConfiguration();</span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration==null ||</span>
<span style="color:green;"></span>						<span style="color:green;">!configuration.isValidConfiguration()) {</span>
<span style="color:green;"></span>					<span style="color:green;">System.out.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; Correct the errors first.&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">throw new Exception</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; Correct the errors first.&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">else {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">proxyUtilities=new ProxyUtilities(this);</span>
<span style="color:green;"></span>					<span style="color:green;">presenceServer=new PresenceServer(this);</span>
<span style="color:green;"></span>					<span style="color:green;">registrar=new Registrar(this);</span>
<span style="color:green;"></span>					<span style="color:green;">requestForwarding=new RequestForwarding(this);</span>
<span style="color:green;"></span>					<span style="color:green;">responseForwarding=new ResponseForwarding(this);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;ERROR: exception raised while initializing the proxy&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ex.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">throw new Exception</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;ERROR: exception raised while initializing the proxy&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** This is a listener method.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void processRequest(RequestEvent requestEvent) {</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Pare to stack: &quot;+Thread.currentThread().getStackTrace().toString());</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">for (StackTraceElement ste : Thread.currentThread().getStackTrace()) {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(ste.toString());</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">Request request = requestEvent.getRequest();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">        ProxyDebug.println(&quot;perase sto 0 To request in proxy, request: &quot;+request.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">SipProvider sipProvider = (SipProvider) requestEvent.getSource();</span>
<span style="color:green;"></span>		<span style="color:green;">ServerTransaction serverTransaction=requestEvent.getServerTransaction();</span>
<span style="color:green;"></span>		<span style="color:green;">try {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;\n****************************************************&quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;\nRequest &quot; + request.getMethod() +</span>
<span style="color:green;"></span>						<span style="color:green;">&quot; received:\n&quot;+request.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">ProxyUtilities.printTransaction(serverTransaction);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/*******************************************************************************/</span>
<span style="color:green;"></span>			<span style="color:green;">/***********************  PROXY BEHAVIOR    ************************************/</span>
<span style="color:green;"></span>			<span style="color:green;">/*******************************************************************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/* RFC 3261: 16.2:</span>
<span style="color:green;"></span>			<span style="color:green;"> * For all new requests, including any with unknown methods, an element</span>
<span style="color:green;"></span>			<span style="color:green;"> * intending to proxy the request MUST:</span>
<span style="color:green;"></span>			<span style="color:green;"> *</span>
<span style="color:green;"></span>			<span style="color:green;"> * 1. Validate the request (Section 16.3)</span>
<span style="color:green;"></span>			<span style="color:green;"> *</span>
<span style="color:green;"></span>			<span style="color:green;"> * 2. Preprocess routing information (Section 16.4)</span>
<span style="color:green;"></span>			<span style="color:green;"> *</span>
<span style="color:green;"></span>			<span style="color:green;"> * 3. Determine target(s) for the request (Section 16.5)</span>
<span style="color:green;"></span>			<span style="color:green;"> *</span>
<span style="color:green;"></span>			<span style="color:green;"> * 4. Forward the request to each target (Section 16.6)</span>
<span style="color:green;"></span>			<span style="color:green;"> *</span>
<span style="color:green;"></span>			<span style="color:green;"> * 5. Process all responses (Section 16.7)</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/*******************************************************************************/</span>
<span style="color:green;"></span>			<span style="color:green;">/***************************** 1. Validate the request (Section 16.3) **********/</span>
<span style="color:green;"></span>			<span style="color:green;">/*******************************************************************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
            Before an element can proxy a request, it MUST verify the message's
            validity
<span style="color:red;">            */</span>
<span style="color:red;">            </span>
<span style="color:red;">            RequestValidation requestValidation=new RequestValidation(this);</span>
<span style="color:red;">            if ( !requestValidation.validateRequest</span>
<span style="color:red;">		(sipProvider,request,serverTransaction) ) {</span>
<span style="color:red;">                // An appropriate response has been sent back by the request</span>
<span style="color:red;">                // validation step, so we just return. The request has been</span>
<span style="color:red;">                // processed!</span>
<span style="color:red;">                if (ProxyDebug.debug)</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Proxy, processRequest(), the request has not been&quot;+</span>
<span style="color:red;">                &quot; validated, so the request is discarded &quot;  +</span>
<span style="color:red;">		&quot; (an error code has normally been&quot;+</span>
<span style="color:red;">                &quot; sent back)&quot;);</span>
<span style="color:red;">                return;</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            // Let's check if the ACK is for the proxy: if there is no Route</span>
<span style="color:red;">            // header: it is mandatory for the ACK to be forwarded</span>
<span style="color:red;">            if ( request.getMethod().equals(Request.ACK) ) {</span>
<span style="color:red;">                  ListIterator routes = request.getHeaders(RouteHeader.NAME);</span>
<span style="color:red;">                  if (routes==null  || !routes.hasNext()) {</span>
<span style="color:red;">                      if (ProxyDebug.debug)</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Proxy, processRequest(), &quot;+</span>
<span style="color:red;">		    &quot;the request is an ACK&quot;+</span>
<span style="color:red;">                    &quot; targeted for the proxy, we ignore it&quot;);</span>
<span style="color:red;">                    return;</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">           </span>
<span style="color:red;">               </span>
<span style="color:red;">            if (serverTransaction==null) {</span>
<span style="color:red;">                String method=request.getMethod();       </span>
<span style="color:red;">                // Methods that creates dialogs, so that can </span>
<span style="color:red;">		// generate transactions</span>
<span style="color:red;">                if ( method.equals(Request.INVITE) ||</span>
<span style="color:red;">                     method.equals(Request.SUBSCRIBE)</span>
<span style="color:red;">                ) {</span>
<span style="color:red;">                    try{</span>
<span style="color:red;">                        serverTransaction=</span>
<span style="color:red;">			sipProvider.getNewServerTransaction(request);</span>
<span style="color:red;">                         TransactionsMapping transactionsMapping=</span>
<span style="color:red;">			    (TransactionsMapping) </span>
<span style="color:red;">			    serverTransaction.getDialog().getApplicationData();</span>
<span style="color:red;">	 	         if (transactionsMapping == null) {</span>
<span style="color:red;">	 		     transactionsMapping = </span>
<span style="color:red;">			     new TransactionsMapping(serverTransaction);</span>
<span style="color:red;">		         }</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    catch(TransactionAlreadyExistsException e) {</span>
<span style="color:red;">                         if (ProxyDebug.debug)</span>
<span style="color:red;">                            ProxyDebug.println</span>
<span style="color:red;">			(&quot;Proxy, processRequest(), this request&quot;+</span>
<span style="color:red;">                            &quot; is a retransmission, we drop it!&quot;);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">           }</span>
<span style="color:red;">            </span>
<span style="color:red;">/***************************************************************************/</span>
<span style="color:red;">/****** 2. Preprocess routing information (Section 16.4) *******************/</span>
<span style="color:red;">/***************************************************************************/</span>
<span style="color:red;">            </span>
<span style="color:red;">            /*   The proxy MUST inspect the Request-URI of the request.  If the</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">        ProxyDebug.println(&quot;perase sto 1 To request in proxy, request: &quot;+request.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">RequestValidation requestValidation=new RequestValidation(this);</span>
<span style="color:green;"></span>			<span style="color:green;">if ( !requestValidation.validateRequest</span>
<span style="color:green;"></span>					<span style="color:green;">(sipProvider,request,serverTransaction) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">// An appropriate response has been sent back by the request</span>
<span style="color:green;"></span>				<span style="color:green;">// validation step, so we just return. The request has been</span>
<span style="color:green;"></span>				<span style="color:green;">// processed!</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Proxy, processRequest(), the request has not been&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; validated, so the request is discarded &quot;  +</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; (an error code has normally been&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; sent back)&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Let's check if the ACK is for the proxy: if there is no Route</span>
<span style="color:green;"></span>			<span style="color:green;">// header: it is mandatory for the ACK to be forwarded</span>
<span style="color:green;"></span>			<span style="color:green;">if ( request.getMethod().equals(Request.ACK) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">ListIterator routes = request.getHeaders(RouteHeader.NAME);</span>
<span style="color:green;"></span>				<span style="color:green;">if (routes==null  || !routes.hasNext()) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(), &quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot;the request is an ACK&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; targeted for the proxy, we ignore it&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">String method=request.getMethod();</span><span style="background-color:red;">       </span>
<span style="color:green;"></span>				<span style="color:green;">// Methods that creates dialogs, so that can</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">// generate transactions</span>
<span style="color:green;"></span>				<span style="color:green;">if ( method.equals(Request.INVITE) ||</span>
<span style="color:green;"></span>						<span style="color:green;">method.equals(Request.SUBSCRIBE)</span>
<span style="color:green;"></span>						<span style="color:green;">) {</span>
<span style="color:green;"></span>					<span style="color:green;">try{</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction=</span>
<span style="color:green;"></span>								<span style="color:green;">sipProvider.getNewServerTransaction(request);</span>
<span style="color:green;"></span>						<span style="color:green;">TransactionsMapping transactionsMapping=</span>
<span style="color:green;"></span>								<span style="color:green;">(TransactionsMapping)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>								<span style="color:green;">serverTransaction.getDialog().getApplicationData();</span>
<span style="color:green;"></span>						<span style="color:green;">if (transactionsMapping == null) {</span>
<span style="color:green;"></span>							<span style="color:green;">transactionsMapping =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>									<span style="color:green;">new TransactionsMapping(serverTransaction);</span>
<span style="color:green;"></span>						<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">catch(TransactionAlreadyExistsException e) {</span>
<span style="color:green;"></span>						<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>							<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>							<span style="color:green;">(&quot;Proxy, processRequest(), this request&quot;+</span>
<span style="color:green;"></span>									<span style="color:green;">&quot; is a retransmission, we drop it!&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/***************************************************************************/</span>
<span style="color:green;"></span>			<span style="color:green;">/****** 2. Preprocess routing information (Section 16.4) *******************/</span>
<span style="color:green;"></span>			<span style="color:green;">/***************************************************************************/</span>
<span style="color:green;"></span>	<span style="color:green;">        ProxyDebug.println(&quot;perase sto 2 To request in proxy, request: &quot;+request.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/*   The proxy MUST inspect the Request-URI of the request.  If the</span>
            Request-URI of the request contains a value this proxy previously
            placed into a Record-Route header field (see Section 16.6 item 4),
            the proxy MUST replace the Request-URI in the request with the last
<span style="color:teal;">@ Proxy.java:302 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Proxy implements SipListener  {</span>
            field value.  If it indicates this proxy, the proxy removes it
            from the Route header field (this route node has been
            reached).
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">          </span><span style="color:red;font-weight:bold;"> */</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">ListIterator routes = request.getHeaders(RouteHeader.NAME);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">if (routes!=null) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">if ( routes.hasNext() ) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">RouteHeader  routeHeader = (RouteHeader) routes.next();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">Address routeAddress=routeHeader.getAddress();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">SipURI routeSipURI=(SipURI)routeAddress.getURI();</span>
<span style="color:red;">                    </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">String host = routeSipURI.getHost();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">int port = routeSipURI.getPort();</span>
<span style="color:red;">                    </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">if (sipStack.getIPAddress().equals(host) ) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">Iterator lps=sipStack.getListeningPoints();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">while(lps!=null &amp;&amp; lps.hasNext()) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">ListeningPoint lp=(ListeningPoint)lps.next();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">if (lp.getPort()==port) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                </span><span style="color:red;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                    </span><span style="color:red;font-weight:bold;">ProxyDebug.println</span>
<span style="color:red;font-weight:bold;">				</span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                    </span><span style="color:red;font-weight:bold;">&quot; we remove the first route form &quot; +</span>
<span style="color:red;font-weight:bold;">				</span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">&quot; the RouteHeader;&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                    </span><span style="color:red;font-weight:bold;">&quot; it matches the proxy&quot;);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                </span><span style="color:red;font-weight:bold;">routes.remove();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                                </span><span style="color:red;font-weight:bold;">break;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">/*</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> */</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">ListIterator routes = request.getHeaders(RouteHeader.NAME);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">if (routes!=null) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">if ( routes.hasNext() ) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">RouteHeader  routeHeader = (RouteHeader) routes.next();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">Address routeAddress=routeHeader.getAddress();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">SipURI routeSipURI=(SipURI)routeAddress.getURI();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">String host = routeSipURI.getHost();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">int port = routeSipURI.getPort();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">if (sipStack.getIPAddress().equals(host) ) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">Iterator lps=sipStack.getListeningPoints();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">while(lps!=null &amp;&amp; lps.hasNext()) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">ListeningPoint lp=(ListeningPoint)lps.next();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">if (lp.getPort()==port) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">								</span><span style="color:green;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">									</span><span style="color:green;font-weight:bold;">ProxyDebug.println</span>
<span style="color:green;font-weight:bold;">				</span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">											</span><span style="color:green;font-weight:bold;">&quot; we remove the first route form &quot; +</span>
<span style="color:green;font-weight:bold;">				</span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">&quot; the RouteHeader;&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">											</span><span style="color:green;font-weight:bold;">&quot; it matches the proxy&quot;);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">								</span><span style="color:green;font-weight:bold;">routes.remove();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">								</span><span style="color:green;font-weight:bold;">break;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/*</span>
            If the Request-URI contains a maddr parameter, the proxy MUST check
            to see if its value is in the set of addresses or domains the proxy
            is configured to be responsible for.  If the Request-URI has a maddr
<span style="color:teal;">@ Proxy.java:342 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Proxy implements SipListener  {</span>
            default) in the Request-URI, the proxy MUST strip the maddr and any
            non-default port or transport parameter and continue processing as if
            those values had not been present in the request.
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;"> */</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">URI requestURI=request.getRequestURI();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">if (requestURI.isSipURI()) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">if (requestSipURI.getMAddrParam()!=null ) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">// The domain the proxy is configured to be responsible for is defined</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">// by stack_domain parameter in the configuration file:</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">if (configuration.hasDomain(requestSipURI.getMAddrParam())) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">&quot; The maddr contains a domain we are responsible for,&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">&quot; we remove the mAddr parameter from the original&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">&quot; request&quot;);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">// We have to strip the madr parameter:</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">requestSipURI.removeParameter(&quot;maddr&quot;);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">// We have to strip the port parameter:</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">if (requestSipURI.getPort()!=5060 &amp;&amp; requestSipURI.getPort()!=-1) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                            </span><span style="color:red;font-weight:bold;">requestSipURI.setPort(5060);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">// We have to strip the transport parameter:</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">requestSipURI.removeParameter(&quot;transport&quot;);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">else {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">// The Maddr parameter is not a domain we have to take</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">// care of, we pass this check...</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">else {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">// No Maddr parameter, we pass this check...</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">else {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">// No SipURI, so no Maddr parameter, we pass this check...</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;">            </span>
<span style="color:red;">          </span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">/******************************************************************************/</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">/************* 3. Determine target(s) for the request (Section 16.5) **********/</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">/*****************************************************************************/            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">/*</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> */</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">URI requestURI=request.getRequestURI();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">if (requestURI.isSipURI()) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">if (requestSipURI.getMAddrParam()!=null ) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">// The domain the proxy is configured to be responsible for is defined</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">// by stack_domain parameter in the configuration file:</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">if (configuration.hasDomain(requestSipURI.getMAddrParam())) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">									</span><span style="color:green;font-weight:bold;">&quot; The maddr contains a domain we are responsible for,&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">									</span><span style="color:green;font-weight:bold;">&quot; we remove the mAddr parameter from the original&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">									</span><span style="color:green;font-weight:bold;">&quot; request&quot;);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">// We have to strip the madr parameter:</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">requestSipURI.removeParameter(&quot;maddr&quot;);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">// We have to strip the port parameter:</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">if (requestSipURI.getPort()!=5060 &amp;&amp; requestSipURI.getPort()!=-1) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">requestSipURI.setPort(5060);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">// We have to strip the transport parameter:</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">requestSipURI.removeParameter(&quot;transport&quot;);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">else {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">// The Maddr parameter is not a domain we have to take</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">// care of, we pass this check...</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">else {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">// No Maddr parameter, we pass this check...</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">else {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">// No SipURI, so no Maddr parameter, we pass this check...</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/******************************************************************************/</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/************* 3. Determine target(s) for the request (Section 16.5) **********/</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/*****************************************************************************/            </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/*</span>
            The set of targets will either be predetermined by the contents of the 
            request or will be obtained from an abstract location service.  Each 
            target in the set is represented as a URI.
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;"> */</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">Vector targetURIList=new Vector();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">URI targetURI;</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">           </span><span style="color:red;font-weight:bold;">/* If the Request-URI of the request contains an maddr parameter, the</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">           </span><span style="color:red;font-weight:bold;"> * Request-URI MUST be placed into the target set as the only target</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">           </span><span style="color:red;font-weight:bold;"> * URI, and the proxy MUST proceed to Section 16.6.</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">           </span><span style="color:red;font-weight:bold;"> */    </span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">if (requestURI.isSipURI()) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">if (requestSipURI.getMAddrParam()!=null ) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">targetURI=requestURI;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">targetURIList.addElement(targetURI);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">&quot; the only target is the Request-URI (mAddr parameter)&quot;);</span>
<span style="color:red;">                    </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">// 4. Forward the request statefully:</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:red;font-weight:bold;">						</span><span style="color:red;font-weight:bold;text-decoration:blink;">     </span><span style="color:red;font-weight:bold;">request,serverTransaction,true);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">return;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;">            </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">/*</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> */</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">Vector targetURIList=new Vector();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">URI targetURI;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/* If the Request-URI of the request contains an maddr parameter, the</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> * Request-URI MUST be placed into the target set as the only target</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> * URI, and the proxy MUST proceed to Section 16.6.</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;"> */    </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">if (requestURI.isSipURI()) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">if (requestSipURI.getMAddrParam()!=null ) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">targetURI=requestURI;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">targetURIList.addElement(targetURI);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">if (ProxyDebug.debug)</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">								</span><span style="color:green;font-weight:bold;">&quot; the only target is the Request-URI (mAddr parameter)&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">// 4. Forward the request statefully:</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:green;font-weight:bold;">						</span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">request,serverTransaction,true);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">return;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">/*</span>
              If the domain of the Request-URI indicates a domain this element is
              not responsible for, the Request-URI MUST be placed into the target
              set as the only target, and the element MUST proceed to the task of
              Request Forwarding (Section 16.6).
<span style="color:red;">             */</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (requestURI.isSipURI()) {</span>
<span style="color:red;">                SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:red;">                if ( !configuration.hasDomain(requestSipURI.getHost() ) ) {</span>
<span style="color:red;">                    if (ProxyDebug.debug)</span>
<span style="color:red;">                        ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;">                        &quot; we are not responsible for the domain: Let's check if we have&quot;+</span>
<span style="color:red;">                        &quot; a registration for this domain from another proxy&quot;);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    // We have to check if another proxy did not registered</span>
<span style="color:red;">                    // to us, in this case we have to use the contacts provided</span>
<span style="color:red;">                    // by the registered proxy to create the targets:</span>
<span style="color:red;">                    if (registrar.hasDomainRegistered(request)) {</span>
<span style="color:red;">                        targetURIList=registrar.getDomainContactsURI(request);</span>
<span style="color:red;">                        if (targetURIList!=null &amp;&amp; !targetURIList.isEmpty()) {</span>
<span style="color:red;">                            if (ProxyDebug.debug) {</span>
<span style="color:red;">                                ProxyDebug.println(&quot;Proxy, processRequest(), we have&quot;+</span>
<span style="color:red;">                                &quot; a registration for this domain from another proxy&quot;);</span>
<span style="color:red;">                            }</span>
<span style="color:red;">                            // 4. Forward the request statefully:</span>
<span style="color:red;">                            requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:red;">                            request,serverTransaction,true);</span>
<span style="color:red;">                            return;</span>
<span style="color:red;">                             </span>
<span style="color:red;">                        }</span>
<span style="color:red;">                        else {</span>
<span style="color:red;">                            targetURIList=new Vector();</span>
<span style="color:red;">                            ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;">                            &quot; we are not responsible for the domain: the only target&quot;+</span>
<span style="color:red;">                            &quot; URI is given by the request-URI&quot;);</span>
<span style="color:red;">                            targetURI=requestURI;</span>
<span style="color:red;">                            targetURIList.addElement(targetURI);</span>
<span style="color:red;">                        }</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    else {</span>
<span style="color:red;">                        ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;">                                &quot; we are not responsible for the domain: the only target&quot;+</span>
<span style="color:red;">                                &quot; URI is given by the request-URI&quot;);</span>
<span style="color:red;">                        targetURI=requestURI;</span>
<span style="color:red;">                        targetURIList.addElement(targetURI);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    // 4. Forward the request statelessly:</span>
<span style="color:red;">                    requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:red;">                    request,serverTransaction,false);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    return;</span>
<span style="color:red;">                }</span>
<span style="color:red;">                else {</span>
<span style="color:red;">                        ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;">                                &quot; we are responsible for the domain... Let's find the contact...&quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">               </span>
<span style="color:red;">              // we use a SIP registrar:</span>
<span style="color:red;">             if ( request.getMethod().equals(Request.REGISTER) ) {</span>
<span style="color:red;">		if (ProxyDebug.debug) </span>
<span style="color:red;">	        	ProxyDebug.println(&quot;Incoming request Register&quot;);</span>
<span style="color:red;">                // we call the RegisterProcessing:</span>
<span style="color:red;">                registrar.processRegister</span>
<span style="color:red;">			(request,sipProvider,serverTransaction);               </span>
<span style="color:red;">		//Henrik: let the presenceserver do some processing too</span>
<span style="color:red;">		if ( isPresenceServer()) {</span>
<span style="color:red;">		    presenceServer.processRegisterRequest</span>
<span style="color:red;">			(sipProvider, request, serverTransaction);</span>
<span style="color:red;">		}</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>

<span style="color:red;">		return;</span>
<span style="color:red;">             }</span>
<span style="color:red;">        </span>
<span style="color:green;"></span>			<span style="color:green;">if (requestURI.isSipURI()) {</span>
<span style="color:green;"></span>				<span style="color:green;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:green;"></span>				<span style="color:green;">if ( !configuration.hasDomain(requestSipURI.getHost() ) ) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; we are not responsible for the domain: Let's check if we have&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; a registration for this domain from another proxy&quot;);</span>

<span style="color:green;"></span>					<span style="color:green;">// We have to check if another proxy did not registered</span>
<span style="color:green;"></span>					<span style="color:green;">// to us, in this case we have to use the contacts provided</span>
<span style="color:green;"></span>					<span style="color:green;">// by the registered proxy to create the targets:</span>
<span style="color:green;"></span>					<span style="color:green;">if (registrar.hasDomainRegistered(request)) {</span>
<span style="color:green;"></span>						<span style="color:green;">targetURIList=registrar.getDomainContactsURI(request);</span>
<span style="color:green;"></span>						<span style="color:green;">if (targetURIList!=null &amp;&amp; !targetURIList.isEmpty()) {</span>
<span style="color:green;"></span>							<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>								<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(), we have&quot;+</span>
<span style="color:green;"></span>										<span style="color:green;">&quot; a registration for this domain from another proxy&quot;);</span>
<span style="color:green;"></span>							<span style="color:green;">}</span>
<span style="color:green;"></span>							<span style="color:green;">// 4. Forward the request statefully:</span>
<span style="color:green;"></span>							<span style="color:green;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:green;"></span>									<span style="color:green;">request,serverTransaction,true);</span>
<span style="color:green;"></span>							<span style="color:green;">return;</span>

<span style="color:red;">	     /* If we receive a subscription targeted to a user that</span>
<span style="color:red;">	      * is publishing its state here, send to presence server</span>
<span style="color:red;">	      */</span>
<span style="color:red;">	     if ( isPresenceServer() &amp;&amp; </span>
<span style="color:red;">		(request.getMethod().equals(Request.SUBSCRIBE))) {</span>
<span style="color:red;">		 ProxyDebug.println(&quot;Incoming request Subscribe&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		 if (presenceServer.isStateAgent(request)) {</span>
<span style="color:red;">		     Request clonedRequest=(Request)request.clone();</span>
<span style="color:red;">		     presenceServer.processSubscribeRequest(sipProvider,</span>
<span style="color:red;">							    clonedRequest,</span>
<span style="color:red;">							    serverTransaction);</span>
<span style="color:red;">		 } else {</span>
<span style="color:red;">		     // Do we know this guy?</span>
<span style="color:red;">		 	</span>
<span style="color:red;">		 	 </span>
<span style="color:red;">		     targetURIList = registrar.getContactsURI(request);</span>
<span style="color:red;">		     if (targetURIList == null ) { </span>
<span style="color:red;">			// If not respond that we dont know him.</span>
<span style="color:red;">			 ProxyDebug.println</span>
<span style="color:red;">			(&quot;Proxy: received a Subscribe request to &quot; +</span>
<span style="color:red;">			 &quot; a user in our domain that was not found, &quot; +</span>
<span style="color:red;">			 &quot; responded 404&quot;);</span>
<span style="color:red;">			 Response response=</span>
<span style="color:red;">				messageFactory.createResponse</span>
<span style="color:red;">				(Response.NOT_FOUND,request);</span>
<span style="color:red;">			 if (serverTransaction!=null)</span>
<span style="color:red;">			     serverTransaction.sendResponse(response);</span>
<span style="color:red;">			 else </span>
<span style="color:red;">			     sipProvider.sendResponse(response);</span>
<span style="color:red;">			 return;</span>
<span style="color:red;">		     } else  { </span>
<span style="color:red;">			 ProxyDebug.println</span>
<span style="color:red;">				(&quot;Trying to forward subscribe to &quot; </span>
<span style="color:red;">				+ targetURIList.toString() + </span>
<span style="color:red;">			        &quot;\n&quot; + request.toString());</span>
<span style="color:red;">			 requestForwarding.forwardRequest</span>
<span style="color:red;">				(targetURIList,sipProvider, </span>
<span style="color:red;">				request,serverTransaction,false);</span>
<span style="color:red;">		     </span>
<span style="color:red;">		     }</span>
<span style="color:red;">		 }</span>
<span style="color:red;">		 return;</span>
<span style="color:red;">	     }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">	     /** Received a Notify. </span>
<span style="color:red;">	      *  TOADD: Check if it match active VirtualSubscriptions and update it</span>
<span style="color:red;">	      **/</span>
<span style="color:red;">	     if ( isPresenceServer() &amp;&amp; (request.getMethod().equals</span>
<span style="color:red;">			(Request.NOTIFY) )) { </span>
<span style="color:red;">		 System.out.println(&quot;Incoming request Notify&quot;);</span>
<span style="color:red;">       </span>
<span style="color:red;">		 Response response=messageFactory.createResponse(481,request);</span>
<span style="color:red;">		 response.setReasonPhrase(&quot;Subscription does not exist&quot;);</span>
<span style="color:red;">		 if (serverTransaction!=null)</span>
<span style="color:red;">		     serverTransaction.sendResponse(response);</span>
<span style="color:red;">		 else </span>
<span style="color:red;">		     sipProvider.sendResponse(response);</span>
<span style="color:red;">		 ProxyDebug.println (&quot;Proxy: received a Notify request. Probably wrong, responded 481&quot;);</span>
<span style="color:red;">		 return;</span>
<span style="color:red;">	     }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">	    </span>
<span style="color:red;">	    if ( isPresenceServer() &amp;&amp; ( request.getMethod().equalsIgnoreCase(&quot;PUBLISH&quot;))) {</span>
<span style="color:red;">		</span>
<span style="color:red;">		 System.out.println(&quot;Incoming request Publish&quot;);</span>
<span style="color:red;">		 </span>
<span style="color:red;">		 ProxyDebug.println(&quot;Proxy: received a Publish request.&quot;);</span>
<span style="color:red;">		 Request clonedRequest=(Request)request.clone();</span>
<span style="color:red;">		 </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		 if (presenceServer.isStateAgent(clonedRequest)) {</span>
<span style="color:red;">		     ProxyDebug.println(&quot;PresenceServer.isStateAgent&quot;);</span>
<span style="color:red;">		 } else {</span>
<span style="color:red;">		     ProxyDebug.println(&quot;PresenceServer is NOT StateAgent&quot;);</span>
<span style="color:red;">		 }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		if (presenceServer.isStateAgent(clonedRequest)) {</span>
<span style="color:red;">		    presenceServer.processPublishRequest(sipProvider,</span>
<span style="color:red;">							 clonedRequest,</span>
<span style="color:red;">							 serverTransaction);</span>
<span style="color:red;">		} else {</span>
<span style="color:red;">		    Response response=messageFactory.createResponse(Response.NOT_FOUND,request);</span>
<span style="color:red;">		    if (serverTransaction!=null)</span>
<span style="color:red;">			serverTransaction.sendResponse(response);</span>
<span style="color:red;">		    else </span>
<span style="color:red;">			sipProvider.sendResponse(response);</span>
<span style="color:red;">		}</span>
<span style="color:red;">		return;</span>
<span style="color:red;">	    }</span>
<span style="color:green;"></span>						<span style="color:green;">}</span>
<span style="color:green;"></span>						<span style="color:green;">else {</span>
<span style="color:green;"></span>							<span style="color:green;">targetURIList=new Vector();</span>
<span style="color:green;"></span>							<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;"></span>									<span style="color:green;">&quot; we are not responsible for the domain: the only target&quot;+</span>
<span style="color:green;"></span>									<span style="color:green;">&quot; URI is given by the request-URI&quot;);</span>
<span style="color:green;"></span>							<span style="color:green;">targetURI=requestURI;</span>
<span style="color:green;"></span>							<span style="color:green;">targetURIList.addElement(targetURI);</span>
<span style="color:green;"></span>						<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">else {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; we are not responsible for the domain: the only target&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; URI is given by the request-URI&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">targetURI=requestURI;</span>
<span style="color:green;"></span>						<span style="color:green;">targetURIList.addElement(targetURI);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>

<span style="color:red;">		</span>
<span style="color:green;"></span>					<span style="color:green;">// 4. Forward the request statelessly:</span>
<span style="color:green;"></span>					<span style="color:green;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">request,serverTransaction,false);</span>

<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">else {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; we are responsible for the domain... Let's find the contact...&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
<span style="color:green;"></span>			<span style="color:green;"> * We insert the listener for the FORWARD and UNFORWARD requests here 22-1-2017</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>

<span style="color:red;">	</span>
<span style="color:red;">	     // Forward to next hop but dont reply OK right away for the</span>
<span style="color:red;">	  // BYE. Bye is end-to-end not hop by hop!</span>
<span style="color:red;">	  if (request.getMethod().equals(Request.BYE) ) {</span>
<span style="color:red;">	     if (serverTransaction == null) {</span>
<span style="color:red;">	        if (ProxyDebug.debug)</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">			(&quot;Proxy, null server transactin for BYE&quot;);</span>
<span style="color:red;">		  return;</span>
<span style="color:red;">		}</span>
<span style="color:red;">		Dialog d = serverTransaction.getDialog();</span>
<span style="color:red;">		TransactionsMapping transactionsMapping = </span>
<span style="color:red;">			(TransactionsMapping) d.getApplicationData();</span>
<span style="color:red;">		Dialog peerDialog = (Dialog) transactionsMapping.getPeerDialog</span>
<span style="color:red;">			(serverTransaction);</span>
<span style="color:red;">		Request clonedRequest = (Request) request.clone();</span>
<span style="color:red;">		FromHeader from = (FromHeader) </span>
<span style="color:red;">			clonedRequest.getHeader(FromHeader.NAME);</span>
<span style="color:red;">		from.removeParameter(&quot;tag&quot;);</span>
<span style="color:red;">		ToHeader to = (ToHeader)</span>
<span style="color:red;">			clonedRequest.getHeader(ToHeader.NAME);</span>
<span style="color:red;">		to.removeParameter(&quot;tag&quot;);</span>
<span style="color:red;">		ViaHeader via = this.getStackViaHeader();</span>
<span style="color:red;">		clonedRequest.addHeader(via);</span>
<span style="color:red;">	      if ( peerDialog.getState() != null ) {</span>
<span style="color:red;">		  ClientTransaction newct = </span>
<span style="color:red;">				sipProvider.getNewClientTransaction</span>
<span style="color:red;">				(clonedRequest);</span>
<span style="color:red;">		  transactionsMapping.addMapping(serverTransaction,newct);</span>
<span style="color:red;">		  peerDialog.sendRequest(newct);</span>
<span style="color:red;">	          return;</span>
<span style="color:red;">	       } else {</span>
<span style="color:red;">		  // the peer dialog is not yet established so bail out.</span>
<span style="color:red;">		  // this is a client error - client is sending BYE</span>
<span style="color:red;">		  // before dialog establishment.</span>
<span style="color:red;">                  if (ProxyDebug.debug) </span>
<span style="color:red;">                      ProxyDebug.println</span>
<span style="color:red;">			(&quot;Proxy, bad dialog state - BYE dropped&quot;);</span>
<span style="color:red;">		  return;</span>
<span style="color:red;">	      }</span>
<span style="color:red;">	}</span>
<span style="color:green;"></span>	<span style="color:green;">        ProxyDebug.println(&quot;perase to 3  request: &quot;+request.toString());</span>
<span style="color:green;"></span>	<span style="color:green;">        //ProxyDebug.println(&quot;method for request FORWARD and UNFORWARD &quot;+request.getMethod().toString());</span>
<span style="color:green;"></span>			<span style="color:green;">if (request.getMethod().equals(&quot;FORWARD&quot;) || request.getMethod().equals(&quot;UNFORWARD&quot;)){</span>
<span style="color:green;"></span>		<span style="color:green;">        ProxyDebug.println(&quot;UPDATE request in proxy, request: &quot;+request.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        //send the response to the user</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        registrar.processUserForward(request,sipProvider,serverTransaction);</span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
			
<span style="color:red;">		</span>
<span style="color:red;">       </span>
<span style="color:red;">	</span>
<span style="color:red;">            /*</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
<span style="color:green;"></span>			<span style="color:green;"> * We insert the listener for the BLOCK and UNBLOCK requests here 25-1-2017</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">        //ProxyDebug.println(&quot;method for request BLOCK or UNBLOCK &quot;+request.getMethod().toString());</span>
<span style="color:green;"></span>			<span style="color:green;">if (request.getMethod().equals(&quot;BLOCK&quot;) || request.getMethod().equals(&quot;UNBLOCK&quot;) )</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>		<span style="color:green;">        ProxyDebug.println(&quot;BLOCK request in proxy, request: &quot;+request.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        //send the response to the user</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        registrar.processUserBlocking(request,sipProvider,serverTransaction);</span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
<span style="color:green;"></span>			<span style="color:green;"> * We insert the listener for the INFO request in order to give the user his</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>			<span style="color:green;"> * Blocked Users List and his Forward callee if need be by the GUI</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>			<span style="color:green;">if (request.getMethod().equals(&quot;INFO&quot;) )</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>		<span style="color:green;">        ProxyDebug.println(&quot;INFO request in proxy, request: &quot;+request.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        //send the response to the user</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        registrar.processUserInfo(request,sipProvider,serverTransaction, headerFactory);</span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>		<span style="color:green;">        return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/**</span>
<span style="color:green;"></span>			<span style="color:green;"> * If the request is options and the content says duration 29-1-2017</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (request.getMethod().equals(&quot;OPTIONS&quot;)){</span>
<span style="color:green;"></span>				<span style="color:green;">String content = new String( request.getRawContent());</span>
<span style="color:green;"></span>				<span style="color:green;">if (content.contains(&quot;Duration&quot;)){</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;OPTION request in proxy , request: &quot;+request.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">			        </span>
<span style="color:green;"></span>			<span style="color:green;">        //send the response to the user</span>
<span style="color:green;"></span><span style="background-color:red;">			        </span>
<span style="color:green;"></span>			<span style="color:green;">        registrar.processUserBilling(request,sipProvider,serverTransaction, headerFactory);</span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">	        </span>
<span style="color:green;"></span><span style="background-color:red;">			        </span>
<span style="color:green;"></span>			<span style="color:green;">        return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">		        </span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// we use a SIP registrar:</span>
<span style="color:green;"></span>			<span style="color:green;">if ( request.getMethod().equals(Request.REGISTER) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Incoming request Register&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">// we call the RegisterProcessing:</span>
<span style="color:green;"></span>				<span style="color:green;">registrar.processRegister</span>
<span style="color:green;"></span>				<span style="color:green;">(request,sipProvider,serverTransaction);</span><span style="background-color:red;">               </span>
<span style="color:green;"></span>				<span style="color:green;">//Henrik: let the presenceserver do some processing too</span>
<span style="color:green;"></span>				<span style="color:green;">if ( isPresenceServer()) {</span>
<span style="color:green;"></span>					<span style="color:green;">presenceServer.processRegisterRequest</span>
<span style="color:green;"></span>					<span style="color:green;">(sipProvider, request, serverTransaction);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/* If we receive a subscription targeted to a user that</span>
<span style="color:green;"></span>			<span style="color:green;"> * is publishing its state here, send to presence server</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>			<span style="color:green;">if ( isPresenceServer() &amp;&amp;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">(request.getMethod().equals(Request.SUBSCRIBE))) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Incoming request Subscribe&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (presenceServer.isStateAgent(request)) {</span>
<span style="color:green;"></span>					<span style="color:green;">Request clonedRequest=(Request)request.clone();</span>
<span style="color:green;"></span>					<span style="color:green;">presenceServer.processSubscribeRequest(sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">clonedRequest,</span>
<span style="color:green;"></span>							<span style="color:green;">serverTransaction);</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">// Do we know this guy?</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">targetURIList = registrar.getContactsURI(request);</span>
<span style="color:green;"></span>					<span style="color:green;">if (targetURIList == null ) {</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">// If not respond that we dont know him.</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy: received a Subscribe request to &quot; +</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; a user in our domain that was not found, &quot; +</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; responded 404&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">Response response=</span>
<span style="color:green;"></span>								<span style="color:green;">messageFactory.createResponse</span>
<span style="color:green;"></span>								<span style="color:green;">(Response.NOT_FOUND,request);</span>
<span style="color:green;"></span>						<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>							<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>						<span style="color:green;">else</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>							<span style="color:green;">sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>						<span style="color:green;">return;</span>
<span style="color:green;"></span>					<span style="color:green;">} else  {</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Trying to forward subscribe to &quot;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>								<span style="color:green;">+ targetURIList.toString() +</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>								<span style="color:green;">&quot;\n&quot; + request.toString());</span>
<span style="color:green;"></span>						<span style="color:green;">requestForwarding.forwardRequest</span>
<span style="color:green;"></span>						<span style="color:green;">(targetURIList,sipProvider,</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>								<span style="color:green;">request,serverTransaction,false);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/** Received a Notify.</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>			<span style="color:green;"> *  TOADD: Check if it match active VirtualSubscriptions and update it</span>
<span style="color:green;"></span>			<span style="color:green;"> **/</span>
<span style="color:green;"></span>			<span style="color:green;">if ( isPresenceServer() &amp;&amp; (request.getMethod().equals</span>
<span style="color:green;"></span>					<span style="color:green;">(Request.NOTIFY) )) {</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;Incoming request Notify&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse(481,request);</span>
<span style="color:green;"></span>				<span style="color:green;">response.setReasonPhrase(&quot;Subscription does not exist&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println (&quot;Proxy: received a Notify request. Probably wrong, responded 481&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( isPresenceServer() &amp;&amp; ( request.getMethod().equalsIgnoreCase(&quot;PUBLISH&quot;))) {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;Incoming request Publish&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Proxy: received a Publish request.&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">Request clonedRequest=(Request)request.clone();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (presenceServer.isStateAgent(clonedRequest)) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;PresenceServer.isStateAgent&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;PresenceServer is NOT StateAgent&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (presenceServer.isStateAgent(clonedRequest)) {</span>
<span style="color:green;"></span>					<span style="color:green;">presenceServer.processPublishRequest(sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">clonedRequest,</span>
<span style="color:green;"></span>							<span style="color:green;">serverTransaction);</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse(Response.NOT_FOUND,request);</span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Forward to next hop but dont reply OK right away for the</span>
<span style="color:green;"></span>			<span style="color:green;">// BYE. Bye is end-to-end not hop by hop!</span>
<span style="color:green;"></span>			<span style="color:green;">if (request.getMethod().equals(Request.BYE) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction == null) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy, null server transactin for BYE&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Dialog d = serverTransaction.getDialog();</span>
<span style="color:green;"></span>				<span style="color:green;">TransactionsMapping transactionsMapping =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">(TransactionsMapping) d.getApplicationData();</span>
<span style="color:green;"></span>				<span style="color:green;">Dialog peerDialog = (Dialog) transactionsMapping.getPeerDialog</span>
<span style="color:green;"></span>						<span style="color:green;">(serverTransaction);</span>
<span style="color:green;"></span>				<span style="color:green;">Request clonedRequest = (Request) request.clone();</span>
<span style="color:green;"></span>				<span style="color:green;">FromHeader from = (FromHeader)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">clonedRequest.getHeader(FromHeader.NAME);</span>
<span style="color:green;"></span>				<span style="color:green;">from.removeParameter(&quot;tag&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ToHeader to = (ToHeader)</span>
<span style="color:green;"></span>						<span style="color:green;">clonedRequest.getHeader(ToHeader.NAME);</span>
<span style="color:green;"></span>				<span style="color:green;">to.removeParameter(&quot;tag&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ViaHeader via = this.getStackViaHeader();</span>
<span style="color:green;"></span>				<span style="color:green;">clonedRequest.addHeader(via);</span>
<span style="color:green;"></span>				<span style="color:green;">if ( peerDialog.getState() != null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">ClientTransaction newct =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>							<span style="color:green;">sipProvider.getNewClientTransaction</span>
<span style="color:green;"></span>							<span style="color:green;">(clonedRequest);</span>
<span style="color:green;"></span>					<span style="color:green;">transactionsMapping.addMapping(serverTransaction,newct);</span>
<span style="color:green;"></span>					<span style="color:green;">peerDialog.sendRequest(newct);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">// the peer dialog is not yet established so bail out.</span>
<span style="color:green;"></span>					<span style="color:green;">// this is a client error - client is sending BYE</span>
<span style="color:green;"></span>					<span style="color:green;">// before dialog establishment.</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy, bad dialog state - BYE dropped&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
              If the target set for the request has not been predetermined as
              described above, this implies that the element is responsible for the
              domain in the Request-URI, and the element MAY use whatever mechanism
<span style="color:teal;">@ Proxy.java:713 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Proxy implements SipListener  {</span>
              When accessing the location service constructed by a registrar, the 
              Request-URI MUST first be canonicalized as described in Section 10.3
              before being used as an index.   
<span style="color:red;">             */</span>
<span style="color:red;">             if (requestURI.isSipURI()) {</span>
<span style="color:red;">                SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:red;">                Iterator iterator=requestSipURI.getParameterNames();</span>
<span style="color:red;">                if (ProxyDebug.debug)</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Proxy, processRequest(), we canonicalized&quot;+</span>
<span style="color:red;">                    &quot; the request-URI&quot;);</span>
<span style="color:red;">                while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:red;">                    String name=(String)iterator.next();</span>
<span style="color:red;">                    requestSipURI.removeParameter(name);</span>
<span style="color:red;">                }</span>
<span style="color:red;">             }</span>
<span style="color:red;">      </span>
<span style="color:red;">           </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            if ( registrar.hasRegistration(request)  ) {</span>
<span style="color:red;">               </span>
<span style="color:red;">                targetURIList=registrar.getContactsURI(request);</span>
<span style="color:red;">                </span>
<span style="color:red;">                // We fork only INVITE</span>
<span style="color:red;">                if (targetURIList!=null &amp;&amp; targetURIList.size()&gt;1 </span>
<span style="color:red;">                		&amp;&amp; !request.getMethod().equals(&quot;INVITE&quot;) ) {</span>
<span style="color:red;">                	if (ProxyDebug.debug)</span>
<span style="color:red;">                		ProxyDebug.println</span>
<span style="color:red;">                		(&quot;Proxy, processRequest(), the request &quot;+</span>
<span style="color:red;">                				&quot; to fork is not an INVITE, so we will process&quot;+</span>
<span style="color:red;">                		&quot; it with the first target as the only target.&quot;);</span>
<span style="color:red;">                	targetURI= (URI)targetURIList.firstElement();</span>
<span style="color:red;">                	targetURIList=new Vector();</span>
<span style="color:red;">                	targetURIList.addElement(targetURI);</span>
<span style="color:red;">                	// 4. Forward the request statefully to the target:</span>
<span style="color:red;">                	requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:red;">                			request,serverTransaction,true);</span>
<span style="color:red;">                	return;</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                if (targetURIList!=null &amp;&amp; !targetURIList.isEmpty()) {</span>
<span style="color:red;">                	if (ProxyDebug.debug)</span>
<span style="color:red;">                		ProxyDebug.println</span>
<span style="color:red;">                		(&quot;Proxy, processRequest(), the target set&quot;+</span>
<span style="color:red;">                				&quot; is the set of the contacts URI from the &quot; +</span>
<span style="color:red;">                		&quot; location service&quot;);</span>
<span style="color:red;">                /*	</span>
<span style="color:red;">                	//  ECE355 Changes - Aug. 2005.                </span>
<span style="color:red;">                	// Call registry  service, get response (uri - wsdl).</span>
<span style="color:red;">                	// if response is not null then </span>
<span style="color:red;">                	//    do our staff </span>
<span style="color:red;">                	//    send to caller decline message by building a decline msg</span>
<span style="color:red;">                	//    and attach wsdl uri  in the message body  </span>
<span style="color:red;">                	// else .. continue the logic below ...</span>
<span style="color:red;">                	</span>
<span style="color:red;">                	</span>
<span style="color:red;">                	// Lets assume that wsdl_string contains the message with all the</span>
<span style="color:red;">                	// service names and uri's for each service in the required format</span>
<span style="color:red;">                	</span>
<span style="color:red;">                    // Query for web services for the receiver of INVITE</span>
<span style="color:red;">                	//  Use WebServices class to get services for org</span>
<span style="color:red;">            		</span>
<span style="color:red;">                	String messageBody = &quot;&quot; ;</span>
<span style="color:red;">                	WebServicesQuery wsq = null ;</span>
<span style="color:red;">            		wsq  = WebServicesQuery.getInstance();</span>
<span style="color:red;">            		</span>
<span style="color:red;">            		//  Get services info for receiver</span>
<span style="color:red;">            		//  A receiver is represented as an organization in the Service Registry</span>
<span style="color:red;">             		</span>
<span style="color:red;">            	    To to = (To)request.getHeader(ToHeader.NAME);</span>
<span style="color:red;">            		String toAddress = to.getUserAtHostPort();</span>
<span style="color:red;">            		</span>
<span style="color:red;">            		// Remove all characters after the @ sign from To address</span>
<span style="color:red;">            		StringBuffer sb = new StringBuffer(toAddress);</span>
<span style="color:red;">            		int endsAt = sb.indexOf(&quot;@&quot;);</span>
<span style="color:red;">            		String orgNamePattern = sb.substring(0, endsAt);</span>
<span style="color:red;">            	</span>
<span style="color:red;">        		    </span>
<span style="color:red;">            		Collection serviceInfoColl = wsq.findServicesForOrg(orgNamePattern);</span>
<span style="color:red;">            	   </span>
<span style="color:red;">            		// If services are found for this receiver (Org), build DECLINE message and</span>
<span style="color:red;">            		// send to client</span>
<span style="color:red;">            		if (serviceInfoColl != null) {</span>
<span style="color:red;">            		if (serviceInfoColl.size()!= 0 ){</span>
<span style="color:red;">            			System.out.println(&quot;Found &quot; + serviceInfoColl.size() + &quot; services for o rg &quot; + orgNamePattern) ;</span>
<span style="color:red;">            			// Build message body for DECLINE message with Service Info</span>
<span style="color:red;">            			messageBody = serviceInfoColl.size()+ &quot; -- &quot; ;</span>
<span style="color:red;">                        </span>
<span style="color:red;">        				Iterator servIter = serviceInfoColl.iterator();</span>
<span style="color:red;">            			while (servIter.hasNext()) {</span>
<span style="color:red;">            				ServiceInfo servInfo = (ServiceInfo)servIter.next();</span>
<span style="color:red;">            				messageBody =  messageBody  + servInfo.getDescription()+ &quot; &quot; + servInfo.getWsdluri() + &quot; &quot; + servInfo.getEndPoint()+ &quot; -- &quot;;</span>
<span style="color:red;">            		        </span>
<span style="color:red;">            				</span>
<span style="color:red;">            				System.out.println(&quot;Name: &quot; + servInfo.getName()) ;</span>
<span style="color:red;">            				System.out.println(&quot;Providing Organization: &quot; + servInfo.getProvidingOrganization()) ;</span>
<span style="color:red;">            				System.out.println(&quot;Description: &quot; + servInfo.getDescription()) ;</span>
<span style="color:red;">            				System.out.println(&quot;Service End Point &quot; + servInfo.getEndPoint()) ;</span>
<span style="color:red;">            				System.out.println(&quot;wsdl wri &quot; + servInfo.getWsdluri()) ;</span>
<span style="color:red;">            				System.out.println(&quot;---------------------------------&quot;);</span>
<span style="color:red;">            				</span>
<span style="color:red;">            				</span>
<span style="color:red;">            				</span>
<span style="color:red;">            			}</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			System.out.println(&quot;ServiceInfo - Message Body  &quot; + messageBody) ;</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			// Build and send DECLINE message with web service info</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			ContentTypeHeader contentTypeHeader = new ContentType(</span>
<span style="color:red;">            					&quot;text&quot;, &quot;plain&quot;);</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			Response response = messageFactory.createResponse(</span>
<span style="color:red;">            					Response.DECLINE, request, contentTypeHeader,</span>
<span style="color:red;">            					messageBody); </span>
<span style="color:red;">            			</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			</span>
<span style="color:red;">            			if (serverTransaction != null)</span>
<span style="color:red;">            				serverTransaction.sendResponse(response);</span>
<span style="color:red;">            			else</span>
<span style="color:red;">            				sipProvider.sendResponse(response);</span>
<span style="color:red;">            			return;</span>
<span style="color:red;">            		}</span>
<span style="color:red;">            		else </span>
<span style="color:red;">            			System.out.println(&quot;There are no services for org &quot; + orgNamePattern) ;</span>
<span style="color:red;">            		</span>
<span style="color:red;">            		}</span>
<span style="color:red;">                	</span>
<span style="color:red;">                	// End of ECE355 change</span>
<span style="color:red;">                	 </span>
<span style="color:red;">                	 */</span>
<span style="color:red;">                	</span>
<span style="color:red;">                	// 4. Forward the request statefully to each target Section 16.6.:</span>
<span style="color:red;">                	requestForwarding.forwardRequest</span>
<span style="color:red;">                	(targetURIList,sipProvider,</span>
<span style="color:red;">                			request,serverTransaction,true);</span>
<span style="color:red;">                	</span>
<span style="color:red;">                	return;</span>
<span style="color:red;">                } else {</span>
<span style="color:red;">                	// Let's continue and try the default hop.</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">             // The registrar cannot help to decide the targets, so let's use</span>
<span style="color:red;">             // our router: the default hop!</span>
<span style="color:red;">            ProxyDebug.println</span>
<span style="color:red;">		(&quot;Proxy, processRequest(), the registrar cannot help&quot;+</span>
<span style="color:red;">            &quot; to decide the targets, so let's use our router: the default hop&quot;);</span>
<span style="color:red;">            Router router=sipStack.getRouter();</span>
<span style="color:red;">            if (router!=null) {</span>
<span style="color:red;">                ProxyHop hop =(ProxyHop) router.getOutboundProxy();</span>
<span style="color:red;">                if (hop!=null ) {</span>
<span style="color:red;">                    if (ProxyDebug.debug)</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">			(&quot;Proxy, processRequest(), the target set&quot;+</span>
<span style="color:red;">                        &quot; is the defaut hop: outbound proxy&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		    // Bug fix contributed by Joe Provino</span>
<span style="color:red;">		    String user = null;</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">             	    if (requestURI.isSipURI()) {</span>
<span style="color:red;">                	SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:red;">			user = requestSipURI.getUser();</span>
<span style="color:red;">		    }</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    SipURI hopURI=addressFactory.createSipURI</span>
<span style="color:red;">			(user,hop.getHost());</span>
<span style="color:red;">                    hopURI.setTransportParam(hop.getTransport());</span>
<span style="color:red;">                    hopURI.setPort(hop.getPort());</span>
<span style="color:red;">                    targetURI=hopURI;</span>
<span style="color:red;">                    targetURIList.addElement(targetURI);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    // 4. Forward the request statelessly to each target Section 16.6.:</span>
<span style="color:red;">                    requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:red;">                    request,serverTransaction,false);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    return;</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">                     </span>
<span style="color:red;">            /* If the target set remains empty after applying all of the above, the</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>			<span style="color:green;">if (requestURI.isSipURI()) {</span>
<span style="color:green;"></span>				<span style="color:green;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:green;"></span>				<span style="color:green;">Iterator iterator=requestSipURI.getParameterNames();</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(), we canonicalized&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; the request-URI&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:green;"></span>					<span style="color:green;">String name=(String)iterator.next();</span>
<span style="color:green;"></span>					<span style="color:green;">requestSipURI.removeParameter(name);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;krakovia sipProvider: &quot;+sipProvider.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;krakovia request: &quot;+request.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;krakovia serverTransaction: &quot;+request.getRequestURI());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">//Check the Blocked User List for the specific request</span>
<span style="color:green;"></span>			<span style="color:green;">//if the user is blocked then it should return busy</span>
<span style="color:green;"></span>			<span style="color:green;">String caller = request.getHeader(FromHeader.NAME).toString();</span>
<span style="color:green;"></span>			<span style="color:green;">String callee = request.getHeader(ToHeader.NAME).toString();</span>
<span style="color:green;"></span>			<span style="color:green;">caller = caller.substring(caller.indexOf(&quot;&lt;&quot;) + 1, caller.indexOf(&quot;&gt;&quot;));</span>
<span style="color:green;"></span>			<span style="color:green;">callee = callee.substring(callee.indexOf(&quot;&lt;&quot;) + 1, callee.indexOf(&quot;&gt;&quot;));</span>
<span style="color:green;"></span>			<span style="color:green;">caller = caller.split(&quot;;&quot;)[0];</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Caller and Callee: &quot;+caller +&quot;~&quot;+callee);</span>
<span style="color:green;"></span>			<span style="color:green;">boolean userIsBlocked = registrar.foundInBlockedUsersList(callee, caller);</span>
<span style="color:green;"></span>			<span style="color:green;">if (userIsBlocked){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Proxy: User: &quot;+callee+&quot; is Already Blocked from: &quot;+caller);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=</span>
<span style="color:green;"></span>						<span style="color:green;">messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.NOT_FOUND,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">//Check if the caller is the same as the final forwardee</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Check if the caller is the same as the final forwardee&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">String key=registrar.getKey(request);</span>
<span style="color:green;"></span>			<span style="color:green;">String finalForwardee = registrar.findFinalForwardee(key);</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (finalForwardee != null &amp;&amp; finalForwardee.equals(caller)) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;finalforwardee is the same as the caller&quot;);</span><span style="background-color:red;">		</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, FinalForwardee same as the &quot;</span>
<span style="color:green;"></span>							<span style="color:green;">+ &quot;caller Cycle will be created, response sent:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/**</span>
<span style="color:green;"></span>			<span style="color:green;"> * Changes request based on final forwardee</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>			<span style="color:green;">Request newrequest = transformRequestBasedOnForwardings(request);</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (newrequest == null){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Proxy: User To forward not found online&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=</span>
<span style="color:green;"></span>						<span style="color:green;">messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.NOT_FOUND,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">request = newrequest;</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrar.hasRegistration(request)  ) {</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">targetURIList=registrar.getContactsURI(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">// We fork only INVITE</span>
<span style="color:green;"></span>				<span style="color:green;">if (targetURIList!=null &amp;&amp; targetURIList.size()&gt;1</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">&amp;&amp; !request.getMethod().equals(&quot;INVITE&quot;) ) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy, processRequest(), the request &quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; to fork is not an INVITE, so we will process&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; it with the first target as the only target.&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">targetURI= (URI)targetURIList.firstElement();</span>
<span style="color:green;"></span>					<span style="color:green;">targetURIList=new Vector();</span>
<span style="color:green;"></span>					<span style="color:green;">targetURIList.addElement(targetURI);</span>
<span style="color:green;"></span>					<span style="color:green;">// 4. Forward the request statefully to the target:</span>
<span style="color:green;"></span>					<span style="color:green;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">request,serverTransaction,true);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (targetURIList!=null &amp;&amp; !targetURIList.isEmpty()) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy, processRequest(), the target set&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; is the set of the contacts URI from the &quot; +</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; location service&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">// 4. Forward the request statefully to each target Section 16.6.:</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">/*</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;krakovia target URI LIST: &quot;+targetURIList.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;krakovia sipProvider: &quot;+sipProvider.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;krakovia request: &quot;+request.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;krakovia serverTransaction: &quot;+request.getRequestURI());</span>
<span style="color:green;"></span>					<span style="color:green;">*/</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">requestForwarding.forwardRequest</span>
<span style="color:green;"></span>					<span style="color:green;">(targetURIList,sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">request,serverTransaction,true);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">/*</span>
<span style="color:green;"></span>					<span style="color:green;"> * Here we have an invite request and we should run a method which runs in a thread</span>
<span style="color:green;"></span>					<span style="color:green;"> * and polls over the users in order to charge the caller adeptly</span>
<span style="color:green;"></span>					<span style="color:green;"> * Pathological Scenario</span>
<span style="color:green;"></span>					<span style="color:green;"> */</span>
<span style="color:green;"></span>					<span style="color:green;">/*</span>
<span style="color:green;"></span>					<span style="color:green;">new Thread(() -&gt; {</span>
<span style="color:green;"></span>						<span style="color:green;">this.callPolling( caller, callee);</span>
<span style="color:green;"></span>					<span style="color:green;">}).start();</span>
<span style="color:green;"></span>					<span style="color:green;">*/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">// Let's continue and try the default hop.</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// The registrar cannot help to decide the targets, so let's use</span>
<span style="color:green;"></span>			<span style="color:green;">// our router: the default hop!</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>			<span style="color:green;">(&quot;Proxy, processRequest(), the registrar cannot help&quot;+</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; to decide the targets, so let's use our router: the default hop&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">Router router=sipStack.getRouter();</span>
<span style="color:green;"></span>			<span style="color:green;">if (router!=null) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyHop hop =(ProxyHop) router.getOutboundProxy();</span>
<span style="color:green;"></span>				<span style="color:green;">if (hop!=null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Proxy, processRequest(), the target set&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; is the defaut hop: outbound proxy&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">// Bug fix contributed by Joe Provino</span>
<span style="color:green;"></span>					<span style="color:green;">String user = null;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (requestURI.isSipURI()) {</span>
<span style="color:green;"></span>						<span style="color:green;">SipURI requestSipURI=(SipURI)requestURI;</span>
<span style="color:green;"></span>						<span style="color:green;">user = requestSipURI.getUser();</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">SipURI hopURI=addressFactory.createSipURI</span>
<span style="color:green;"></span>							<span style="color:green;">(user,hop.getHost());</span>
<span style="color:green;"></span>					<span style="color:green;">hopURI.setTransportParam(hop.getTransport());</span>
<span style="color:green;"></span>					<span style="color:green;">hopURI.setPort(hop.getPort());</span>
<span style="color:green;"></span>					<span style="color:green;">targetURI=hopURI;</span>
<span style="color:green;"></span>					<span style="color:green;">targetURIList.addElement(targetURI);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">// 4. Forward the request statelessly to each target Section 16.6.:</span>
<span style="color:green;"></span>					<span style="color:green;">requestForwarding.forwardRequest(targetURIList,sipProvider,</span>
<span style="color:green;"></span>							<span style="color:green;">request,serverTransaction,false);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">/* If the target set remains empty after applying all of the above, the</span>
               proxy MUST return an error response, which SHOULD be the 480
               (Temporarily Unavailable) response.
<span style="color:red;">             */</span>
<span style="color:red;">             Response response=messageFactory.createResponse</span>
<span style="color:red;">             (Response.TEMPORARILY_UNAVAILABLE,request);</span>
<span style="color:red;">             if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">             else sipProvider.sendResponse(response);</span>
<span style="color:red;">                   </span>
<span style="color:red;">             if (ProxyDebug.debug)</span>
<span style="color:red;">                 ProxyDebug.println(&quot;Proxy, processRequest(), unable to set &quot;+</span>
<span style="color:red;">                 &quot; the targets, 480 (Temporarily Unavailable) replied:\n&quot;+</span>
<span style="color:red;">                 response.toString() );</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex){</span>
<span style="color:red;">            try{</span>
<span style="color:red;">                if (ProxyDebug.debug) {</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Proxy, processRequest(), internal error, &quot;+</span>
<span style="color:red;">                    &quot;exception raised:&quot;);</span>
<span style="color:red;">                    ProxyDebug.logException(ex);</span>
<span style="color:red;">		    ex.printStackTrace();</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                // This is an internal error:</span>
<span style="color:red;">                // Let's return a 500 SERVER_INTERNAL_ERROR</span>
<span style="color:red;">                Response response=messageFactory.createResponse</span>
<span style="color:red;">                (Response.SERVER_INTERNAL_ERROR,request);</span>
<span style="color:red;">                if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">                else sipProvider.sendResponse(response);</span>
<span style="color:red;">                   </span>
<span style="color:red;">                if (ProxyDebug.debug)</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:red;">                    &quot; 500 SERVER_INTERNAL_ERROR replied:\n&quot;+</span>
<span style="color:red;">                    response.toString());</span>
<span style="color:red;">            }</span>
<span style="color:red;">            catch (Exception e){</span>
<span style="color:red;">                e.printStackTrace();</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    /** This is a listener method.</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public void processResponse(ResponseEvent responseEvent) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            </span>
<span style="color:red;">	    </span>
<span style="color:red;">            Response response = responseEvent.getResponse();</span>
<span style="color:red;">            SipProvider sipProvider = (SipProvider) responseEvent.getSource();</span>
<span style="color:red;">            ClientTransaction clientTransaction=responseEvent.getClientTransaction();</span>
<span style="color:red;">            </span>
<span style="color:red;">            ProxyDebug.println</span>
<span style="color:red;">            (&quot;\n***************************************************************&quot;+</span>
<span style="color:red;">            &quot;\n***************************************************************&quot;+</span>
<span style="color:red;">            &quot;\nResponse &quot;+response.getStatusCode() + &quot; &quot;+response.getReasonPhrase()</span>
<span style="color:red;">            +&quot; received:\n&quot;+response.toString() );</span>
<span style="color:red;">            ProxyDebug.println(&quot;Processing Response in progress&quot;);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (ProxyDebug.debug)</span>
<span style="color:red;">                ProxyUtilities.printTransaction(clientTransaction);</span>
<span style="color:red;">            </span>
<span style="color:red;">	    //Henrik - added handling of responses addressed to server</span>
<span style="color:red;">	    //If we use a presenceserver, and if statuscode was OK...</span>
<span style="color:red;">	    CSeqHeader cseqHeader = (CSeqHeader)response.getHeader(CSeqHeader.NAME); </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">	     if (cseqHeader.getMethod().equals(&quot;SUBSCRIBE&quot;)) {</span>
<span style="color:red;">		    presenceServer.processSubscribeResponse((Response)response.clone(), clientTransaction);</span>
<span style="color:red;">	     } else if (cseqHeader.getMethod().equals(&quot;NOTIFY&quot;)) {</span>
<span style="color:red;">		    //presenceServer.processNotifyResponse((Response)response.clone(), clientTransaction);</span>
<span style="color:red;">	     } </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            responseForwarding.forwardResponse(sipProvider, response,clientTransaction);</span>
<span style="color:red;">            </span>
<span style="color:red;">        } catch (Exception ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Proxy, processResponse(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    /** JAIN Listener method.</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public void processTimeout(TimeoutEvent timeOutEvent) {</span>
<span style="color:red;">        ProxyDebug.println(&quot;TimeoutEvent received&quot;);</span>
<span style="color:red;">	SipProvider sipProvider = (SipProvider)timeOutEvent.getSource();</span>
<span style="color:red;">	TransactionsMapping transactionsMapping = null;</span>
<span style="color:red;">        if (timeOutEvent.isServerTransaction()) {</span>
<span style="color:red;">            ServerTransaction serverTransaction  =</span>
<span style="color:red;">            timeOutEvent.getServerTransaction();</span>
<span style="color:red;">	    Dialog dialog = serverTransaction.getDialog();</span>
<span style="color:red;">	    if (dialog != null) {</span>
<span style="color:red;">		transactionsMapping = </span>
<span style="color:red;">			(TransactionsMapping) dialog.getApplicationData();</span>
<span style="color:red;">                transactionsMapping.removeMapping(serverTransaction);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">        } else {</span>
<span style="color:red;">            ClientTransaction clientTransaction =</span>
<span style="color:red;">            timeOutEvent.getClientTransaction();</span>
<span style="color:red;">	    Dialog dialog = clientTransaction.getDialog();</span>
<span style="color:red;">	    ServerTransaction st = null;</span>
<span style="color:red;">	    if (dialog != null) {</span>
<span style="color:red;">		transactionsMapping = </span>
<span style="color:red;">		(TransactionsMapping) dialog.getApplicationData();</span>
<span style="color:red;">		if (transactionsMapping != null)  {</span>
<span style="color:red;">                   st = transactionsMapping.getServerTransaction</span>
<span style="color:red;">		   (clientTransaction);</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span>			<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>					<span style="color:green;">(Response.TEMPORARILY_UNAVAILABLE,request);</span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(), unable to set &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot; the targets, 480 (Temporarily Unavailable) replied:\n&quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">response.toString() );</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex){</span>
<span style="color:green;"></span>			<span style="color:green;">try{</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(), internal error, &quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>					<span style="color:green;">ex.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">// This is an internal error:</span>
<span style="color:green;"></span>				<span style="color:green;">// Let's return a 500 SERVER_INTERNAL_ERROR</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.SERVER_INTERNAL_ERROR,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Proxy, processRequest(),&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 500 SERVER_INTERNAL_ERROR replied:\n&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">response.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">catch (Exception e){</span>
<span style="color:green;"></span>				<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
		}
<span style="color:red;">               if (st==null) {</span>
<span style="color:red;">                  ProxyDebug.println</span>
<span style="color:red;">		  (&quot;ERROR, Unable to retrieve the server transaction,&quot;+</span>
<span style="color:red;">                  &quot; cannot process timeout!&quot;);</span>
<span style="color:red;">                  return;</span>
<span style="color:red;">               }</span>
<span style="color:red;">	    } else {</span>
<span style="color:red;">               ProxyDebug.println</span>
<span style="color:red;">		  (&quot;ERROR, Unable to retrieve the transaction Mapping,&quot;+</span>
<span style="color:red;">                  &quot; cannot process timeout!&quot;);</span>
<span style="color:red;">                  return;</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            Request request = st.getRequest();</span>
<span style="color:red;">            // This removes the given mapping from the table but not</span>
<span style="color:red;">            // necessarily the whole thing.</span>
<span style="color:red;">            transactionsMapping.removeMapping(clientTransaction);</span>
<span style="color:red;">            if (!transactionsMapping.hasMapping(st)) {</span>
<span style="color:red;">                // No more mappings left in the transaction table.</span>
<span style="color:red;">                try {</span>
<span style="color:red;">                    Response response = messageFactory.createResponse</span>
<span style="color:red;">                    (Response.REQUEST_TIMEOUT, request);</span>
<span style="color:red;">                    st.sendResponse(response);</span>
<span style="color:red;">                } catch (ParseException ex) {</span>
<span style="color:red;">                    ex.printStackTrace();</span>
<span style="color:red;">                } catch (SipException ex1) {</span>
<span style="color:red;">                    ex1.printStackTrace();</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        </span>
<span style="color:red;">        </span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    /***********************  Methods for         ***************</span>
<span style="color:red;">     *    starting and stopping the proxy          		*</span>
<span style="color:red;">     ************************************************************/</span>
<span style="color:red;">    </span>
<span style="color:red;">    /** Start the proxy, this method has to be called after the init method</span>
<span style="color:red;">     * throws Exception that which can be caught by the upper application</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public void start() throws Exception {</span>
<span style="color:red;">        if (configuration!=null</span>
<span style="color:red;">        &amp;&amp; configuration.isValidConfiguration()) {</span>
<span style="color:red;">            Properties properties=new Properties();</span>
<span style="color:red;">            // LOGGING property:</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (configuration.enableDebug) {</span>
<span style="color:red;">                ProxyDebug.debug=true;</span>
<span style="color:red;">                ProxyDebug.setProxyOutputFile(configuration.outputProxy);</span>
<span style="color:red;">                ProxyDebug.println(&quot;DEBUG properties set!&quot;);</span>
<span style="color:red;">                if (configuration.badMessageLogFile!=null)</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.BAD_MESSAGE_LOG&quot;,</span>
<span style="color:red;">                    configuration.badMessageLogFile);</span>
<span style="color:red;">                if (configuration.debugLogFile!=null) {</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.DEBUG_LOG&quot;,</span>
<span style="color:red;">                    configuration.debugLogFile);</span>
<span style="color:red;">                   </span>
<span style="color:red;">                }</span>
<span style="color:red;">                if (configuration.serverLogFile!=null)</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.SERVER_LOG&quot;,</span>
<span style="color:red;">                    configuration.serverLogFile);</span>
<span style="color:red;">                if (configuration.debugLogFile != null)</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:red;">                    &quot;32&quot;);</span>
<span style="color:red;">                else</span>
<span style="color:red;">                if (configuration.serverLogFile != null)</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:red;">                    &quot;16&quot;);</span>
<span style="color:red;">                else</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:red;">                    &quot;0&quot;);</span>
<span style="color:red;">           </span>
<span style="color:red;">                </span>
<span style="color:red;">            }</span>
<span style="color:red;">            else {</span>
<span style="color:red;">                System.out.println(&quot;DEBUG properties not set!&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">             registrar.setExpiresTime(configuration.expiresTime);</span>
<span style="color:red;">            </span>
<span style="color:red;">            // STOP TIME</span>
<span style="color:red;">            if (configuration.stopTime!=null) {</span>
<span style="color:red;">                try {</span>
<span style="color:red;">                    long stopTime=Long.parseLong(configuration.stopTime);</span>
<span style="color:red;">                    StopProxy stopProxy=new StopProxy(this);</span>
<span style="color:red;">                    Timer timer=new Timer();</span>
<span style="color:red;">                    timer.schedule(stopProxy,stopTime);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                catch(Exception e) {</span>
<span style="color:red;">                    e.printStackTrace();</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            sipStack = null;</span>
<span style="color:red;">            </span>
<span style="color:red;">            SipFactory sipFactory = SipFactory.getInstance();</span>
<span style="color:red;">            sipFactory.setPathName(&quot;gov.nist&quot;);</span>
<span style="color:red;">              </span>
<span style="color:red;">            headerFactory = sipFactory.createHeaderFactory();</span>
<span style="color:red;">            addressFactory = sipFactory.createAddressFactory();</span>
<span style="color:red;">            messageFactory = sipFactory.createMessageFactory();</span>
<span style="color:red;">                </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            // Create SipStack object</span>
<span style="color:red;">            </span>
<span style="color:red;">            properties.setProperty(&quot;javax.sip.IP_ADDRESS&quot;,</span>
<span style="color:red;">            configuration.stackIPAddress);</span>
<span style="color:red;">            </span>
<span style="color:red;">            // We have to add the IP address of the proxy for the domain:</span>
<span style="color:red;">            configuration.domainList.addElement(configuration.stackIPAddress);</span>
<span style="color:red;">            ProxyDebug.println(&quot;The proxy is responsible for the domain:&quot;+configuration.stackIPAddress);</span>
<span style="color:red;">            </span>
<span style="color:red;">            properties.setProperty(&quot;javax.sip.STACK_NAME&quot;,</span>
<span style="color:red;">            configuration.stackName);</span>
<span style="color:red;">            if (configuration.check(configuration.outboundProxy))</span>
<span style="color:red;">                properties.setProperty(&quot;javax.sip.OUTBOUND_PROXY&quot;,</span>
<span style="color:red;">                configuration.outboundProxy);</span>
<span style="color:red;">            if (configuration.check(configuration.routerPath))</span>
<span style="color:red;">                properties.setProperty(&quot;javax.sip.ROUTER_PATH&quot;,</span>
<span style="color:red;">                configuration.routerPath);</span>
<span style="color:red;">            if (configuration.check(configuration.extensionMethods))</span>
<span style="color:red;">                properties.setProperty(&quot;javax.sip.EXTENSION_METHODS&quot;,</span>
<span style="color:red;">                configuration.extensionMethods);</span>
<span style="color:red;">	    // This has to be hardcoded to true. for the proxy.</span>
<span style="color:red;">            properties.setProperty(&quot;javax.sip.RETRANSMISSION_FILTER&quot;,</span>
<span style="color:red;">                &quot;on&quot;);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (configuration.check(configuration.maxConnections) ) </span>
<span style="color:red;">                properties.setProperty(&quot;gov.nist.javax.sip.MAX_CONNECTIONS&quot;,</span>
<span style="color:red;">                configuration.maxConnections);</span>
<span style="color:red;">            if (configuration.check(configuration.maxServerTransactions) ) </span>
<span style="color:red;">                properties.setProperty(&quot;gov.nist.javax.sip.MAX_SERVER_TRANSACTIONS&quot;,</span>
<span style="color:red;">                configuration.maxServerTransactions);</span>
<span style="color:red;">            if (configuration.check(configuration.threadPoolSize) ) </span>
<span style="color:red;">                properties.setProperty(&quot;gov.nist.javax.sip.THREAD_POOL_SIZE&quot;,</span>
<span style="color:red;">                configuration.threadPoolSize);</span>
<span style="color:red;">             </span>
<span style="color:red;">            if (configuration.domainList!=null)</span>
<span style="color:red;">            for ( int j=0;j&lt;configuration.domainList.size();j++) {</span>
<span style="color:red;">                String domain=(String)configuration.domainList.elementAt(j);</span>
<span style="color:red;">                ProxyDebug.println(&quot;Here is one domain to take care of:&quot;+domain);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else ProxyDebug.println(&quot;No domain to take care of...&quot;);</span>
<span style="color:red;"> </span>
<span style="color:red;">            if (configuration.accessLogViaRMI) {</span>
<span style="color:red;">                properties.setProperty(&quot;gov.nist.javax.sip.ACCESS_LOG_VIA_RMI&quot;,</span>
<span style="color:red;">                &quot;true&quot;);</span>
<span style="color:red;">                </span>
<span style="color:red;">                properties.setProperty(&quot;gov.nist.javax.sip.RMI_PORT&quot;,</span>
<span style="color:red;">                configuration.logRMIPort);</span>
<span style="color:red;">               </span>
<span style="color:red;">                if (configuration.check(configuration.logLifetime) )</span>
<span style="color:red;">                    properties.setProperty(&quot;gov.nist.javax.sip.LOG_LIFETIME&quot;,</span>
<span style="color:red;">                    configuration.logLifetime);</span>
<span style="color:red;">                </span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            sipStack = sipFactory.createSipStack(properties);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            </span>
<span style="color:red;">            </span>
<span style="color:red;">        </span>
<span style="color:red;">            // Authentication part:</span>
<span style="color:red;">            if (configuration.enableAuthentication) {</span>
<span style="color:red;">                authentication =new Authentication(this);</span>
<span style="color:red;">                try{</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    Class authMethodClass =</span>
<span style="color:red;">				Class.forName(configuration.classFile);</span>
<span style="color:red;">                    AuthenticationMethod authMethod</span>
<span style="color:red;">                    = (AuthenticationMethod)</span>
<span style="color:red;">                    authMethodClass.newInstance();</span>
<span style="color:red;">                    authMethod.initialize(configuration.passwordsFile);</span>
<span style="color:red;">                   </span>
<span style="color:red;">                    authentication.setAuthenticationMethod(authMethod);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                }</span>
<span style="color:red;">                catch(Exception e) {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;ERROR, authentication process stopped, exception raised:&quot;);</span>
<span style="color:red;">                    e.printStackTrace();</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            // We create the Listening points:</span>
<span style="color:red;">            Vector lps=configuration.getListeningPoints();</span>
<span style="color:red;">            </span>
<span style="color:red;">            for ( int i=0;lps!=null &amp;&amp; i&lt;lps.size();i++) {</span>
<span style="color:red;">                Association a=(Association)lps.elementAt(i);</span>
<span style="color:red;">                try{</span>
<span style="color:red;">                    System.out.println(&quot;transport  &quot; + a.transport);</span>
<span style="color:red;">                    System.out.println(&quot;port  &quot; +</span>
<span style="color:red;">                    Integer.valueOf(a.port).intValue());</span>
<span style="color:red;">                    ListeningPoint lp=sipStack.createListeningPoint</span>
<span style="color:red;">                    (Integer.valueOf(a.port).intValue(),</span>
<span style="color:red;">                    a.transport);</span>
<span style="color:red;">		    this.listeningPoints.add(lp);</span>
<span style="color:red;">                    SipProvider sipProvider = sipStack.createSipProvider(lp);</span>
<span style="color:red;">		    if (this.defaultProvider == null) </span>
<span style="color:red;">			this.defaultProvider = sipProvider;</span>
<span style="color:red;">                    sipProvider.addSipListener( this );</span>
<span style="color:red;">                }</span>
<span style="color:red;">                catch(Exception e) {</span>
<span style="color:red;">                    e.printStackTrace();</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;ERROR: listening point not created &quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            // Export the registry for polling by the responder.</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (configuration.exportRegistry )</span>
<span style="color:red;">                // initialize the registrar for  RMI.</span>
<span style="color:red;">                this.registrar.initRMIBindings();</span>
<span style="color:red;">            </span>
<span style="color:red;">            </span>
<span style="color:red;">            // Parse static configuration for registrar.</span>
<span style="color:red;">            if (configuration.enableRegistrations) {</span>
<span style="color:red;">                String value=configuration.registrationsFile;</span>
<span style="color:red;">                ProxyDebug.println(&quot;Parsing the XML registrations file: &quot;+value);</span>
<span style="color:red;">                if (value==null || value.trim().equals(&quot;&quot;)) {</span>
<span style="color:red;">                    ProxyDebug.println(&quot;You have to set the registrations file...&quot;);</span>
<span style="color:red;">                } else {</span>
<span style="color:red;">                    registrar.parseXMLregistrations(value);</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else ProxyDebug.println(&quot;No registrations to parse...&quot;);</span>
<span style="color:red;">            </span>
<span style="color:red;">            // Register to proxies if any:</span>
<span style="color:red;">            registrar.registerToProxies();</span>
<span style="color:red;">            </span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            System.out.println(&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:red;">            &quot; Correct the errors first.&quot;);</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">  /** Stop the proxy, this method has to be called after the start method</span>
<span style="color:red;">     * throws Exception that which can be caught by the upper application</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public void stop()  throws Exception {</span>
<span style="color:red;">        if (sipStack==null) return;     </span>
<span style="color:red;">        this.presenceServer.stop();</span>
<span style="color:red;">        </span>
<span style="color:red;">        Iterator sipProviders=sipStack.getSipProviders();</span>
<span style="color:red;">        if (sipProviders!=null) {</span>
<span style="color:red;">            while( sipProviders.hasNext()) {</span>
<span style="color:red;">                SipProvider sp=(SipProvider)sipProviders.next();                    </span>
<span style="color:red;">                sp.removeSipListener(this);</span>
<span style="color:red;">                sipStack.deleteSipProvider(sp);</span>
<span style="color:red;">                sipProviders=sipStack.getSipProviders();</span>
<span style="color:red;">                System.out.println(&quot;One sip Provider removed!&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:red;">                &quot; has no sip Provider to remove!&quot;);</span>
<span style="color:red;">        }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">       Iterator listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:red;">        if (listeningPoints!=null) {</span>
<span style="color:red;">            while( listeningPoints.hasNext()) {</span>
<span style="color:red;">                ListeningPoint lp=(ListeningPoint)listeningPoints.next();</span>
<span style="color:red;">                sipStack.deleteListeningPoint(lp);</span>
<span style="color:red;">                listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:red;">                System.out.println(&quot;One listening point removed!&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:red;">                &quot; has no listening points to remove!&quot;);</span>
<span style="color:red;">        }        </span>
<span style="color:red;">        registrar.clean();</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    /** Exit the proxy,</span>
<span style="color:red;">     * throws Exception that which can be caught by the upper application</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public void exit()  throws Exception {</span>
<span style="color:red;">        Iterator sipProviders=sipStack.getSipProviders();</span>
<span style="color:red;">        if (sipProviders!=null) {</span>
<span style="color:red;">            while( sipProviders.hasNext()) {</span>
<span style="color:red;">                SipProvider sp=(SipProvider)sipProviders.next();                    </span>
<span style="color:red;">                sp.removeSipListener(this);</span>
<span style="color:red;">                sipStack.deleteSipProvider(sp);</span>
<span style="color:red;">                sipProviders=sipStack.getSipProviders();</span>
<span style="color:red;">                System.out.println(&quot;One sip Provider removed!&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:red;">                &quot; has no sip Provider to remove!&quot;);</span>
<span style="color:red;">        }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">        Iterator listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:red;">        if (listeningPoints!=null) {</span>
<span style="color:red;">            while( listeningPoints.hasNext()) {</span>
<span style="color:red;">                ListeningPoint lp=(ListeningPoint)listeningPoints.next();</span>
<span style="color:red;">                sipStack.deleteListeningPoint(lp);</span>
<span style="color:red;">                listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:red;">                System.out.println(&quot;One listening point removed!&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else {</span>
<span style="color:red;">            ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:red;">                &quot; has no listening points to remove!&quot;);</span>
<span style="color:red;">        }        </span>
<span style="color:red;">        ProxyDebug.println(&quot;Proxy exit.........................&quot;);</span>
<span style="color:red;">	configuration.listeningPoints.clear();</span>
<span style="color:red;">        registrar.clean();</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public ViaHeader getStackViaHeader() {</span>
<span style="color:red;">	try {</span>
<span style="color:red;">	  ListeningPoint lp = </span>
<span style="color:red;">		(ListeningPoint)sipStack.getListeningPoints().next();</span>
<span style="color:red;">	  String host = sipStack.getIPAddress();</span>
<span style="color:red;">	  int port = lp.getPort();</span>
<span style="color:red;">	  String transport = lp.getTransport();</span>
<span style="color:red;">	  // branch id is assigned by the transaction layer.</span>
<span style="color:red;">	  return  headerFactory.createViaHeader</span>
<span style="color:red;">			(host,port,transport,null);</span>
<span style="color:red;">	} catch (Exception e) {</span>
<span style="color:red;">		e.printStackTrace();</span>
<span style="color:red;">		return null;</span>
	}
	
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public ContactHeader getStackContactHeader() {</span>
<span style="color:red;">	try {</span>
<span style="color:red;">	  ListeningPoint lp = </span>
<span style="color:red;">		(ListeningPoint)sipStack.getListeningPoints().next();</span>
<span style="color:red;">	  String host = sipStack.getIPAddress();</span>
<span style="color:red;">	  int port = lp.getPort();</span>
<span style="color:red;">	  String transport = lp.getTransport();</span>
<span style="color:red;">          </span>
<span style="color:red;">	  SipURI sipURI=addressFactory.createSipURI(null,host);</span>
<span style="color:red;">          sipURI.setPort(port);</span>
<span style="color:red;">          sipURI.setTransportParam(transport);</span>
<span style="color:red;">          Address contactAddress=addressFactory.createAddress(sipURI);</span>
<span style="color:red;">          </span>
<span style="color:red;">          return headerFactory.createContactHeader(contactAddress);</span>
<span style="color:red;">	} catch (Exception e) {</span>
<span style="color:red;">		e.printStackTrace();</span>
<span style="color:red;">		return null;</span>
<span style="color:green;"></span>	<span style="color:green;">private void callPolling (String caller, String callee){</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
	}
	
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    /*************************************************************************/</span>
<span style="color:red;">    /************ The main method: to launch the proxy          *************/</span>
<span style="color:red;">    /************************************************************************/</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    public static void main(String args[]) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            // the Proxy:</span>
<span style="color:red;">	    if (args.length == 0)  {</span>
<span style="color:red;">		System.out.println(&quot;Config file missing!&quot;);</span>
<span style="color:red;">		System.exit(0);</span>
<span style="color:red;">	    }</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">private Request transformRequestBasedOnForwardings(Request request) throws ParseException {</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Proxy [entry]: transformRequestBasedOnForwardings&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">String key=registrar.getKey(request);</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Request key: &quot; + key);</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Request: &quot; + request.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">String finalForwardee = registrar.findFinalForwardee(key);</span>
<span style="color:green;"></span>		<span style="color:green;">if (finalForwardee == null) {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Proxy [transformRequestBasedOnForwardings Error]: null finalforwardee&quot;);</span><span style="background-color:red;">		</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Trying to addressFactory.createSipURI finalForwardee: &quot;+ finalForwardee );</span><span style="background-color:red;">		</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">SipURI finalforwardeeuri = stringToSipURI(finalForwardee);</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Found final forwardee: &quot;+ finalforwardeeuri );</span><span style="background-color:red;">	</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">Request newrequest = (Request)request.clone();</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Request header: &quot; + newrequest.getHeader(&quot;To&quot;));</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ToHeader tempheader = (ToHeader) newrequest.getHeader(ToHeader.NAME);</span>
<span style="color:green;"></span>		<span style="color:green;">Address newaddressheader = addressFactory.createAddress(finalForwardee);</span>
<span style="color:green;"></span>		<span style="color:green;">tempheader.setAddress(newaddressheader);</span>
		
<span style="color:red;">	    System.out.println(&quot;Using configuration file &quot; + args[1]);</span>
<span style="color:red;">            String confFile= (String) args[1];</span>
<span style="color:red;">            Proxy proxy=new Proxy(confFile);</span>
<span style="color:red;">            proxy.start();</span>
<span style="color:red;">            ProxyDebug.println(&quot;Proxy ready to work&quot;);</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e) {</span>
<span style="color:red;">            System.out.println</span>
<span style="color:red;">            (&quot;ERROR: Set the configuration file flag: &quot; +</span>
<span style="color:red;">            &quot;USE: -cf configuration_file_location.xml&quot;  );</span>
<span style="color:red;">            System.out.println(&quot;ERROR, the proxy can not be started, &quot; +</span>
<span style="color:red;">            &quot; exception raised:\n&quot;);</span>
<span style="color:red;">            e.printStackTrace();</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:green;"></span>		<span style="color:green;">newrequest.setHeader(tempheader);</span>
<span style="color:green;"></span>		<span style="color:green;">newrequest.setRequestURI(finalforwardeeuri);</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;New Transformed Request: &quot; + newrequest.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Proxy [exit]: transformRequestBasedOnForwardings&quot;);</span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">return newrequest;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">// Method for a better URI manipulation with a given string</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public SipURI stringToSipURI(String stringos){</span>
<span style="color:green;"></span>		<span style="color:green;">SipURI newSipURIresult = null;</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">String[] parts = stringos.split(&quot;@&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">String sipuser = parts[0];</span>
<span style="color:green;"></span>			<span style="color:green;">String[] sipuserparts = sipuser.split(&quot;:&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">String username = sipuserparts[1];</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">String ipandport = parts[1];</span>
<span style="color:green;"></span>			<span style="color:green;">String[] ipandportparts = ipandport.split(&quot;:&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">String ipaddress = ipandportparts[0];</span>
<span style="color:green;"></span>			<span style="color:green;">String portaddress = ipandportparts[1];</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">newSipURIresult = addressFactory.createSipURI(username,ipaddress);</span>
<span style="color:green;"></span>			<span style="color:green;">newSipURIresult.setPort( Integer.parseInt(portaddress));</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception ex){</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Error: Couldn't transform String to URI&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">return newSipURIresult;</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** This is a listener method.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public void processResponse(ResponseEvent responseEvent) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">//ProxyDebug.println(&quot;Pare to stack: &quot;+Thread.currentThread().getStackTrace().toString());</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">for (StackTraceElement ste : Thread.currentThread().getStackTrace()) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(ste.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>			<span style="color:green;">Response response = responseEvent.getResponse();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">SipProvider sipProvider = (SipProvider) responseEvent.getSource();</span>
<span style="color:green;"></span>			<span style="color:green;">ClientTransaction clientTransaction=responseEvent.getClientTransaction();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>			<span style="color:green;">(&quot;\n***************************************************************&quot;+</span>
<span style="color:green;"></span>					<span style="color:green;">&quot;\n***************************************************************&quot;+</span>
<span style="color:green;"></span>					<span style="color:green;">&quot;\nResponse &quot;+response.getStatusCode() + &quot; &quot;+response.getReasonPhrase()</span>
<span style="color:green;"></span>					<span style="color:green;">+&quot; received:\n&quot;+response.toString() );</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Processing Response in progress&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyUtilities.printTransaction(clientTransaction);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">//Henrik - added handling of responses addressed to server</span>
<span style="color:green;"></span>			<span style="color:green;">//If we use a presenceserver, and if statuscode was OK...</span>
<span style="color:green;"></span>			<span style="color:green;">CSeqHeader cseqHeader = (CSeqHeader)response.getHeader(CSeqHeader.NAME);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (cseqHeader.getMethod().equals(&quot;SUBSCRIBE&quot;)) {</span>
<span style="color:green;"></span>				<span style="color:green;">presenceServer.processSubscribeResponse((Response)response.clone(), clientTransaction);</span>
<span style="color:green;"></span>			<span style="color:green;">} else if (cseqHeader.getMethod().equals(&quot;NOTIFY&quot;)) {</span>
<span style="color:green;"></span>				<span style="color:green;">//presenceServer.processNotifyResponse((Response)response.clone(), clientTransaction);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">responseForwarding.forwardResponse(sipProvider, response,clientTransaction);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">} catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Proxy, processResponse(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** JAIN Listener method.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public void processTimeout(TimeoutEvent timeOutEvent) {</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;TimeoutEvent received&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">SipProvider sipProvider = (SipProvider)timeOutEvent.getSource();</span>
<span style="color:green;"></span>		<span style="color:green;">TransactionsMapping transactionsMapping = null;</span>
<span style="color:green;"></span>		<span style="color:green;">if (timeOutEvent.isServerTransaction()) {</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction  =</span>
<span style="color:green;"></span>					<span style="color:green;">timeOutEvent.getServerTransaction();</span>
<span style="color:green;"></span>			<span style="color:green;">Dialog dialog = serverTransaction.getDialog();</span>
<span style="color:green;"></span>			<span style="color:green;">if (dialog != null) {</span>
<span style="color:green;"></span>				<span style="color:green;">transactionsMapping =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">(TransactionsMapping) dialog.getApplicationData();</span>
<span style="color:green;"></span>				<span style="color:green;">transactionsMapping.removeMapping(serverTransaction);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} else {</span>
<span style="color:green;"></span>			<span style="color:green;">ClientTransaction clientTransaction =</span>
<span style="color:green;"></span>					<span style="color:green;">timeOutEvent.getClientTransaction();</span>
<span style="color:green;"></span>			<span style="color:green;">Dialog dialog = clientTransaction.getDialog();</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction st = null;</span>
<span style="color:green;"></span>			<span style="color:green;">if (dialog != null) {</span>
<span style="color:green;"></span>				<span style="color:green;">transactionsMapping =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">(TransactionsMapping) dialog.getApplicationData();</span>
<span style="color:green;"></span>				<span style="color:green;">if (transactionsMapping != null)  {</span>
<span style="color:green;"></span>					<span style="color:green;">st = transactionsMapping.getServerTransaction</span>
<span style="color:green;"></span>							<span style="color:green;">(clientTransaction);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">if (st==null) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;ERROR, Unable to retrieve the server transaction,&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; cannot process timeout!&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">} else {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;ERROR, Unable to retrieve the transaction Mapping,&quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot; cannot process timeout!&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">Request request = st.getRequest();</span>
<span style="color:green;"></span>			<span style="color:green;">// This removes the given mapping from the table but not</span>
<span style="color:green;"></span>			<span style="color:green;">// necessarily the whole thing.</span>
<span style="color:green;"></span>			<span style="color:green;">transactionsMapping.removeMapping(clientTransaction);</span>
<span style="color:green;"></span>			<span style="color:green;">if (!transactionsMapping.hasMapping(st)) {</span>
<span style="color:green;"></span>				<span style="color:green;">// No more mappings left in the transaction table.</span>
<span style="color:green;"></span>				<span style="color:green;">try {</span>
<span style="color:green;"></span>					<span style="color:green;">Response response = messageFactory.createResponse</span>
<span style="color:green;"></span>							<span style="color:green;">(Response.REQUEST_TIMEOUT, request);</span>
<span style="color:green;"></span>					<span style="color:green;">st.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">} catch (ParseException ex) {</span>
<span style="color:green;"></span>					<span style="color:green;">ex.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">} catch (SipException ex1) {</span>
<span style="color:green;"></span>					<span style="color:green;">ex1.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/***********************  Methods for         ***************</span>
<span style="color:green;"></span>	<span style="color:green;"> *    starting and stopping the proxy          		*</span>
<span style="color:green;"></span>	<span style="color:green;"> ************************************************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** Start the proxy, this method has to be called after the init method</span>
<span style="color:green;"></span>	<span style="color:green;"> * throws Exception that which can be caught by the upper application</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public void start() throws Exception {</span>
<span style="color:green;"></span>		<span style="color:green;">if (configuration!=null</span>
<span style="color:green;"></span>				<span style="color:green;">&amp;&amp; configuration.isValidConfiguration()) {</span>
<span style="color:green;"></span>			<span style="color:green;">Properties properties=new Properties();</span>
<span style="color:green;"></span>			<span style="color:green;">// LOGGING property:</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.enableDebug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.debug=true;</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.setProxyOutputFile(configuration.outputProxy);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;DEBUG properties set!&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration.badMessageLogFile!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.BAD_MESSAGE_LOG&quot;,</span>
<span style="color:green;"></span>							<span style="color:green;">configuration.badMessageLogFile);</span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration.debugLogFile!=null) {</span>
<span style="color:green;"></span>					<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.DEBUG_LOG&quot;,</span>
<span style="color:green;"></span>							<span style="color:green;">configuration.debugLogFile);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration.serverLogFile!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.SERVER_LOG&quot;,</span>
<span style="color:green;"></span>							<span style="color:green;">configuration.serverLogFile);</span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration.debugLogFile != null)</span>
<span style="color:green;"></span>					<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:green;"></span>							<span style="color:green;">&quot;32&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">else</span>
<span style="color:green;"></span>					<span style="color:green;">if (configuration.serverLogFile != null)</span>
<span style="color:green;"></span>						<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:green;"></span>								<span style="color:green;">&quot;16&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">else</span>
<span style="color:green;"></span>						<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.TRACE_LEVEL&quot;,</span>
<span style="color:green;"></span>								<span style="color:green;">&quot;0&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else {</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;DEBUG properties not set!&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">registrar.setExpiresTime(configuration.expiresTime);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// STOP TIME</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.stopTime!=null) {</span>
<span style="color:green;"></span>				<span style="color:green;">try {</span>
<span style="color:green;"></span>					<span style="color:green;">long stopTime=Long.parseLong(configuration.stopTime);</span>
<span style="color:green;"></span>					<span style="color:green;">StopProxy stopProxy=new StopProxy(this);</span>
<span style="color:green;"></span>					<span style="color:green;">Timer timer=new Timer();</span>
<span style="color:green;"></span>					<span style="color:green;">timer.schedule(stopProxy,stopTime);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>					<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">sipStack = null;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">SipFactory sipFactory = SipFactory.getInstance();</span>
<span style="color:green;"></span>			<span style="color:green;">sipFactory.setPathName(&quot;gov.nist&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">headerFactory = sipFactory.createHeaderFactory();</span>
<span style="color:green;"></span>			<span style="color:green;">addressFactory = sipFactory.createAddressFactory();</span>
<span style="color:green;"></span>			<span style="color:green;">messageFactory = sipFactory.createMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Create SipStack object</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">properties.setProperty(&quot;javax.sip.IP_ADDRESS&quot;,</span>
<span style="color:green;"></span>					<span style="color:green;">configuration.stackIPAddress);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We have to add the IP address of the proxy for the domain:</span>
<span style="color:green;"></span>			<span style="color:green;">configuration.domainList.addElement(configuration.stackIPAddress);</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;The proxy is responsible for the domain:&quot;+configuration.stackIPAddress);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">properties.setProperty(&quot;javax.sip.STACK_NAME&quot;,</span>
<span style="color:green;"></span>					<span style="color:green;">configuration.stackName);</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.outboundProxy))</span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;javax.sip.OUTBOUND_PROXY&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.outboundProxy);</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.routerPath))</span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;javax.sip.ROUTER_PATH&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.routerPath);</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.extensionMethods))</span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;javax.sip.EXTENSION_METHODS&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.extensionMethods);</span>
<span style="color:green;"></span>			<span style="color:green;">// This has to be hardcoded to true. for the proxy.</span>
<span style="color:green;"></span>			<span style="color:green;">properties.setProperty(&quot;javax.sip.RETRANSMISSION_FILTER&quot;,</span>
<span style="color:green;"></span>					<span style="color:green;">&quot;on&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.maxConnections) )</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.MAX_CONNECTIONS&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.maxConnections);</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.maxServerTransactions) )</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.MAX_SERVER_TRANSACTIONS&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.maxServerTransactions);</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.check(configuration.threadPoolSize) )</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.THREAD_POOL_SIZE&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.threadPoolSize);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.domainList!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">for ( int j=0;j&lt;configuration.domainList.size();j++) {</span>
<span style="color:green;"></span>					<span style="color:green;">String domain=(String)configuration.domainList.elementAt(j);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Here is one domain to take care of:&quot;+domain);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else ProxyDebug.println(&quot;No domain to take care of...&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.accessLogViaRMI) {</span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.ACCESS_LOG_VIA_RMI&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;true&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.RMI_PORT&quot;,</span>
<span style="color:green;"></span>						<span style="color:green;">configuration.logRMIPort);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (configuration.check(configuration.logLifetime) )</span>
<span style="color:green;"></span>					<span style="color:green;">properties.setProperty(&quot;gov.nist.javax.sip.LOG_LIFETIME&quot;,</span>
<span style="color:green;"></span>							<span style="color:green;">configuration.logLifetime);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">sipStack = sipFactory.createSipStack(properties);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Authentication part:</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.enableAuthentication) {</span>
<span style="color:green;"></span>				<span style="color:green;">authentication =new Authentication(this);</span>
<span style="color:green;"></span>				<span style="color:green;">try{</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">Class authMethodClass =</span>
<span style="color:green;"></span>							<span style="color:green;">Class.forName(configuration.classFile);</span>
<span style="color:green;"></span>					<span style="color:green;">AuthenticationMethod authMethod</span>
<span style="color:green;"></span>					<span style="color:green;">= (AuthenticationMethod)</span>
<span style="color:green;"></span>					<span style="color:green;">authMethodClass.newInstance();</span>
<span style="color:green;"></span>					<span style="color:green;">authMethod.initialize(configuration.passwordsFile);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">authentication.setAuthenticationMethod(authMethod);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;ERROR, authentication process stopped, exception raised:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We create the Listening points:</span>
<span style="color:green;"></span>			<span style="color:green;">Vector lps=configuration.getListeningPoints();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">for ( int i=0;lps!=null &amp;&amp; i&lt;lps.size();i++) {</span>
<span style="color:green;"></span>				<span style="color:green;">Association a=(Association)lps.elementAt(i);</span>
<span style="color:green;"></span>				<span style="color:green;">try{</span>
<span style="color:green;"></span>					<span style="color:green;">System.out.println(&quot;transport  &quot; + a.transport);</span>
<span style="color:green;"></span>					<span style="color:green;">System.out.println(&quot;port  &quot; +</span>
<span style="color:green;"></span>							<span style="color:green;">Integer.valueOf(a.port).intValue());</span>
<span style="color:green;"></span>					<span style="color:green;">ListeningPoint lp=sipStack.createListeningPoint</span>
<span style="color:green;"></span>							<span style="color:green;">(Integer.valueOf(a.port).intValue(),</span>
<span style="color:green;"></span>									<span style="color:green;">a.transport);</span>
<span style="color:green;"></span>					<span style="color:green;">this.listeningPoints.add(lp);</span>
<span style="color:green;"></span>					<span style="color:green;">SipProvider sipProvider = sipStack.createSipProvider(lp);</span>
<span style="color:green;"></span>					<span style="color:green;">if (this.defaultProvider == null)</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">this.defaultProvider = sipProvider;</span>
<span style="color:green;"></span>					<span style="color:green;">sipProvider.addSipListener( this );</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>					<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;ERROR: listening point not created &quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">// Export the registry for polling by the responder.</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.exportRegistry )</span>
<span style="color:green;"></span>				<span style="color:green;">// initialize the registrar for  RMI.</span>
<span style="color:green;"></span>				<span style="color:green;">this.registrar.initRMIBindings();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Parse static configuration for registrar.</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.enableRegistrations) {</span>
<span style="color:green;"></span>				<span style="color:green;">String value=configuration.registrationsFile;</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Parsing the XML registrations file: &quot;+value);</span>
<span style="color:green;"></span>				<span style="color:green;">if (value==null || value.trim().equals(&quot;&quot;)) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;You have to set the registrations file...&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">} else {</span>
<span style="color:green;"></span>					<span style="color:green;">registrar.parseXMLregistrations(value);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else ProxyDebug.println(&quot;No registrations to parse...&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Register to proxies if any:</span>
<span style="color:green;"></span>			<span style="color:green;">registrar.registerToProxies();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">System.out.println(&quot;ERROR: the configuration file is not correct!&quot;+</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; Correct the errors first.&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** Stop the proxy, this method has to be called after the start method</span>
<span style="color:green;"></span>	<span style="color:green;"> * throws Exception that which can be caught by the upper application</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public void stop()  throws Exception {</span>
<span style="color:green;"></span>		<span style="color:green;">if (sipStack==null) return;</span><span style="background-color:red;">     </span>
<span style="color:green;"></span>		<span style="color:green;">this.presenceServer.stop();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">Iterator sipProviders=sipStack.getSipProviders();</span>
<span style="color:green;"></span>		<span style="color:green;">if (sipProviders!=null) {</span>
<span style="color:green;"></span>			<span style="color:green;">while( sipProviders.hasNext()) {</span>
<span style="color:green;"></span>				<span style="color:green;">SipProvider sp=(SipProvider)sipProviders.next();</span><span style="background-color:red;">                    </span>
<span style="color:green;"></span>				<span style="color:green;">sp.removeSipListener(this);</span>
<span style="color:green;"></span>				<span style="color:green;">sipStack.deleteSipProvider(sp);</span>
<span style="color:green;"></span>				<span style="color:green;">sipProviders=sipStack.getSipProviders();</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;One sip Provider removed!&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; has no sip Provider to remove!&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">Iterator listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:green;"></span>		<span style="color:green;">if (listeningPoints!=null) {</span>
<span style="color:green;"></span>			<span style="color:green;">while( listeningPoints.hasNext()) {</span>
<span style="color:green;"></span>				<span style="color:green;">ListeningPoint lp=(ListeningPoint)listeningPoints.next();</span>
<span style="color:green;"></span>				<span style="color:green;">sipStack.deleteListeningPoint(lp);</span>
<span style="color:green;"></span>				<span style="color:green;">listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;One listening point removed!&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; has no listening points to remove!&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span><span style="background-color:red;">        </span>
<span style="color:green;"></span>		<span style="color:green;">registrar.clean();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** Exit the proxy,</span>
<span style="color:green;"></span>	<span style="color:green;"> * throws Exception that which can be caught by the upper application</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public void exit()  throws Exception {</span>
<span style="color:green;"></span>		<span style="color:green;">Iterator sipProviders=sipStack.getSipProviders();</span>
<span style="color:green;"></span>		<span style="color:green;">if (sipProviders!=null) {</span>
<span style="color:green;"></span>			<span style="color:green;">while( sipProviders.hasNext()) {</span>
<span style="color:green;"></span>				<span style="color:green;">SipProvider sp=(SipProvider)sipProviders.next();</span><span style="background-color:red;">                    </span>
<span style="color:green;"></span>				<span style="color:green;">sp.removeSipListener(this);</span>
<span style="color:green;"></span>				<span style="color:green;">sipStack.deleteSipProvider(sp);</span>
<span style="color:green;"></span>				<span style="color:green;">sipProviders=sipStack.getSipProviders();</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;One sip Provider removed!&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; has no sip Provider to remove!&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">Iterator listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:green;"></span>		<span style="color:green;">if (listeningPoints!=null) {</span>
<span style="color:green;"></span>			<span style="color:green;">while( listeningPoints.hasNext()) {</span>
<span style="color:green;"></span>				<span style="color:green;">ListeningPoint lp=(ListeningPoint)listeningPoints.next();</span>
<span style="color:green;"></span>				<span style="color:green;">sipStack.deleteListeningPoint(lp);</span>
<span style="color:green;"></span>				<span style="color:green;">listeningPoints=sipStack.getListeningPoints();</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;One listening point removed!&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else {</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;WARNING, STOP_PROXY, The proxy &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; has no listening points to remove!&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span><span style="background-color:red;">        </span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Proxy exit.........................&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">configuration.listeningPoints.clear();</span>
<span style="color:green;"></span>		<span style="color:green;">registrar.clean();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public ViaHeader getStackViaHeader() {</span>
<span style="color:green;"></span>		<span style="color:green;">try {</span>
<span style="color:green;"></span>			<span style="color:green;">ListeningPoint lp =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">(ListeningPoint)sipStack.getListeningPoints().next();</span>
<span style="color:green;"></span>			<span style="color:green;">String host = sipStack.getIPAddress();</span>
<span style="color:green;"></span>			<span style="color:green;">int port = lp.getPort();</span>
<span style="color:green;"></span>			<span style="color:green;">String transport = lp.getTransport();</span>
<span style="color:green;"></span>			<span style="color:green;">// branch id is assigned by the transaction layer.</span>
<span style="color:green;"></span>			<span style="color:green;">return  headerFactory.createViaHeader</span>
<span style="color:green;"></span>					<span style="color:green;">(host,port,transport,null);</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public ContactHeader getStackContactHeader() {</span>
<span style="color:green;"></span>		<span style="color:green;">try {</span>
<span style="color:green;"></span>			<span style="color:green;">ListeningPoint lp =</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">(ListeningPoint)sipStack.getListeningPoints().next();</span>
<span style="color:green;"></span>			<span style="color:green;">String host = sipStack.getIPAddress();</span>
<span style="color:green;"></span>			<span style="color:green;">int port = lp.getPort();</span>
<span style="color:green;"></span>			<span style="color:green;">String transport = lp.getTransport();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">SipURI sipURI=addressFactory.createSipURI(null,host);</span>
<span style="color:green;"></span>			<span style="color:green;">sipURI.setPort(port);</span>
<span style="color:green;"></span>			<span style="color:green;">sipURI.setTransportParam(transport);</span>
<span style="color:green;"></span>			<span style="color:green;">Address contactAddress=addressFactory.createAddress(sipURI);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">return headerFactory.createContactHeader(contactAddress);</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/*************************************************************************/</span>
<span style="color:green;"></span>	<span style="color:green;">/************ The main method: to launch the proxy          *************/</span>
<span style="color:green;"></span>	<span style="color:green;">/************************************************************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public static void main(String args[]) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">// the Proxy:</span>
<span style="color:green;"></span>			<span style="color:green;">if (args.length == 0)  {</span>
<span style="color:green;"></span>				<span style="color:green;">System.out.println(&quot;Config file missing!&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">System.exit(0);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">System.out.println(&quot;Using configuration file &quot; + args[1]);</span>
<span style="color:green;"></span>			<span style="color:green;">String confFile= (String) args[1];</span>
<span style="color:green;"></span>			<span style="color:green;">Proxy proxy=new Proxy(confFile);</span>
<span style="color:green;"></span>			<span style="color:green;">proxy.start();</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Proxy ready to work&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">System.out.println</span>
<span style="color:green;"></span>			<span style="color:green;">(&quot;ERROR: Set the configuration file flag: &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot;USE: -cf configuration_file_location.xml&quot;  );</span>
<span style="color:green;"></span>			<span style="color:green;">System.out.println(&quot;ERROR, the proxy can not be started, &quot; +</span>
<span style="color:green;"></span>					<span style="color:green;">&quot; exception raised:\n&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
}

<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/gui/ListenerProxy.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ ListenerProxy.java:9 @</span><span style="font-weight:bold;text-decoration:blink;"> import javax.swing.*;</span>
import java.awt.*;
import java.awt.event.*;
import java.net.*;
<span style="color:green;"></span><span style="color:green;">import java.rmi.RemoteException;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
import gov.nist.sip.proxy.*;
import gov.nist.sip.proxy.Proxy;
import tools.tracesviewer.*;
<span style="color:teal;">@ ListenerProxy.java:25 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ListenerProxy {</span>
   
    protected Process rmiregistryProcess;
    protected TracesViewer tracesViewer;
<span style="color:green;"></span><span style="color:green;">    protected String xmlRegistrationsFile;</span>
    
    public boolean isProxyStarted() {
        return PROXY_STARTED;
    }
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
    
<span style="color:green;"></span><span style="color:green;">    public static void writeFile(String outFile, String text) {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">System.out.println(&quot;writeFile: [entry]&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">// we read this file to obtain the options</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">FileWriter fileWriter = new FileWriter(outFile,false);</span>
<span style="color:green;"></span>			<span style="color:green;">PrintWriter pw = new PrintWriter(fileWriter,true);</span>
<span style="color:green;"></span>			<span style="color:green;">//System.out.println(text);</span>
<span style="color:green;"></span>			<span style="color:green;">if (text==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println();</span>
<span style="color:green;"></span>				<span style="color:green;">//System.out.println(&quot;null&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else</span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println(text);</span>
<span style="color:green;"></span>				<span style="color:green;">//System.out.println(text);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">pw.close();</span>
<span style="color:green;"></span>			<span style="color:green;">fileWriter.close();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">System.out.println(&quot;writeFile: [exit]&quot;);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">    public void writeXMLRegistrations() {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">System.out.println(&quot;writeXMLRegistrations: [entry]&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">String registrationsTags=registrationsTable.getXMLTags();</span>
<span style="color:green;"></span>		<span style="color:green;">//System.out.println(registrationsTags);</span>
<span style="color:green;"></span>		<span style="color:green;">writeFile(xmlRegistrationsFile,registrationsTags);</span>
<span style="color:green;"></span>		<span style="color:green;">System.out.println(&quot;writeXMLRegistrations: [exit]&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">System.out.println(&quot;OK&quot;);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
    
    public ListenerProxy(ProxyLauncher proxyLauncher) {
        this.proxyLauncher=proxyLauncher;
<span style="color:teal;">@ ListenerProxy.java:73 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ListenerProxy {</span>
        try{
            configurationFrame=new ConfigurationFrame(proxyLauncher,&quot;Configuration&quot;);
            helpBox=new HelpBox();
<span style="color:red;">            </span>
<span style="color:green;"></span><span style="color:green;">            xmlRegistrationsFile = proxyLauncher.getProxy().getConfiguration().registrationsFile;</span>
            // First, we have to start a registry for logging the traces
            //startRMIregistry();
            
<span style="color:teal;">@ ListenerProxy.java:83 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ListenerProxy {</span>
        }
    }
    
<span style="color:red;">   </span>
<span style="color:green;"></span>	<span style="color:green;">public  RegistrationsTable registrationsTable;</span><span style="background-color:red;">  </span>
    
    public void configurationActionPerformed(ActionEvent em){
        try{
<span style="color:teal;">@ ListenerProxy.java:181 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ListenerProxy {</span>
        }
    }
    
<span style="color:green;"></span><span style="color:green;">    public void statusActionPerformed(ActionEvent ev) {</span>
<span style="color:green;"></span><span style="color:green;">        try{</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">Proxy proxy=proxyLauncher.getProxy();</span>
<span style="color:green;"></span><span style="color:green;">            Registrar registrar=proxy.getRegistrar();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">            if (registrar!=null) {</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">ProxyDebug.println(&quot;DEBUG, GUI chained to the registrar&quot;);</span>
<span style="color:green;"></span><span style="color:green;">                registrar.setRegistrationsList(proxyLauncher.registrationsList);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            String s = proxyLauncher.registrationsList.getSelectedValue().toString();</span>
<span style="color:green;"></span><span style="color:green;">            //System.out.println(s);</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>
<span style="color:green;"></span><span style="color:green;">            registrationsTable=registrar.getRegistrationsTable();</span>
<span style="color:green;"></span><span style="color:green;">            Iterator iterator=registrationsTable.getRegistrations().keySet().iterator();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">            while (iterator!=null &amp;&amp; iterator.hasNext()) {</span><span style="background-color:red;">            	</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph here] Vertexes Done!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">Registration registration=(Registration)registrationsTable.getRegistrations().get(iterator.next());</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] Got Registration! &quot;+registration.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">String contact = registration.getKey();</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] Vertex To add! &quot;+vertexToAdd);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">String[] parts = s.split(&quot; &quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">//System.out.println(parts[0]);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">String c = parts[0]+&quot;&quot;;</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">System.out.println(c);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">System.out.println(contact);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">if(contact.equals(c)){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>				<span style="color:green;">System.out.println(c);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>				<span style="color:green;">if((registration.getuserCategory()).equals(&quot;Normal&quot;)){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">System.out.println(&quot;in&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">proxyLauncher.registrationsList.updateRegistration(registration, true);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">registration.setuserCategory(&quot;Premium&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">//System.out.println(s);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">System.out.println(registration.getuserCategory());</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">proxyLauncher.registrationsList.updateRegistration(registration, false);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>				<span style="color:green;">else{</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">proxyLauncher.registrationsList.updateRegistration(registration, true);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">registration.setuserCategory(&quot;Normal&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>					<span style="color:green;">proxyLauncher.registrationsList.updateRegistration(registration, false);</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="color:green;">                //System.out.println(registration.getXMLTags());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="color:green;">            this.writeXMLRegistrations();</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="color:green;">        catch(Exception e) {</span>
<span style="color:green;"></span><span style="color:green;">           ProxyDebug.println(&quot;ERROR trying to change the status, exception raised:&quot;+e.getMessage());</span>
<span style="color:green;"></span><span style="color:green;">           //e.printStackTrace();</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
  
    public void stopProxy() {
        try{
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/gui/ProxyLauncher.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ ProxyLauncher.java:66 @</span><span style="font-weight:bold;text-decoration:blink;"> public class ProxyLauncher extends JFrame{</span>
    protected JPanel secondPanel;
    protected JPanel thirdPanel;
    protected JPanel fourthPanel;
<span style="color:green;"></span><span style="color:green;">    protected JPanel fifthPanel;</span>
    
    protected JButton proxyButton;
<span style="color:green;"></span><span style="color:green;">    protected JButton statusButton;</span>
    protected JButton traceViewerButton;
    
    protected RegistrationsList registrationsList;
<span style="color:teal;">@ ProxyLauncher.java:150 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ProxyLauncher extends JFrame{</span>
/*******************************************************************************/
/*******************************************************************************/
/*******************************************************************************/
<span style="color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">     </span>
    
    public void initComponents() {
        /********************** The main container ****************************/
<span style="color:teal;">@ ProxyLauncher.java:288 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class ProxyLauncher extends JFrame{</span>
          }
        );
        
<span style="color:green;"></span><span style="color:green;">        fifthPanel=new JPanel();</span>
<span style="color:green;"></span><span style="color:green;">        fifthPanel.setOpaque(false);</span>
<span style="color:green;"></span><span style="color:green;">        fifthPanel.setBorder(BorderFactory.createEmptyBorder(5,20,10,20));</span>
<span style="color:green;"></span><span style="color:green;">        container.add(fifthPanel);</span>
<span style="color:green;"></span><span style="color:green;">        // row, column, gap, gap</span>
<span style="color:green;"></span><span style="color:green;">        fifthPanel.setLayout( new GridLayout(1,2,5,5) );</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        statusButton=new JButton(&quot;Change Status: Normal/Premium&quot;);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setToolTipText(&quot;Please, start/stop the proxy!!!&quot;);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setFont(new Font (&quot;Dialog&quot;, 1, 14));</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setFocusPainted(false);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setBackground(buttonBackGroundColor);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setBorder(buttonBorder);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setVerticalAlignment(AbstractButton.CENTER);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.setHorizontalAlignment(AbstractButton.CENTER);</span>
<span style="color:green;"></span><span style="color:green;">        fifthPanel.add(statusButton);</span>
<span style="color:green;"></span><span style="color:green;">        statusButton.addActionListener(new ActionListener() {</span>
<span style="color:green;"></span><span style="color:green;">            public void actionPerformed(ActionEvent evt) {</span>
<span style="color:green;"></span><span style="color:green;">                  listenerProxy.statusActionPerformed(evt);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">          }</span>
<span style="color:green;"></span><span style="color:green;">        );</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
        traceViewerButton=new JButton(&quot;View the traces&quot;);
        traceViewerButton.setToolTipText(&quot;The traces are waiting for you!!!&quot;);
        traceViewerButton.setFont(new Font (&quot;Dialog&quot;, 1, 14));
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/gui/RegistrationsList.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ RegistrationsList.java:45 @</span><span style="font-weight:bold;text-decoration:blink;"> public class RegistrationsList extends JList {</span>
            if (registrationsTable !=null) {
                Hashtable r=registrationsTable.getRegistrations();
                if (r==null || r.size()==0) {
<span style="color:red;font-weight:bold;">                </span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">list.addElement(&quot;(empty)&quot;);</span>
<span style="color:red;font-weight:bold;">                </span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">return;</span>
<span style="color:green;font-weight:bold;">                </span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">list.addElement(&quot;(empty)&quot;);</span>
<span style="color:green;font-weight:bold;">                </span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">return;</span>
                }
                Enumeration e=r.keys();
                while (e.hasMoreElements()) {
<span style="color:red;font-weight:bold;">                </span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">String key=(String)e.nextElement();</span>
<span style="color:red;font-weight:bold;">                </span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">list.addElement(key);</span>
<span style="color:green;font-weight:bold;">                </span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">String key=(String)e.nextElement();</span>
<span style="color:green;font-weight:bold;">                </span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">list.addElement(key);</span>
                }
            }
            else list.addElement(&quot;(empty)&quot;);
<span style="color:teal;">@ RegistrationsList.java:63 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class RegistrationsList extends JList {</span>
    public  void updateRegistration(Registration registration,boolean toRemove) {
   
        if (registration!=null ) {
<span style="color:red;font-weight:bold;">            String  key=registration.getKey()</span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">; // key==&quot;sip:user@domain&quot;</span>
<span style="color:green;font-weight:bold;">            String  key=registration.getKey()</span><span style="color:green;font-weight:bold;text-decoration:blink;">+&quot; &quot;+registration.getuserCategory()</span><span style="color:green;font-weight:bold;">; // key==&quot;sip:user@domain&quot;</span>
	    boolean inList=list.contains(key);

	    
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/presenceserver/PresenceServer.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ PresenceServer.java:151 @</span><span style="font-weight:bold;text-decoration:blink;"> public class PresenceServer {</span>
        &quot;\n   Key=&quot;+registration.getKey() +
        &quot;\n   DisplayName=&quot;+registration.getDisplayName() +
        &quot;\n   Contacts=&quot;+registration.getContactsList().toString());
<span style="color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        if(registration.getForwardToUser() != null){</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">ProxyDebug.println(&quot;\n   Forward To =&quot;+registration.getForwardToUser().toString());</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="color:green;">        if(registration.getBlockedUsersList() != null){</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">ProxyDebug.println(&quot;\n   Blocked User List = &quot; + registration.getBlockedUsersList().toString());</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
	
        presentityManager.processRegister(registration.getKey(),Integer.MAX_VALUE);
    }
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/registrar/Registrar.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ Registrar.java:22 @</span><span style="font-weight:bold;text-decoration:blink;"> import javax.sip.header.*;</span>
import javax.sip.address.*;
import java.util.*;
import java.net.URLEncoder;
<span style="color:green;"></span><span style="color:green;">import gov.nist.sip.proxy.Chargement;</span>
import gov.nist.sip.proxy.presenceserver.*;
import gov.nist.sip.proxy.gui.*;
<span style="color:green;"></span><span style="color:green;">import org.jgraph.JGraph;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgraph.graph.DefaultEdge;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.DirectedGraph;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.ListenableGraph;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.alg.CycleDetector;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.ext.JGraphModelAdapter;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.graph.DefaultDirectedGraph;</span>
<span style="color:green;"></span><span style="color:green;">import org.jgrapht.graph.ListenableDirectedGraph;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
//ifdef SIMULATION
/*
import sim.java.net.*;
//endif
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">*/</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;"> </span><span style="color:green;font-weight:bold;">*/</span>


/**
<span style="color:teal;">@ Registrar.java:54 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> extends UnicastRemoteObject</span>
//
implements RegistrarAccess {

<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    protected</span><span style="color:red;font-weight:bold;">  RegistrationsTable registrationsTable;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">protected  RegistrationsList gui;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">protected  Proxy proxy;</span>
<span style="color:red;">   </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">// in seconds</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">public static int EXPIRES_TIME_MIN=1;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">public static int EXPIRES_TIME_MAX=3600;</span>
<span style="color:red;">    </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">protected String xmlRegistrationsFile;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">protected Vector threads;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">/**</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;"> *  Creates new Registrar</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;"> */</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">public Registrar(Proxy proxy) throws RemoteException {</span>
<span style="color:red;font-weight:bold;">	</span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">this.proxy = proxy;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">        </span><span style="color:red;font-weight:bold;">registrationsTable=new RegistrationsTable(this);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;">    </span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">public void registerToProxies() {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">        </span><span style="color:red;font-weight:bold;">try{</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">Configuration configuration=proxy.getConfiguration();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">Vector proxyToRegisterWithList=configuration.proxyToRegisterWithList;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">            </span><span style="color:red;font-weight:bold;">if (proxyToRegisterWithList!=null) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">threads=new Vector();</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">if (ProxyDebug.debug) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">ProxyDebug.println</span>
<span style="color:red;font-weight:bold;">		</span><span style="color:red;font-weight:bold;text-decoration:blink;">    </span><span style="color:red;font-weight:bold;">(&quot;Registrar, registerToProxies(), we have to register to &quot;</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">+proxyToRegisterWithList.size()+&quot; proxies&quot;);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">}</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                </span><span style="color:red;font-weight:bold;">for( int i=0;i&lt;proxyToRegisterWithList.size();i++) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">Domain domain=</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">(Domain)proxyToRegisterWithList.elementAt(i);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                    </span><span style="color:red;font-weight:bold;">if (domain.hostName!=null) {</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;">                        </span><span style="color:red;font-weight:bold;">RegistrationDomainThread rr=</span>
<span style="color:red;font-weight:bold;">				</span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">new RegistrationDomainThread(proxy,domain);</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">//ifdef 		SIMULATION</span>
<span style="color:red;font-weight:bold;"></span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">/*</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	public</span><span style="color:green;font-weight:bold;">  RegistrationsTable registrationsTable;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">protected  RegistrationsList gui;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">protected  Proxy proxy;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">// in seconds</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">public static int EXPIRES_TIME_MIN=1;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">public static int EXPIRES_TIME_MAX=3600;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">protected String xmlRegistrationsFile;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">protected Vector threads;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">/**</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;"> *  Creates new Registrar</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;"> */</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">public Registrar(Proxy proxy) throws RemoteException {</span>
<span style="color:green;font-weight:bold;">	</span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">this.proxy = proxy;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">		</span><span style="color:green;font-weight:bold;">registrationsTable=new RegistrationsTable(this);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">	</span><span style="color:green;font-weight:bold;">public void registerToProxies() {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">		</span><span style="color:green;font-weight:bold;">try{</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">Configuration configuration=proxy.getConfiguration();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">Vector proxyToRegisterWithList=configuration.proxyToRegisterWithList;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">if (proxyToRegisterWithList!=null) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">threads=new Vector();</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">if (ProxyDebug.debug) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">ProxyDebug.println</span>
<span style="color:green;font-weight:bold;">		</span><span style="color:green;font-weight:bold;text-decoration:blink;">			</span><span style="color:green;font-weight:bold;">(&quot;Registrar, registerToProxies(), we have to register to &quot;</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">+proxyToRegisterWithList.size()+&quot; proxies&quot;);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">}</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">for( int i=0;i&lt;proxyToRegisterWithList.size();i++) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">Domain domain=</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">							</span><span style="color:green;font-weight:bold;">(Domain)proxyToRegisterWithList.elementAt(i);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">					</span><span style="color:green;font-weight:bold;">if (domain.hostName!=null) {</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">RegistrationDomainThread rr=</span>
<span style="color:green;font-weight:bold;">				</span><span style="color:green;font-weight:bold;text-decoration:blink;">				</span><span style="color:green;font-weight:bold;">new RegistrationDomainThread(proxy,domain);</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">//ifdef 		SIMULATION</span>
<span style="color:green;font-weight:bold;"></span><span style="color:green;font-weight:bold;text-decoration:blink;">						</span><span style="color:green;font-weight:bold;">/*</span>
                        new SimThread(rr).start();
//else
<span style="color:red;">*/</span>
<span style="color:red;">                        new Thread(rr).start();</span>
<span style="color:red;">//endif</span>
<span style="color:red;">//</span>
<span style="color:red;">                        threads.addElement(rr);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e) {</span>
<span style="color:red;">            if (ProxyDebug.debug)  {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">                (&quot;ERROR, Registrar, registerToProxies(), exception  raised:&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            e.printStackTrace();</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public void setRegistrationsList(RegistrationsList registrationsList) {</span>
<span style="color:red;">        this.gui=registrationsList;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public void parseXMLregistrations(String file) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            xmlRegistrationsFile=file;</span>
<span style="color:red;">       </span>
<span style="color:red;">            XMLRegistrationsParser xmlRegistrationsParser=new</span>
<span style="color:red;">		XMLRegistrationsParser(xmlRegistrationsFile,proxy);</span>
<span style="color:red;">            Registrations registrations=xmlRegistrationsParser.getRegistrations();</span>
<span style="color:red;">            if (registrations==null) return;</span>
<span style="color:red;">            Vector registrationList=registrations.registrationList;</span>
<span style="color:red;">            if (registrationList!=null) {</span>
<span style="color:red;">	        if (ProxyDebug.debug) {</span>
<span style="color:red;">		    ProxyDebug.println(&quot;Registrar, parseXMLregistrations(), Uploading of &quot;</span>
<span style="color:red;">				       +registrationList.size()+&quot; registrations&quot;);</span>
<span style="color:red;">		}</span>
<span style="color:red;">                for( int i=0;i&lt;registrationList.size();i++) {</span>
<span style="color:red;">                    Registration registration=</span>
<span style="color:red;">			(Registration)registrationList.elementAt(i);</span>
<span style="color:red;">                    registrationsTable.addRegistration(registration);</span>
<span style="color:red;">		    </span>
<span style="color:red;">		    //Henrik Leion: Add registrations to presenceServer </span>
<span style="color:red;">		    //  (Assuming we are PA for all of them).</span>
<span style="color:red;">		    PresenceServer presenceServer = proxy.getPresenceServer();</span>
<span style="color:red;">		    presenceServer.processUploadedRegistration(registration);</span>
<span style="color:red;">		    </span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">           </span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e) {</span>
<span style="color:red;">	   if (ProxyDebug.debug)  {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;ERROR, Registrar, Registrar(), exception  raised during&quot;+</span>
<span style="color:red;">                &quot; parsing of the static registrations:&quot;);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            e.printStackTrace();</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;"> </span>
<span style="color:red;">    public void clean() {</span>
<span style="color:red;">         if (threads==null) return;</span>
<span style="color:red;">         for( int i=0;i&lt;threads.size();i++) {</span>
<span style="color:red;">                RegistrationDomainThread rr=(RegistrationDomainThread)threads.elementAt(i);</span>
<span style="color:red;">                rr.STOP=true;</span>
<span style="color:red;">         }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">     public static void writeFile(String outFile, String text) {</span>
<span style="color:red;">        // we read this file to obtain the options</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            FileWriter fileWriter = new FileWriter(outFile,false);</span>
<span style="color:red;">            PrintWriter pw = new PrintWriter(fileWriter,true);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (text==null) {</span>
<span style="color:red;">                pw.println();</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else</span>
<span style="color:red;">            {</span>
<span style="color:red;">                 pw.println(text);</span>
<span style="color:red;">            }</span>
<span style="color:red;">           </span>
<span style="color:red;">            pw.close();</span>
<span style="color:red;">            fileWriter.close();</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e) {</span>
<span style="color:red;">            e.printStackTrace();</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">     public void setExpiresTime(int expiresTime) {</span>
<span style="color:red;">        EXPIRES_TIME_MAX=expiresTime;</span>
<span style="color:red;">     }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    public void writeXMLRegistrations() {</span>
<span style="color:red;">        String registrationsTags=registrationsTable.getXMLTags();</span>
<span style="color:red;">        writeFile(xmlRegistrationsFile,registrationsTags);</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    public RegistrationsTable getRegistrationsTable() {</span>
<span style="color:red;">        return registrationsTable;</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public Registration getRegistration(String key) {</span>
<span style="color:red;">	  return (Registration) registrationsTable.getRegistrations().get(key);</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">/****************************************************************************/</span>
<span style="color:red;">/*************************** RMI REGISTRY    ********************************/</span>
<span style="color:red;">    </span>
<span style="color:red;">    public String getRegistryXMLTags() throws RemoteException {</span>
<span style="color:red;">        return registrationsTable.getRegistryXMLTags();</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public synchronized Vector getRegistryBindings() throws RemoteException {</span>
<span style="color:red;">	return registrationsTable.getRegistryBindings();</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public synchronized int getRegistrySize() throws RemoteException {</span>
<span style="color:red;">	 return registrationsTable.getRegistrySize();</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    // Need to add more registry query functions here.</span>
<span style="color:red;">    public void initRMIBindings() {</span>
<span style="color:red;">	String name = null;</span>
<span style="color:red;">	try {</span>
<span style="color:red;">            Configuration configuration=proxy.getConfiguration();</span>
<span style="color:red;">            if (configuration.accessLogViaRMI) {</span>
<span style="color:red;">                SipStack sipStack=proxy.getSipStack();</span>
<span style="color:red;">                Iterator it  =sipStack.getListeningPoints();</span>
<span style="color:red;">                ListeningPoint lp = (ListeningPoint) it.next();</span>
<span style="color:red;">                String stackIPAddress = sipStack.getIPAddress();</span>
<span style="color:red;">                name = &quot;//&quot; + stackIPAddress + &quot;:&quot; + 0 +  &quot;/&quot; +</span>
<span style="color:red;">                sipStack.getStackName()</span>
<span style="color:red;">                + &quot;/&quot; + &quot;test.jainproxy.Registrar&quot;;</span>
<span style="color:red;">                if (ProxyDebug.debug)  {</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Exporting Registration Table &quot; + name);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                Naming.rebind(name,this);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else {</span>
<span style="color:red;">               if (ProxyDebug.debug)</span>
<span style="color:red;">                 ProxyDebug.println</span>
<span style="color:red;">                 (&quot;We don't export the registrations because RMI is disabled.&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        } </span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">                 (&quot;Problem trying to export the Registration Table: &quot; + name);</span>
<span style="color:red;">            }</span>
<span style="color:red;">	    ex.printStackTrace();</span>
<span style="color:red;">	}</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">/******************************************************************************/</span>
<span style="color:red;">/******************************************************************************/</span>
<span style="color:red;">        </span>
<span style="color:red;">    </span>
<span style="color:red;">    /** Process the register message: add, remove, update the bindings</span>
<span style="color:red;">     *  and manage also the expiration time.</span>
<span style="color:red;">     *  @param Request Register message to set</span>
<span style="color:red;">     *  @return int status code of the process of the Register.</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public</span>
<span style="color:red;">    synchronized void processRegister(Request request, SipProvider sipProvider,</span>
<span style="color:red;">    ServerTransaction serverTransaction ) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:red;">            </span>
<span style="color:red;">            String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            // Add the key if it is a new user:</span>
<span style="color:red;">            if (ProxyDebug.debug){</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">                (&quot;Registrar, processRegister(), key: \&quot;&quot;+key+&quot;\&quot;&quot;);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            if (key==null){</span>
<span style="color:red;">                if (ProxyDebug.debug) {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), key is null&quot;+</span>
<span style="color:red;">                    &quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                Response response=messageFactory.createResponse</span>
<span style="color:red;">                (Response.BAD_REQUEST,request);</span>
<span style="color:red;">                if (serverTransaction!=null)</span>
<span style="color:red;">                   serverTransaction.sendResponse(response);</span>
<span style="color:red;">                else sipProvider.sendResponse(response);</span>
<span style="color:red;">                return ;</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            // RFC 3261: 10.3:</span>
<span style="color:red;">            /*  6. The registrar checks whether the request contains the Contact</span>
<span style="color:green;"></span>						<span style="color:green;"> */</span>
<span style="color:green;"></span>						<span style="color:green;">new Thread(rr).start();</span>
<span style="color:green;"></span>						<span style="color:green;">//endif</span>
<span style="color:green;"></span>						<span style="color:green;">//</span>
<span style="color:green;"></span>						<span style="color:green;">threads.addElement(rr);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;ERROR, Registrar, registerToProxies(), exception  raised:&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void setRegistrationsList(RegistrationsList registrationsList) {</span>
<span style="color:green;"></span>		<span style="color:green;">this.gui=registrationsList;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void parseXMLregistrations(String file) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">xmlRegistrationsFile=file;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">XMLRegistrationsParser xmlRegistrationsParser=new</span>
<span style="color:green;"></span>					<span style="color:green;">XMLRegistrationsParser(xmlRegistrationsFile,proxy);</span>
<span style="color:green;"></span>			<span style="color:green;">Registrations registrations=xmlRegistrationsParser.getRegistrations();</span>
<span style="color:green;"></span>			<span style="color:green;">if (registrations==null) return;</span>
<span style="color:green;"></span>			<span style="color:green;">Vector registrationList=registrations.registrationList;</span>
<span style="color:green;"></span>			<span style="color:green;">if (registrationList!=null) {</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Registrar, parseXMLregistrations(), Uploading of &quot;</span>
<span style="color:green;"></span>							<span style="color:green;">+registrationList.size()+&quot; registrations&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">for( int i=0;i&lt;registrationList.size();i++) {</span>
<span style="color:green;"></span>					<span style="color:green;">Registration registration=</span>
<span style="color:green;"></span>							<span style="color:green;">(Registration)registrationList.elementAt(i);</span>
<span style="color:green;"></span>					<span style="color:green;">registrationsTable.addRegistration(registration);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">//Henrik Leion: Add registrations to presenceServer</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">//  (Assuming we are PA for all of them).</span>
<span style="color:green;"></span>					<span style="color:green;">PresenceServer presenceServer = proxy.getPresenceServer();</span>
<span style="color:green;"></span>					<span style="color:green;">presenceServer.processUploadedRegistration(registration);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">registrationsTable.printRegistrations();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;ERROR, Registrar, Registrar(), exception  raised during&quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot; parsing of the static registrations:&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void clean() {</span>
<span style="color:green;"></span>		<span style="color:green;">if (threads==null) return;</span>
<span style="color:green;"></span>		<span style="color:green;">for( int i=0;i&lt;threads.size();i++) {</span>
<span style="color:green;"></span>			<span style="color:green;">RegistrationDomainThread rr=(RegistrationDomainThread)threads.elementAt(i);</span>
<span style="color:green;"></span>			<span style="color:green;">rr.STOP=true;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public static void writeFile(String outFile, String text) {</span>
<span style="color:green;"></span>		<span style="color:green;">// we read this file to obtain the options</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">FileWriter fileWriter = new FileWriter(outFile,false);</span>
<span style="color:green;"></span>			<span style="color:green;">PrintWriter pw = new PrintWriter(fileWriter,true);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (text==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println();</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else</span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println(text);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">pw.close();</span>
<span style="color:green;"></span>			<span style="color:green;">fileWriter.close();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public static void appendFile(String outFile, String text) {</span>
<span style="color:green;"></span>		<span style="color:green;">// we read this file to obtain the options</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">FileWriter fileWriter = new FileWriter(outFile,true);</span>
<span style="color:green;"></span>			<span style="color:green;">PrintWriter pw = new PrintWriter(fileWriter,true);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (text==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println();</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else</span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>				<span style="color:green;">pw.println(text);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">pw.close();</span>
<span style="color:green;"></span>			<span style="color:green;">fileWriter.close();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Error in append file&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void setExpiresTime(int expiresTime) {</span>
<span style="color:green;"></span>		<span style="color:green;">EXPIRES_TIME_MAX=expiresTime;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public void writeXMLRegistrations() {</span>
<span style="color:green;"></span>		<span style="color:green;">String registrationsTags=registrationsTable.getXMLTags();</span>
<span style="color:green;"></span>		<span style="color:green;">writeFile(xmlRegistrationsFile,registrationsTags);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public RegistrationsTable getRegistrationsTable() {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Registration getRegistration(String key) {</span>
<span style="color:green;"></span>		<span style="color:green;">return (Registration) registrationsTable.getRegistrations().get(key);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/****************************************************************************/</span>
<span style="color:green;"></span>	<span style="color:green;">/*************************** RMI REGISTRY    ********************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public String getRegistryXMLTags() throws RemoteException {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable.getRegistryXMLTags();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized Vector getRegistryBindings() throws RemoteException {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable.getRegistryBindings();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized int getRegistrySize() throws RemoteException {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable.getRegistrySize();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">// Need to add more registry query functions here.</span>
<span style="color:green;"></span>	<span style="color:green;">public void initRMIBindings() {</span>
<span style="color:green;"></span>		<span style="color:green;">String name = null;</span>
<span style="color:green;"></span>		<span style="color:green;">try {</span>
<span style="color:green;"></span>			<span style="color:green;">Configuration configuration=proxy.getConfiguration();</span>
<span style="color:green;"></span>			<span style="color:green;">if (configuration.accessLogViaRMI) {</span>
<span style="color:green;"></span>				<span style="color:green;">SipStack sipStack=proxy.getSipStack();</span>
<span style="color:green;"></span>				<span style="color:green;">Iterator it  =sipStack.getListeningPoints();</span>
<span style="color:green;"></span>				<span style="color:green;">ListeningPoint lp = (ListeningPoint) it.next();</span>
<span style="color:green;"></span>				<span style="color:green;">String stackIPAddress = sipStack.getIPAddress();</span>
<span style="color:green;"></span>				<span style="color:green;">name = &quot;//&quot; + stackIPAddress + &quot;:&quot; + 0 +  &quot;/&quot; +</span>
<span style="color:green;"></span>						<span style="color:green;">sipStack.getStackName()</span>
<span style="color:green;"></span>				<span style="color:green;">+ &quot;/&quot; + &quot;test.jainproxy.Registrar&quot;;</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Exporting Registration Table &quot; + name);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Naming.rebind(name,this);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else {</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;We don't export the registrations because RMI is disabled.&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Problem trying to export the Registration Table: &quot; + name);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">ex.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/******************************************************************************/</span>
<span style="color:green;"></span>	<span style="color:green;">/******************************************************************************/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** Process the register message: add, remove, update the bindings</span>
<span style="color:green;"></span>	<span style="color:green;"> *  and manage also the expiration time.</span>
<span style="color:green;"></span>	<span style="color:green;"> *  @param Request Register message to set</span>
<span style="color:green;"></span>	<span style="color:green;"> *  @return int status code of the process of the Register.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public</span>
<span style="color:green;"></span>	<span style="color:green;">synchronized void processRegister(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction ) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Add the key if it is a new user:</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processRegister(), key: \&quot;&quot;+key+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">if (key==null){</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), key is null&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return ;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// RFC 3261: 10.3:</span>
<span style="color:green;"></span>			<span style="color:green;">/*  6. The registrar checks whether the request contains the Contact</span>
         header field.  If not, it skips to the last step.  If the
         Contact header field is present, the registrar checks if there
         is one Contact field value that contains the special value &quot;*&quot;
<span style="color:teal;">@ Registrar.java:334 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> implements RegistrarAccess {</span>
         remove the binding only if the CSeq in the request is higher
         than the value stored for that binding.  Otherwise, the update
         MUST be aborted and the request fails.
<span style="color:red;">            */</span>
<span style="color:red;">            </span>
<span style="color:red;">            if ( !hasContactHeaders(request) ) {</span>
<span style="color:red;">                Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:red;">                Response response=messageFactory.createResponse</span>
<span style="color:red;">                (Response.OK,request);</span>
<span style="color:red;">                if ( contactHeaders!=null ) {</span>
<span style="color:red;">                    for (int i = 0 ; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:red;">                        ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                        contactHeaders.elementAt(i);</span>
<span style="color:red;">                        response.addHeader(contact);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">              </span>
<span style="color:red;">                if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">                else sipProvider.sendResponse(response);</span>
<span style="color:red;">                if (ProxyDebug.debug) {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), response sent:&quot;+response.toString());</span>
<span style="color:red;">                }</span>
<span style="color:red;">                return;</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            </span>
<span style="color:red;">            // bug report by Alistair Coles</span>
<span style="color:red;">            if ( hasStar(request) ) {</span>
<span style="color:red;">                Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:red;">                if (contactHeaders.size()&gt;1) {</span>
<span style="color:red;">                    if (ProxyDebug.debug) {</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">                        (&quot;Registrar, processRegister(), more than one contact header&quot;+</span>
<span style="color:red;">                        &quot; is present at the same time as a wild card.&quot;+</span>
<span style="color:red;">                        &quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    Response response=messageFactory.createResponse</span>
<span style="color:red;">                    (Response.BAD_REQUEST,request);</span>
<span style="color:red;">                     if (serverTransaction!=null)</span>
<span style="color:red;">                        serverTransaction.sendResponse(response);</span>
<span style="color:red;">                    else sipProvider.sendResponse(response);</span>
<span style="color:red;">                    if (ProxyDebug.debug) {</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">                        (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                        ProxyDebug.print(response.toString());</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    return ;</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                if ( !hasExpiresZero(request) ) {</span>
<span style="color:red;">                    if (ProxyDebug.debug) {</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">                        (&quot;Registrar, processRegister(), expires time different from&quot;+</span>
<span style="color:red;">                        &quot; 0 with a wild card.&quot;+</span>
<span style="color:red;">                        &quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    Response response=messageFactory.createResponse</span>
<span style="color:red;">                    (Response.BAD_REQUEST,request);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    if (serverTransaction!=null)</span>
<span style="color:red;">                        serverTransaction.sendResponse(response);</span>
<span style="color:red;">                    else sipProvider.sendResponse(response); </span>
<span style="color:red;">                    if (ProxyDebug.debug) {</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">                        (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                        ProxyDebug.print(response.toString());</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    return ;</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                if (ProxyDebug.debug) {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), (* and expires=0) &quot;+</span>
<span style="color:red;">                    &quot; we remove the registration!!&quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                registrationsTable.removeRegistration(key);</span>
<span style="color:red;">                </span>
<span style="color:red;">                Response response=messageFactory.createResponse</span>
<span style="color:red;">                (Response.OK,request);</span>
<span style="color:red;">                </span>
<span style="color:red;">                if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">                else sipProvider.sendResponse(response); </span>
<span style="color:red;">                    </span>
<span style="color:red;">                if (ProxyDebug.debug) {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                    ProxyDebug.print(response.toString());</span>
<span style="color:red;">                }</span>
<span style="color:red;">                return;</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            </span>
<span style="color:red;">            if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:red;">                registrationsTable.updateRegistration(key,request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		if (  proxy.getConfiguration().rfc2543Compatible &amp;&amp; </span>
<span style="color:red;">		key.indexOf(&quot;:5060&quot;) &lt; 0 ) {</span>
<span style="color:red;">		    //</span>
<span style="color:red;">		    // Hack for Cisco IP Phone which registers incorrectly</span>
<span style="color:red;">		    // by not specifying :5060.</span>
<span style="color:red;">		    //</span>
<span style="color:red;">		    key += &quot;:5060&quot;;</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		    System.out.println(&quot;CISCO IP PHONE FIX:  &quot;</span>
<span style="color:red;">			+ &quot;Updating proper registration for &quot; </span>
<span style="color:red;">			+ key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">                    registrationsTable.updateRegistration(key, request);</span>
<span style="color:red;">		}</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">                Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:red;">                Response response=</span>
<span style="color:red;">                messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if ( !hasContactHeaders(request) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.OK,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if ( contactHeaders!=null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">for (int i = 0 ; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:green;"></span>						<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>								<span style="color:green;">contactHeaders.elementAt(i);</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(contact);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;+response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>				<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// bug report by Alistair Coles</span>
<span style="color:green;"></span>			<span style="color:green;">if ( hasStar(request) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:green;"></span>				<span style="color:green;">if (contactHeaders.size()&gt;1) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), more than one contact header&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; is present at the same time as a wild card.&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>							<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">return ;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if ( !hasExpiresZero(request) ) {</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), expires time different from&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; 0 with a wild card.&quot;+</span>
<span style="color:green;"></span>								<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>							<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">return ;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), (* and expires=0) &quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; we remove the registration!!&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">registrationsTable.removeRegistration(key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.OK,request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">/*</span>
<span style="color:green;"></span>			<span style="color:green;"> * 29-1-2017</span>
<span style="color:green;"></span>			<span style="color:green;"> * Check if the username and password matches to a current registration</span>
<span style="color:green;"></span>			<span style="color:green;"> * If he username is the same and the passsword is not equal then we send</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>			<span style="color:green;"> * BAD Responese to the sender</span>
<span style="color:green;"></span>			<span style="color:green;"> */</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">String content = new String( request.getRawContent());</span>
<span style="color:green;"></span>			<span style="color:green;">String pass = content;</span>
<span style="color:green;"></span>			<span style="color:green;">String username = getKey(request);</span>
<span style="color:green;"></span><span style="background-color:red;">						</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;User: &quot;+username+&quot; Content of request: &quot;+pass + &quot; me tou kwsta ta skoulikia: &quot; + content);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">try{</span>
<span style="color:green;"></span>				<span style="color:green;">pass = content.split(&quot;Password:&quot;)[1];</span>
<span style="color:green;"></span>				<span style="color:green;">pass = pass.replace(&quot;\n&quot;,&quot;&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>				<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Could not get proper password for User: &quot;+username);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;User: &quot;+username+&quot; trying to connect with password: &quot;+pass);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">Hashtable registrations = registrationsTable.getRegistrations();</span>
<span style="color:green;"></span>				<span style="color:green;">Registration registration=(Registration) registrations.get(username);</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Given Password: &quot;+pass+&quot; Saved Password: &quot;+registration.getPassword());</span>
<span style="color:green;"></span>				<span style="color:green;">if (!registration.getPassword().equals(pass)){</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">// username same and password not the same :(</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), username same and password not the same!&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>							<span style="color:green;">(Response.UNAUTHORIZED,request);</span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), UNAUTHORIZED response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">return ;</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">registrationsTable.updateRegistration(key,request);</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>				<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (  proxy.getConfiguration().rfc2543Compatible &amp;&amp;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>						<span style="color:green;">key.indexOf(&quot;:5060&quot;) &lt; 0 ) {</span>
<span style="color:green;"></span>					<span style="color:green;">//</span>
<span style="color:green;"></span>					<span style="color:green;">// Hack for Cisco IP Phone which registers incorrectly</span>
<span style="color:green;"></span>					<span style="color:green;">// by not specifying :5060.</span>
<span style="color:green;"></span>					<span style="color:green;">//</span>
<span style="color:green;"></span>					<span style="color:green;">key += &quot;:5060&quot;;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">System.out.println(&quot;CISCO IP PHONE FIX:  &quot;</span>
<span style="color:green;"></span>							<span style="color:green;">+ &quot;Updating proper registration for &quot;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>							<span style="color:green;">+ key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">registrationsTable.updateRegistration(key, request);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=</span>
<span style="color:green;"></span>						<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span>				<span style="color:green;">try{</span>
<span style="color:green;"></span>					<span style="color:green;">if ( hasExpiresZero(request) ) {</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(request.getHeader(ExpiresHeader.NAME));</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>					<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">if ( contactHeaders!=null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">for (int i = 0; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:green;"></span>						<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>								<span style="color:green;">contactHeaders.elementAt(i);</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(contact);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else {</span>
<span style="color:green;"></span>				<span style="color:green;">// Let's check the Expires header:</span>
<span style="color:green;"></span>				<span style="color:green;">if ( hasExpiresZero(request) ) {</span>
<span style="color:green;"></span>					<span style="color:green;">// This message is lost....</span>
<span style="color:green;"></span>					<span style="color:green;">proxy.getPresenceServer();</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Registrar, processRegister(), &quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot;we don't have any record for this REGISTER.&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>							<span style="color:green;">(Response.OK,request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">registrationsTable.addRegistration(key,request);</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>				<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (proxy.getConfiguration().rfc2543Compatible &amp;&amp;</span>
<span style="color:green;"></span>						<span style="color:green;">key.indexOf(&quot;:5060&quot;) &lt; 0) {</span>
<span style="color:green;"></span>					<span style="color:green;">//</span>
<span style="color:green;"></span>					<span style="color:green;">// Hack for Cisco IP Phone which registers incorrectly</span>
<span style="color:green;"></span>					<span style="color:green;">// by not specifying :5060.</span>
<span style="color:green;"></span>					<span style="color:green;">//</span>
<span style="color:green;"></span>					<span style="color:green;">key += &quot;:5060&quot;;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">System.out.println(&quot;CISCO IP PHONE FIX:  &quot;</span>
<span style="color:green;"></span>							<span style="color:green;">+ &quot;adding proper registration for &quot; + key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">registrationsTable.addRegistration(key, request);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>					<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">// we have to forward SUBSCRIBE if the presence server</span>
<span style="color:green;"></span>				<span style="color:green;">// is enabled:</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (proxy.isPresenceServer()) {</span>
<span style="color:green;"></span>					<span style="color:green;">PresenceServer presenceServer=</span>
<span style="color:green;"></span>							<span style="color:green;">proxy.getPresenceServer();</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;Registrar, processRegister(), &quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot;  we have to check if we have some SUBSCRIBE stored.&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=</span>
<span style="color:green;"></span>						<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if ( contactHeaders!=null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">for (int i = 0; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:green;"></span>						<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>								<span style="color:green;">contactHeaders.elementAt(i);</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(contact);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}  catch (IOException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processRegister(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public static URI getCleanUri(URI uri) {</span>
<span style="color:green;"></span>		<span style="color:green;">if (uri instanceof SipURI) {</span>
<span style="color:green;"></span>			<span style="color:green;">SipURI sipURI=(SipURI)uri.clone();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">Iterator iterator=sipURI.getParameterNames();</span>
<span style="color:green;"></span>			<span style="color:green;">while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:green;"></span>				<span style="color:green;">String name=(String)iterator.next();</span>
<span style="color:green;"></span>				<span style="color:green;">sipURI.removeParameter(name);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return  sipURI;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">else return  uri;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">/** The key is built following this rule:</span>
<span style="color:green;"></span>	<span style="color:green;"> * The registrar extracts the address-of-record from the To header</span>
<span style="color:green;"></span>	<span style="color:green;"> * field of the request. The URI</span>
<span style="color:green;"></span>	<span style="color:green;"> * MUST then be converted to a canonical form.  To do that, all</span>
<span style="color:green;"></span>	<span style="color:green;"> * URI parameters MUST be removed (including the user-param), and</span>
<span style="color:green;"></span>	<span style="color:green;"> * any escaped characters MUST be converted to their unescaped</span>
<span style="color:green;"></span>	<span style="color:green;"> * form.  The result serves as an index into the list of bindings</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public String getKey(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">// Let's see if we already have a binding for this request:</span>
		try{
<span style="color:red;">                    if ( hasExpiresZero(request) ) {</span>
<span style="color:red;">                         response.addHeader(request.getHeader(ExpiresHeader.NAME));</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">                catch(Exception e){</span>
<span style="color:red;">                    e.printStackTrace();</span>
<span style="color:red;">                }</span>
<span style="color:red;">                if ( contactHeaders!=null ) {</span>
<span style="color:red;">                    for (int i = 0; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:red;">                        ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                        contactHeaders.elementAt(i);</span>
<span style="color:red;">                        response.addHeader(contact);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">               </span>
<span style="color:red;">                 if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">                else sipProvider.sendResponse(response); </span>
<span style="color:red;">                 </span>
<span style="color:red;">                if (ProxyDebug.debug)  {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                    ProxyDebug.print(response.toString());</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else {</span>
<span style="color:red;">                // Let's check the Expires header:</span>
<span style="color:red;">                if ( hasExpiresZero(request) ) {</span>
<span style="color:red;">                    // This message is lost....</span>
<span style="color:red;">		    proxy.getPresenceServer();</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Registrar, processRegister(), &quot;+</span>
<span style="color:red;">                    &quot;we don't have any record for this REGISTER.&quot;);</span>
<span style="color:red;">                    Response response=messageFactory.createResponse</span>
<span style="color:red;">                    (Response.OK,request);</span>
<span style="color:red;">                    </span>
<span style="color:red;">                    if (serverTransaction!=null)</span>
<span style="color:red;">                        serverTransaction.sendResponse(response);</span>
<span style="color:red;">                    else sipProvider.sendResponse(response); </span>
<span style="color:red;">                    if (ProxyDebug.debug) {</span>
<span style="color:red;">                        ProxyDebug.println</span>
<span style="color:red;">                        (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                        ProxyDebug.print(response.toString());</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                    return;</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                registrationsTable.addRegistration(key,request);</span>
<span style="color:red;">                </span>
<span style="color:red;">		if (proxy.getConfiguration().rfc2543Compatible &amp;&amp;</span>
<span style="color:red;">		    key.indexOf(&quot;:5060&quot;) &lt; 0) {</span>
<span style="color:red;">		    //</span>
<span style="color:red;">		    // Hack for Cisco IP Phone which registers incorrectly</span>
<span style="color:red;">		    // by not specifying :5060.</span>
<span style="color:red;">		    //</span>
<span style="color:red;">		    key += &quot;:5060&quot;;</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">		    System.out.println(&quot;CISCO IP PHONE FIX:  &quot;</span>
<span style="color:red;">			+ &quot;adding proper registration for &quot; + key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">                    registrationsTable.addRegistration(key, request);</span>
<span style="color:red;">		}</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">                // we have to forward SUBSCRIBE if the presence server</span>
<span style="color:red;">                // is enabled:</span>
<span style="color:red;">                </span>
<span style="color:red;">                if (proxy.isPresenceServer()) {</span>
<span style="color:red;">                    PresenceServer presenceServer=</span>
<span style="color:red;">                    proxy.getPresenceServer();</span>
<span style="color:red;">                    ProxyDebug.println(&quot;Registrar, processRegister(), &quot;+</span>
<span style="color:red;">                    &quot;  we have to check if we have some SUBSCRIBE stored.&quot;);</span>
<span style="color:red;">                }</span>
<span style="color:red;">                </span>
<span style="color:red;">                Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:red;">                Response response=</span>
<span style="color:red;">                messageFactory.createResponse(Response.OK,request);</span>
<span style="color:red;">                if ( contactHeaders!=null ) {</span>
<span style="color:red;">                    for (int i = 0; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:red;">                        ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                        contactHeaders.elementAt(i);</span>
<span style="color:red;">                        response.addHeader(contact);</span>
<span style="color:red;">                    }</span>
<span style="color:red;">                }</span>
<span style="color:red;">               </span>
<span style="color:red;">                 if (serverTransaction!=null)</span>
<span style="color:red;">                    serverTransaction.sendResponse(response);</span>
<span style="color:red;">                 else sipProvider.sendResponse(response); </span>
<span style="color:red;">                 </span>
<span style="color:red;">                if (ProxyDebug.debug)  {</span>
<span style="color:red;">                    ProxyDebug.println</span>
<span style="color:red;">                    (&quot;Registrar, processRegister(), response sent:&quot;);</span>
<span style="color:red;">                    ProxyDebug.print(response.toString());</span>
<span style="color:red;">                }</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }  catch (IOException ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">	     }</span>
<span style="color:red;">	} catch (SipException ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">	     }</span>
<span style="color:red;">        } catch(Exception ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, processRegister(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public static URI getCleanUri(URI uri) {</span>
<span style="color:red;">        if (uri instanceof SipURI) {</span>
<span style="color:red;">            SipURI sipURI=(SipURI)uri.clone();</span>
<span style="color:red;">            </span>
<span style="color:red;">            Iterator iterator=sipURI.getParameterNames();</span>
<span style="color:red;">            while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:red;">                String name=(String)iterator.next();</span>
<span style="color:red;">                sipURI.removeParameter(name);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return  sipURI;</span>
<span style="color:red;">        }</span>
<span style="color:red;">        else return  uri;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    /** The key is built following this rule:</span>
<span style="color:red;">     * The registrar extracts the address-of-record from the To header</span>
<span style="color:red;">     * field of the request. The URI</span>
<span style="color:red;">     * MUST then be converted to a canonical form.  To do that, all</span>
<span style="color:red;">     * URI parameters MUST be removed (including the user-param), and</span>
<span style="color:red;">     * any escaped characters MUST be converted to their unescaped</span>
<span style="color:red;">     * form.  The result serves as an index into the list of bindings</span>
<span style="color:red;">     */</span>
<span style="color:red;">    public String getKey(Request request) {</span>
<span style="color:red;">        // Let's see if we already have a binding for this request:</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            ToHeader toHeader=(ToHeader)request.getHeader(ToHeader.NAME);</span>
<span style="color:red;">            Address address=null;</span>
<span style="color:red;">            address  = toHeader.getAddress();</span>
<span style="color:red;">           </span>
<span style="color:red;">            javax.sip.address.URI  cleanedUri;</span>
<span style="color:red;">            if (address==null) {</span>
<span style="color:red;">                cleanedUri= getCleanUri(request.getRequestURI());</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else {</span>
<span style="color:red;">                // We have to build the key, all</span>
<span style="color:red;">                // URI parameters MUST be removed:</span>
<span style="color:red;">                cleanedUri = getCleanUri(address.getURI());</span>
<span style="color:red;">            }</span>
<span style="color:red;">            String  keyresult=cleanedUri.toString();</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">            return keyresult.toLowerCase();</span>
<span style="color:red;">        } catch(Exception ex) {</span>
<span style="color:red;">	    if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return null;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public boolean hasRegistration(String key) {</span>
<span style="color:red;">        return registrationsTable.hasRegistration(key);</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public boolean hasDomainRegistered(Request request) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            URI uri=request.getRequestURI();</span>
<span style="color:red;">            URI cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (! (cleanedURI instanceof SipURI) ) return false;</span>
<span style="color:red;">                </span>
<span style="color:red;">            // We have to check the host part:</span>
<span style="color:red;">            String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:red;">            </span>
<span style="color:red;">            return hasRegistration(&quot;sip:&quot;+host );</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return false;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    public boolean hasDomainRegistered(URI uri) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            URI cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (! (cleanedURI instanceof SipURI) ) return false;</span>
<span style="color:red;">                </span>
<span style="color:red;">            // We have to check the host part:</span>
<span style="color:red;">            String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:red;">            </span>
<span style="color:red;">            return hasRegistration(&quot;sip:&quot;+host );</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return false;</span>
<span style="color:red;">        }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    </span>
<span style="color:red;">    public Vector getDomainContactsURI(Request request) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            URI uri=request.getRequestURI();</span>
<span style="color:red;">            URI cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (! (cleanedURI instanceof SipURI) ) return null;</span>
<span style="color:red;">                </span>
<span style="color:red;">            // We have to check the host part:</span>
<span style="color:red;">            String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:red;">            </span>
<span style="color:red;">            Vector contacts=getContactHeaders(&quot;sip:&quot;+ host );</span>
<span style="color:red;">            if (contacts==null) return null;</span>
<span style="color:red;">            Vector results=new Vector();</span>
<span style="color:red;">            for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:red;">                ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                    contacts.elementAt(i);</span>
<span style="color:red;">                Address address=contact.getAddress();</span>
<span style="color:red;">                uri=address.getURI();</span>
<span style="color:red;">                cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">                results.addElement(cleanedURI);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return results;</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">	   if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar, getDomainContacts(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return null;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">     </span>
<span style="color:red;">     </span>
<span style="color:red;">    public boolean hasRegistration(Request request)   {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            String key = getKey(request);</span>
<span style="color:red;">            return hasRegistration(key);</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">	    if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println(&quot;Registrar, hasRegistration(), internal error, &quot;+</span>
<span style="color:red;">                &quot;exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return false;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">     /*</span>
<span style="color:red;">      * The result is a list of URI that we kept from a registration related</span>
<span style="color:red;">      * to the ToHeader URI from this request.</span>
<span style="color:red;">      */</span>
<span style="color:red;">    public Vector getContactsURI(Request request) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            String key=getKey(request);</span>
<span style="color:red;">            Vector contacts=getContactHeaders(key);</span>
<span style="color:red;">            if (contacts==null) return null;</span>
<span style="color:red;">            Vector results=new Vector();</span>
<span style="color:red;">            for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:red;">                ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                    contacts.elementAt(i);</span>
<span style="color:red;">                Address address=contact.getAddress();</span>
<span style="color:red;">                URI uri=address.getURI();</span>
<span style="color:red;">                URI cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">                results.addElement(cleanedURI);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return results;</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">	    if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, getContactsURI(), internal error, exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            return null;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    /*</span>
<span style="color:red;">      * Matches a Sip URI &quot;sip:user@domain&quot; with a list of Contacts</span>
<span style="color:red;">      * @param key The sip URI found in the To-header of a request</span>
<span style="color:red;">      * @author Henrik Leion</span>
<span style="color:red;">      */</span>
<span style="color:red;">    public Vector getContactsURI(String key) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            Vector contacts=getContactHeaders(key);</span>
<span style="color:red;">            if (contacts==null) return null;</span>
<span style="color:red;">            Vector results=new Vector();</span>
<span style="color:red;">            for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:red;">                ContactHeader contact = (ContactHeader)</span>
<span style="color:red;">                    contacts.elementAt(i);</span>
<span style="color:red;">                Address address=contact.getAddress();</span>
<span style="color:red;">                URI uri=address.getURI();</span>
<span style="color:red;">                URI cleanedURI=getCleanUri(uri);</span>
<span style="color:red;">                results.addElement(cleanedURI);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            return results;</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch (Exception ex) {</span>
<span style="color:red;">	    if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, getContactsURI(), internal error, exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(ex);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            return null;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">     </span>
<span style="color:red;">    public boolean hasContactHeaders(Request request) {</span>
<span style="color:red;">         ListIterator list=(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:red;">         return list!=null;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    private boolean hasStar(Request request) throws Exception{</span>
<span style="color:red;">        ListIterator list=(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:red;">            </span>
<span style="color:red;">        if (list==null) return false;</span>
<span style="color:red;">        while( list.hasNext() ) {</span>
<span style="color:red;">             ContactHeader contactHeader=(ContactHeader)list.next();</span>
<span style="color:red;">             if (contactHeader.getAddress().isWildcard()  ) {</span>
<span style="color:red;">                 return true;</span>
<span style="color:red;">             }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        return false;</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    private boolean hasExpiresZero(Request request) {</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            ExpiresHeader expiresHeader=</span>
<span style="color:red;">		(ExpiresHeader)request.getHeader(ExpiresHeader.NAME);</span>
<span style="color:red;">            if (expiresHeader==null) {</span>
<span style="color:red;">                  ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, hasExpiresZero(), the REGISTER does not have an Expires Header&quot;);</span>
<span style="color:red;">                return false;</span>
<span style="color:red;">            }</span>
<span style="color:red;">            else</span>
<span style="color:red;">            {</span>
<span style="color:red;">                  ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, hasExpiresZero(), the REGISTER has an Expires Header with&quot;+</span>
<span style="color:red;">                &quot; expires time:&quot; +expiresHeader.getExpires());</span>
<span style="color:red;">                return expiresHeader.getExpires()==0;</span>
<span style="color:red;">            }</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e){</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, hasExpiresZero(), internal error, exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(e);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            return false;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    </span>
<span style="color:red;">    public Vector getContactHeaders(String key) {</span>
<span style="color:red;">        return registrationsTable.getContactHeaders(key);</span>
<span style="color:red;">    }</span>
<span style="color:red;">    </span>
<span style="color:red;">    public static Vector getContactHeaders(Request request){</span>
<span style="color:red;">        Vector contacts =new Vector();</span>
<span style="color:red;">        try{</span>
<span style="color:red;">            ListIterator list=</span>
<span style="color:red;">		(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:red;">            </span>
<span style="color:red;">            if (list==null) return contacts;</span>
<span style="color:red;">            while( list.hasNext() ) {</span>
<span style="color:red;">                ContactHeader contactHeader=(ContactHeader)list.next();</span>
<span style="color:red;">                contacts.addElement(contactHeader);</span>
<span style="color:red;">            }</span>
<span style="color:red;">            </span>
<span style="color:red;">            // We will sort out the contacts following the &quot;q&quot; parameter</span>
<span style="color:red;">            </span>
<span style="color:red;">            return contacts;</span>
<span style="color:red;">        }</span>
<span style="color:red;">        catch(Exception e){</span>
<span style="color:red;">            if (ProxyDebug.debug) {</span>
<span style="color:red;">                ProxyDebug.println</span>
<span style="color:red;">		(&quot;Registrar, getContactHeaders(), internal error, exception raised:&quot;);</span>
<span style="color:red;">                ProxyDebug.logException(e);</span>
<span style="color:red;">	    }</span>
<span style="color:red;">            return contacts;</span>
<span style="color:red;">        }</span>
<span style="color:red;">    }</span>
<span style="color:gray;background-color:black;"></span><span style="color:red;background-color:black;"> </span>
<span style="color:red;">    protected void printRegistrations(){</span>
<span style="color:red;">        registrationsTable.printRegistrations();</span>
<span style="color:red;">    }</span>
<span style="color:red;">   </span>
<span style="color:green;"></span>			<span style="color:green;">ToHeader toHeader=(ToHeader)request.getHeader(ToHeader.NAME);</span>
<span style="color:green;"></span>			<span style="color:green;">Address address=null;</span>
<span style="color:green;"></span>			<span style="color:green;">address  = toHeader.getAddress();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">javax.sip.address.URI  cleanedUri;</span>
<span style="color:green;"></span>			<span style="color:green;">if (address==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">cleanedUri= getCleanUri(request.getRequestURI());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else {</span>
<span style="color:green;"></span>				<span style="color:green;">// We have to build the key, all</span>
<span style="color:green;"></span>				<span style="color:green;">// URI parameters MUST be removed:</span>
<span style="color:green;"></span>				<span style="color:green;">cleanedUri = getCleanUri(address.getURI());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">String  keyresult=cleanedUri.toString();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">return keyresult.toLowerCase();</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean hasRegistration(String key) {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable.hasRegistration(key);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean hasDomainRegistered(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">URI uri=request.getRequestURI();</span>
<span style="color:green;"></span>			<span style="color:green;">URI cleanedURI=getCleanUri(uri);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (! (cleanedURI instanceof SipURI) ) return false;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We have to check the host part:</span>
<span style="color:green;"></span>				<span style="color:green;">String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">return hasRegistration(&quot;sip:&quot;+host );</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return false;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean hasDomainRegistered(URI uri) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">URI cleanedURI=getCleanUri(uri);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (! (cleanedURI instanceof SipURI) ) return false;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We have to check the host part:</span>
<span style="color:green;"></span>				<span style="color:green;">String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">return hasRegistration(&quot;sip:&quot;+host );</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar, hasDomainRegistered(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return false;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Vector getDomainContactsURI(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">URI uri=request.getRequestURI();</span>
<span style="color:green;"></span>			<span style="color:green;">URI cleanedURI=getCleanUri(uri);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (! (cleanedURI instanceof SipURI) ) return null;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We have to check the host part:</span>
<span style="color:green;"></span>				<span style="color:green;">String host=((SipURI)cleanedURI).getHost();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Vector contacts=getContactHeaders(&quot;sip:&quot;+ host );</span>
<span style="color:green;"></span>				<span style="color:green;">if (contacts==null) return null;</span>
<span style="color:green;"></span>				<span style="color:green;">Vector results=new Vector();</span>
<span style="color:green;"></span>				<span style="color:green;">for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:green;"></span>					<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>							<span style="color:green;">contacts.elementAt(i);</span>
<span style="color:green;"></span>					<span style="color:green;">Address address=contact.getAddress();</span>
<span style="color:green;"></span>					<span style="color:green;">uri=address.getURI();</span>
<span style="color:green;"></span>					<span style="color:green;">cleanedURI=getCleanUri(uri);</span>
<span style="color:green;"></span>					<span style="color:green;">results.addElement(cleanedURI);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">return results;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar, getDomainContacts(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean hasRegistration(Request request)   {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">String key = getKey(request);</span>
<span style="color:green;"></span>			<span style="color:green;">return hasRegistration(key);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar, hasRegistration(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return false;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * The result is a list of URI that we kept from a registration related</span>
<span style="color:green;"></span>	<span style="color:green;"> * to the ToHeader URI from this request.</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public Vector getContactsURI(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:green;"></span>			<span style="color:green;">Vector contacts=getContactHeaders(key);</span>
<span style="color:green;"></span>			<span style="color:green;">if (contacts==null) return null;</span>
<span style="color:green;"></span>			<span style="color:green;">Vector results=new Vector();</span>
<span style="color:green;"></span>			<span style="color:green;">for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:green;"></span>				<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>						<span style="color:green;">contacts.elementAt(i);</span>
<span style="color:green;"></span>				<span style="color:green;">Address address=contact.getAddress();</span>
<span style="color:green;"></span>				<span style="color:green;">URI uri=address.getURI();</span>
<span style="color:green;"></span>				<span style="color:green;">URI cleanedURI=getCleanUri(uri);</span>
<span style="color:green;"></span>				<span style="color:green;">results.addElement(cleanedURI);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return results;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, getContactsURI(), internal error, exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * Matches a Sip URI &quot;sip:user@domain&quot; with a list of Contacts</span>
<span style="color:green;"></span>	<span style="color:green;"> * @param key The sip URI found in the To-header of a request</span>
<span style="color:green;"></span>	<span style="color:green;"> * @author Henrik Leion</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public Vector getContactsURI(String key) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">Vector contacts=getContactHeaders(key);</span>
<span style="color:green;"></span>			<span style="color:green;">if (contacts==null) return null;</span>
<span style="color:green;"></span>			<span style="color:green;">Vector results=new Vector();</span>
<span style="color:green;"></span>			<span style="color:green;">for (int i=0;i&lt;contacts.size();i++) {</span>
<span style="color:green;"></span>				<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>						<span style="color:green;">contacts.elementAt(i);</span>
<span style="color:green;"></span>				<span style="color:green;">Address address=contact.getAddress();</span>
<span style="color:green;"></span>				<span style="color:green;">URI uri=address.getURI();</span>
<span style="color:green;"></span>				<span style="color:green;">URI cleanedURI=getCleanUri(uri);</span>
<span style="color:green;"></span>				<span style="color:green;">results.addElement(cleanedURI);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return results;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, getContactsURI(), internal error, exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return null;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public boolean hasContactHeaders(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">ListIterator list=(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:green;"></span>		<span style="color:green;">return list!=null;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">private boolean hasStar(Request request) throws Exception{</span>
<span style="color:green;"></span>		<span style="color:green;">ListIterator list=(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">if (list==null) return false;</span>
<span style="color:green;"></span>		<span style="color:green;">while( list.hasNext() ) {</span>
<span style="color:green;"></span>			<span style="color:green;">ContactHeader contactHeader=(ContactHeader)list.next();</span>
<span style="color:green;"></span>			<span style="color:green;">if (contactHeader.getAddress().isWildcard()  ) {</span>
<span style="color:green;"></span>				<span style="color:green;">return true;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">return false;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">private boolean hasExpiresZero(Request request) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">ExpiresHeader expiresHeader=</span>
<span style="color:green;"></span>					<span style="color:green;">(ExpiresHeader)request.getHeader(ExpiresHeader.NAME);</span>
<span style="color:green;"></span>			<span style="color:green;">if (expiresHeader==null) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, hasExpiresZero(), the REGISTER does not have an Expires Header&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">return false;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">else</span>
<span style="color:green;"></span>			<span style="color:green;">{</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, hasExpiresZero(), the REGISTER has an Expires Header with&quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot; expires time:&quot; +expiresHeader.getExpires());</span>
<span style="color:green;"></span>				<span style="color:green;">return expiresHeader.getExpires()==0;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, hasExpiresZero(), internal error, exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(e);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return false;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public Vector getContactHeaders(String key) {</span>
<span style="color:green;"></span>		<span style="color:green;">return registrationsTable.getContactHeaders(key);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public static Vector getContactHeaders(Request request){</span>
<span style="color:green;"></span>		<span style="color:green;">Vector contacts =new Vector();</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">ListIterator list=</span>
<span style="color:green;"></span>					<span style="color:green;">(ListIterator)request.getHeaders(ContactHeader.NAME);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (list==null) return contacts;</span>
<span style="color:green;"></span>			<span style="color:green;">while( list.hasNext() ) {</span>
<span style="color:green;"></span>				<span style="color:green;">ContactHeader contactHeader=(ContactHeader)list.next();</span>
<span style="color:green;"></span>				<span style="color:green;">contacts.addElement(contactHeader);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// We will sort out the contacts following the &quot;q&quot; parameter</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">return contacts;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, getContactHeaders(), internal error, exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(e);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return contacts;</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected void printRegistrations(){</span>
<span style="color:green;"></span>		<span style="color:green;">registrationsTable.printRegistrations();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * Add the response to the user who wants to perform forwarding 22-1-2017</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized void processUserInfo(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction, HeaderFactory headerFactory ) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Add the key if it is a new user:</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserInfo(), key: \&quot;&quot;+key+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">if (key==null){</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processUserInfo(), key is null&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return ;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:green;"></span>					<span style="color:green;">Hashtable registrations=registrationsTable.getRegistrations();</span>
<span style="color:green;"></span>			<span style="color:green;">        Registration registration=(Registration)registrations.get(key);</span>
<span style="color:green;"></span><span style="background-color:red;">			        </span>
<span style="color:green;"></span>					<span style="color:green;">//if we are here everything went as planned</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=</span>
<span style="color:green;"></span>							<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">ContentTypeHeader hbill = headerFactory.createContentTypeHeader(&quot;application&quot;, &quot;info&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">String textToSend = &quot;&quot;;</span>
<span style="color:green;"></span>					<span style="color:green;">if(registration.getForwardToUser()!= null)</span>
<span style="color:green;"></span>						<span style="color:green;">textToSend = &quot;Forward:&quot;+registration.getForwardToUser()+&quot;\n&quot;;</span>
<span style="color:green;"></span>					<span style="color:green;">else</span>
<span style="color:green;"></span>						<span style="color:green;">textToSend = &quot;Forward:\n&quot;;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">Vector BlockedUsersList = registration.getBlockedUsersList();</span>
<span style="color:green;"></span>					<span style="color:green;">if (BlockedUsersList != null){</span>
<span style="color:green;"></span>				<span style="color:green;">        Iterator itr = BlockedUsersList.iterator();</span>
<span style="color:green;"></span>				<span style="background-color:red;">    </span>	<span style="color:green;">while (itr.hasNext()){</span>
<span style="color:green;"></span>				<span style="background-color:red;">    </span>		<span style="color:green;">String CurrentBlockedUser = itr.next().toString();</span>
<span style="color:green;"></span>				<span style="background-color:red;">    </span>		<span style="color:green;">textToSend = textToSend + &quot;BlockedUser:&quot;+CurrentBlockedUser+&quot;\n&quot;;</span>
<span style="color:green;"></span><span style="background-color:red;">				    </span>
<span style="color:green;"></span>				<span style="background-color:red;">    </span>	<span style="color:green;">}</span><span style="background-color:red;">          </span>
<span style="color:green;"></span>			<span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">response.setContent(textToSend, hbill);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processUserInfo(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;No valid User to send him INFO&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>					<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserInfo(), response sent:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return ;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar.processUserInfo exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserInfo(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * Add the response to the user who wants to perform forwarding 22-1-2017</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized void processUserForward(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction ) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Add the key if it is a new user:</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserForward(), key: \&quot;&quot;+key+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">if (key==null){</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processUserForward(), key is null&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return ;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Content request sou einai: &quot;+request.getContent());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot; to RequestURI sou einai: &quot;+request.getRequestURI());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;To key tha einai: &quot;+key.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">String ForwardTo = null;</span>
<span style="color:green;"></span>				<span style="color:green;">boolean hasCycles = false;</span>
<span style="color:green;"></span>				<span style="color:green;">String Sender = key.toString();</span>
<span style="color:green;"></span>				<span style="color:green;">if(request.getMethod().equals(&quot;FORWARD&quot;)){</span>
<span style="color:green;"></span>					<span style="color:green;">ForwardTo = request.getRequestURI().toString();</span>
<span style="color:green;"></span>					<span style="color:green;">hasCycles = foundCycleInRegistrationsGraph(Sender, ForwardTo);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">//FIXED insert users that do not exist in list</span>
<span style="color:green;"></span>				<span style="color:green;">boolean forwardeeIsValid = false;</span>
<span style="color:green;"></span>				<span style="color:green;">if (ForwardTo!=null &amp;&amp; registrationsTable.hasRegistration(ForwardTo)){</span>
<span style="color:green;"></span>					<span style="color:green;">forwardeeIsValid = true;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">else if(ForwardTo==null){</span>
<span style="color:green;"></span>					<span style="color:green;">forwardeeIsValid = true;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">else{</span>
<span style="color:green;"></span>					<span style="color:green;">forwardeeIsValid = false;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">// Here we should validate if the update in the registration table by checking the graph</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">if(!hasCycles &amp;&amp; forwardeeIsValid){</span>
<span style="color:green;"></span>					<span style="color:green;">boolean updateresult = registrationsTable.updateForwardRegistration(Sender, ForwardTo);</span><span style="background-color:red;"> </span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">if (updateresult){</span>
<span style="color:green;"></span>						<span style="color:green;">//if we are here everything went as planned</span>
<span style="color:green;"></span>						<span style="color:green;">Response response=</span>
<span style="color:green;"></span>								<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span><span style="background-color:red;">						</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>						<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>							<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>						<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>						<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>							<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>							<span style="color:green;">(&quot;Registrar, processUserForward(), response sent:&quot;);</span>
<span style="color:green;"></span>							<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>						<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">						</span>
<span style="color:green;"></span>						<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>						<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:green;"></span><span style="background-color:red;">						</span>
<span style="color:green;"></span>						<span style="color:green;">return;</span>
<span style="color:green;"></span><span style="background-color:red;">						</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;No valid User To forward&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>					<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserForward(), response sent:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return ;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar.processUserForward exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserForward(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * Add the response to the user who wants to perform Block 25-1-2017</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized void processUserBlocking(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction ) {</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">// Add the key if it is a new user:</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug){</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserBlocking(), key: \&quot;&quot;+key+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">if (key==null){</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processUserBlocking(), key is null&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return ;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Content of request is: &quot;+request.getContent());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;URI of request is: &quot;+request.getRequestURI());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Key is: &quot;+key.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">boolean updateresult = false;</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">String BlockID = null;</span>
<span style="color:green;"></span>				<span style="color:green;">String Sender = key.toString();</span>
<span style="color:green;"></span>				<span style="color:green;">if(request.getMethod().equals(&quot;BLOCK&quot;)){</span>
<span style="color:green;"></span>					<span style="color:green;">BlockID = request.getRequestURI().toString();</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">//FIXED insert users that do not exist in list</span>
<span style="color:green;"></span>					<span style="color:green;">if (registrationsTable.hasRegistration(BlockID)){</span>
<span style="color:green;"></span>						<span style="color:green;">updateresult = registrationsTable.insertToBlockedUsersListRegistration(Sender, BlockID);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">else {</span>
<span style="color:green;"></span>						<span style="color:green;">updateresult = false;</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">if(request.getMethod().equals(&quot;UNBLOCK&quot;)){</span>
<span style="color:green;"></span>					<span style="color:green;">BlockID = request.getRequestURI().toString();</span>
<span style="color:green;"></span>					<span style="color:green;">updateresult = registrationsTable.deleteFromBlockedUsersListRegistration</span>
<span style="color:green;"></span>							<span style="color:green;">(Sender, BlockID);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">if (updateresult){</span>
<span style="color:green;"></span>					<span style="color:green;">//if we are here everything went as planned</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=</span>
<span style="color:green;"></span>							<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processUserBlocking(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">// if registrations table has changed we should update the registrations.xml file</span>
<span style="color:green;"></span>					<span style="color:green;">this.writeXMLRegistrations();</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;No valid User To Block&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>					<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserBlocking(), response sent:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return ;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar.processUserBlocking exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserBlocking(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public boolean foundCycleInRegistrationsGraph(String newV1, String newV2){</span>
<span style="color:green;"></span>		<span style="color:green;">// check if the functionality does not allow autoregression</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Prior To initilization!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">//intialize the graph object</span>
<span style="color:green;"></span>		<span style="color:green;">DirectedGraph&lt;String, DefaultEdge&gt; g = new DefaultDirectedGraph&lt;String, DefaultEdge&gt;(DefaultEdge.class);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Initialized Graph!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">Iterator iterator=registrationsTable.getRegistrations().keySet().iterator();</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Initialized Iterator!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:green;"></span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] In!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">Registration registration=(Registration)registrationsTable.getRegistrations().get(iterator.next());</span>
<span style="color:green;"></span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] Got Registration! &quot;+registration.toString());</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String vertexToAdd = registration.getKey();</span>
<span style="color:green;"></span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] Vertex To add! &quot;+vertexToAdd);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">g.addVertex(vertexToAdd);</span>
<span style="color:green;"></span>			<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph Iteration] Vertex Added! &quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Vertexes Done!&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">boolean sameEdgeTwice = false;</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">iterator=registrationsTable.getRegistrations().keySet().iterator();</span>
<span style="color:green;"></span>		<span style="color:green;">while (iterator!=null &amp;&amp; iterator.hasNext()) {</span>
<span style="color:green;"></span>			<span style="color:green;">Registration registration=(Registration)registrationsTable.getRegistrations().get(iterator.next());</span>
<span style="color:green;"></span>			<span style="color:green;">String v1 = registration.getKey();</span>
<span style="color:green;"></span>			<span style="color:green;">String v2 = registration.getForwardToUser();</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;[Edge Graph iteration] Checking Edge now: &quot;+ v1 + &quot;|&quot; +v2);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if (v2 != null){</span>
<span style="color:green;"></span>				<span style="color:green;">if (v1.equals(newV1) &amp;&amp; v2.equals(newV2)){</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println(&quot;[Edge Graph iteration] edge already found: &quot;+ v1 + &quot;|&quot; +v2);</span>
<span style="color:green;"></span>					<span style="color:green;">sameEdgeTwice = true;</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;[Edge Graph iteration] Inserting Edge now: &quot;+ v1 + &quot;|&quot; +v2);</span>
<span style="color:green;"></span>				<span style="color:green;">g.addEdge(v1,v2);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">//ProxyDebug.println(&quot;[Registrations Graph here] foundCycleInRegistrationsGraph: &quot;+ g);</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">//if the edge does not already exists then add it in the graph and check if there is a circle</span>
<span style="color:green;"></span>		<span style="color:green;">if (!sameEdgeTwice){</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;[Edge Graph iteration] The edge has NOT been found, Add it now: &quot;+ newV1 + &quot;|&quot; +newV2);</span>
<span style="color:green;"></span>			<span style="color:green;">g.addEdge(newV1, newV2);</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Built in visualization: &quot;+ g);</span>
<span style="color:green;"></span>	<span style="color:green;">    //JGraph jgraph = new JGraph( new JGraphModelAdapter( g ) );</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">CycleDetector&lt;String, DefaultEdge&gt; cycleDetector = new CycleDetector&lt;String, DefaultEdge&gt;(g);</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Cycle Detector: &quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">boolean result = cycleDetector.detectCycles();</span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;[Registrations Graph here] Cycle Detector result: &quot;+ result);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">return result;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public String findFinalForwardee(String key){</span>
<span style="color:green;"></span>		<span style="color:green;">Hashtable registrations=registrationsTable.getRegistrations();</span>
<span style="color:green;"></span><span style="color:green;">        Registration currentRegistration=(Registration)registrations.get(key);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">String currentForwardee = currentRegistration.getForwardToUser();</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">while (currentForwardee!=null){</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">currentRegistration = (Registration)registrations.get(currentForwardee);</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (currentRegistration == null){</span>
<span style="color:green;"></span>				<span style="color:green;">return null;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">currentForwardee = currentRegistration.getForwardToUser();</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">return currentRegistration.getKey();</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public boolean foundInBlockedUsersList(String caller, String callee){</span>
<span style="color:green;"></span>		<span style="color:green;">boolean result = registrationsTable.inBlockedUsersListRegistration(caller,callee);</span>
<span style="color:green;"></span>		<span style="color:green;">return result;</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span>
<span style="color:green;"></span>	<span style="color:green;"> * process the OPTION request</span>
<span style="color:green;"></span>	<span style="color:green;"> */</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">public void processUserBilling(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction , HeaderFactory headerFactory){</span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">String content = new String( request.getRawContent());</span>
<span style="color:green;"></span>			<span style="color:green;">String key = getKey(request);</span>
<span style="color:green;"></span>			<span style="color:green;">String duration = content.split(&quot;Duration:&quot;)[1];</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">duration = duration.replace(&quot;\n&quot;,&quot;&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">Integer durationTime = Integer.parseInt(duration);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">Double durationTimeInSec = new Double(durationTime) / 1000;</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">ProxyDebug.println(&quot;Duration in Time in Seconds: &quot;+durationTimeInSec+&quot; for Key: &quot;+key);</span>
<span style="color:green;"></span>			<span style="color:green;">Double chargement = durationTimeInSec;</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (key==null ){</span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Registrar, processUserBilling(), key is null&quot;+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot; 400 INVALID REQUEST replied&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>						<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">return ;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>			<span style="color:green;">if ( registrationsTable.hasRegistration(key) ) {</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">Hashtable registrations=registrationsTable.getRegistrations();</span>
<span style="color:green;"></span>		<span style="color:green;">        Registration registration=(Registration)registrations.get(key);</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Content of request is: &quot;+request.getContent());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;URI of request is: &quot;+request.getRequestURI());</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Key is: &quot;+key.toString());</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>				<span style="color:green;">boolean updateresult = true;</span>
<span style="color:green;"></span><span style="background-color:red;">								</span>
<span style="color:green;"></span>				<span style="color:green;">if (updateresult){</span>
<span style="color:green;"></span>					<span style="color:green;">//if we are here everything went as planned</span>
<span style="color:green;"></span>					<span style="color:green;">Response response=messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span>					<span style="color:green;">ContentTypeHeader hbill = headerFactory.createContentTypeHeader(&quot;application&quot;, &quot;billing&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">if (registration.getuserCategory().equals(&quot;Normal&quot;)){</span>
<span style="color:green;"></span>						<span style="color:green;">chargement = durationTimeInSec * Chargement.normalChargement;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>					<span style="color:green;">else if (registration.getuserCategory().equals(&quot;Premium&quot;)){</span>
<span style="color:green;"></span>						<span style="color:green;">chargement = durationTimeInSec * Chargement.premiumChargement;</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">String chargewritable = String.format( &quot;%.2f&quot;,chargement);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">response.setContent(&quot;Chargement: &quot;+chargement.toString(), hbill);</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">//file for appending all the charges over the users</span>
<span style="color:green;"></span>					<span style="color:green;">String fileForCharges = &quot;src/gov/nist/sip/proxy/configuration/UserCharges.txt&quot;;</span>
<span style="color:green;"></span>					<span style="color:green;">String textToAppend = &quot;User: &quot;+key+&quot;, Category: &quot;+registration.getuserCategory()+</span>
<span style="color:green;"></span>							<span style="color:green;">&quot;, Chargement: &quot; + chargewritable;</span>
<span style="color:green;"></span>					<span style="color:green;">this.appendFile(fileForCharges, textToAppend);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>						<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>					<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>					<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>						<span style="color:green;">(&quot;Registrar, processUserBilling(), response sent:&quot;);</span>
<span style="color:green;"></span>						<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>					<span style="color:green;">return;</span>
<span style="color:green;"></span><span style="background-color:red;">					</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">				</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span><span style="background-color:red;">			</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;No valid User To Charge the Bill&quot;);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">Response response=messageFactory.createResponse</span>
<span style="color:green;"></span>					<span style="color:green;">(Response.BAD_REQUEST,request);</span>
<span style="color:green;"></span>			<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>				<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">else sipProvider.sendResponse(response);</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserBilling(), response sent:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>			<span style="color:green;">return ;</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:green;"></span>		<span style="color:green;">} catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar.processUserBilling exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processUserBilling(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">//Function for debug purposes for a simple proxy response sender</span>
<span style="color:green;"></span>	<span style="color:green;">/*</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>	<span style="color:green;">public synchronized void processUserForward2(Request request, SipProvider sipProvider,</span>
<span style="color:green;"></span>			<span style="color:green;">ServerTransaction serverTransaction ) {</span>
<span style="color:green;"></span><span style="color:green;">        ProxyDebug.println(&quot;Kalispera paw gia na steilw&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">try{</span>
<span style="color:green;"></span>			<span style="color:green;">MessageFactory messageFactory=proxy.getMessageFactory();</span>
<span style="color:green;"></span>			<span style="color:green;">String key=getKey(request);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">Vector contactHeaders=getContactHeaders(key);</span>
<span style="color:green;"></span>				<span style="color:green;">Response response=</span>
<span style="color:green;"></span>				<span style="color:green;">messageFactory.createResponse(Response.OK,request);</span>
<span style="color:green;"></span>				<span style="color:green;">try{</span>
<span style="color:green;"></span>					<span style="color:green;">if ( hasExpiresZero(request) ) {</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(request.getHeader(ExpiresHeader.NAME));</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>					<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">if ( contactHeaders!=null ) {</span>
<span style="color:green;"></span>					<span style="color:green;">for (int i = 0; i &lt; contactHeaders.size(); i++) {</span>
<span style="color:green;"></span>						<span style="color:green;">ContactHeader contact = (ContactHeader)</span>
<span style="color:green;"></span>								<span style="color:green;">contactHeaders.elementAt(i);</span>
<span style="color:green;"></span>						<span style="color:green;">response.addHeader(contact);</span>
<span style="color:green;"></span>					<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">        ProxyDebug.println(&quot;Ligo prin steilw&quot;);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (serverTransaction!=null)</span>
<span style="color:green;"></span>					<span style="color:green;">serverTransaction.sendResponse(response);</span>
<span style="color:green;"></span>				<span style="color:green;">else sipProvider.sendResponse(response);</span><span style="background-color:red;"> </span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>				<span style="color:green;">if (ProxyDebug.debug)  {</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>					<span style="color:green;">(&quot;Response to FOrward klasopatata, response sent:&quot;);</span>
<span style="color:green;"></span>					<span style="color:green;">ProxyDebug.print(response.toString());</span>
<span style="color:green;"></span>				<span style="color:green;">}</span>
<span style="color:green;"></span>				<span style="color:green;">return;</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">catch (SipException ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println(&quot;Registrar exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">} catch(Exception ex) {</span>
<span style="color:green;"></span>			<span style="color:green;">if (ProxyDebug.debug) {</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.println</span>
<span style="color:green;"></span>				<span style="color:green;">(&quot;Registrar, processRegister(), internal error, &quot;+</span>
<span style="color:green;"></span>						<span style="color:green;">&quot;exception raised:&quot;);</span>
<span style="color:green;"></span>				<span style="color:green;">ProxyDebug.logException(ex);</span>
<span style="color:green;"></span>			<span style="color:green;">}</span>
<span style="color:green;"></span>		<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">*/</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
}
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/registrar/Registration.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ Registration.java:22 @</span><span style="font-weight:bold;text-decoration:blink;"> import gov.nist.sip.proxy.*;</span>
 * @version 1.0
 */
public class Registration {
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">// extra fields for forward and block</span><span style="background-color:red;"> </span>
<span style="color:green;"></span>	<span style="color:green;">protected String ForwardToUser;</span>
<span style="color:green;"></span>	<span style="color:green;">protected Vector BlockedUsersList;</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">//extra field for category of user</span>
<span style="color:green;"></span>	<span style="color:green;">public String userCategory;</span>
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">// extra field for password of the user</span>
<span style="color:green;"></span>	<span style="color:green;">protected String password;</span>

    protected FromHeader fromHeader;
    protected ToHeader toHeader;
<span style="color:teal;">@ Registration.java:46 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>
    public Registration() {
        toExport=true;
        contactsList=new Vector();
<span style="color:red;">	buddyList = new Vector();</span>
<span style="color:green;"></span><span style="color:green;">        buddyList = new Vector();</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        //initialization</span>
<span style="color:green;"></span><span style="color:green;">        BlockedUsersList = new Vector();</span>
<span style="color:green;"></span><span style="color:green;">        setForwardToUser (null);</span>
<span style="color:green;"></span><span style="color:green;">        setuserCategory (&quot;Normal&quot;);</span>
<span style="color:green;"></span><span style="color:green;">        setPassword(&quot;&quot;);</span>
    }
    
    protected ExportedBinding exportBinding() {
<span style="color:teal;">@ Registration.java:75 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>

    }
    
<span style="color:green;"></span><span style="color:green;">    public Vector getBlockedUsersList() {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">return BlockedUsersList;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public void setBlockedUsersList( Vector UserList) {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">this.BlockedUsersList = UserList;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public String getForwardToUser() {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">return ForwardToUser;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public void setForwardToUser( String User) {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">this.ForwardToUser = User;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public String getuserCategory () {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">return userCategory;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public void setuserCategory( String categ) {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">this.userCategory = categ;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
    public Vector getContactsList() {
        return contactsList;
    }
<span style="color:teal;">@ Registration.java:107 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>
        this.contactsList=contactsList;
    }
    
<span style="color:green;"></span><span style="color:green;">    public String getPassword () {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">return password;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public void setPassword( String passw) {</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">this.password = passw;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
    public void addContactHeader(ContactHeader contactHeader) {
       contactsList.addElement(contactHeader);
    }
<span style="color:teal;">@ Registration.java:162 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>
      
    }
    
<span style="color:green;"></span><span style="color:green;">    public boolean insertToBlockedUsersListRegistration(String NewBlockedUser){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">boolean result = false;</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">String newDesignatedBlockUser = NewBlockedUser;</span>
<span style="color:green;"></span><span style="color:green;">        Vector BlockedList = this.getBlockedUsersList();</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">//valid user to insert into registration</span>
<span style="color:green;"></span><span style="color:green;">        if ( newDesignatedBlockUser!=null ){</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">if (BlockedList != null){</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>		<span style="color:green;">// check if this block is inside the list</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">Iterator itr = BlockedList.iterator();</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">String CurrentBlockedUser = null;</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">while (itr.hasNext()){</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>		<span style="color:green;">CurrentBlockedUser = itr.next().toString();</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="background-color:red;">            </span>		<span style="color:green;">if (CurrentBlockedUser.equals(newDesignatedBlockUser)){</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>			<span style="color:green;">result = false;</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>			<span style="color:green;">return result;</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">BlockedList.add(newDesignatedBlockUser);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">this.setBlockedUsersList(BlockedList);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">result = true;</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="color:green;">        return result;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public boolean deleteFromBlockedUsersListRegistration( String NewBlockedUser){</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">boolean result = false;</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">String newDesignatedBlockUser = NewBlockedUser;</span>
<span style="color:green;"></span><span style="color:green;">        Vector BlockedList = this.getBlockedUsersList();</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">//valid user to insert into registration</span>
<span style="color:green;"></span><span style="color:green;">        if ( newDesignatedBlockUser!=null &amp;&amp; BlockedList != null){</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">result = BlockedList.remove(newDesignatedBlockUser);</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">this.setBlockedUsersList(BlockedList);</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">            	</span>
<span style="color:green;"></span><span style="color:green;">        return result;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
    public void updateContactHeader(ContactHeader contactParameter) {
        
        Address addressParam=contactParameter.getAddress();
<span style="color:teal;">@ Registration.java:285 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>
            retval.append(&quot;display_name=\&quot;&quot;+displayName+&quot;\&quot;&quot;);
        }
     
<span style="color:red;">        retval.append(&quot; uri=\&quot;&quot;+key+&quot;\&quot; &quot;);</span>
<span style="color:green;"></span><span style="color:green;">        if (this.getuserCategory()!=null) {</span>
<span style="color:green;"></span><span style="color:green;">            retval.append(&quot; category=\&quot;&quot;+this.getuserCategory()+&quot;\&quot; &quot;);</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        if (this.getPassword()!=null) {</span>
<span style="color:green;"></span><span style="color:green;">            retval.append(&quot; password=\&quot;&quot;+this.getPassword()+&quot;\&quot; &quot;);</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        retval.append(&quot;uri=\&quot;&quot;+key+&quot;\&quot;&gt; &quot;);</span>
     
        for( int i=0; i&lt;contactsList.size();i++) {
            retval.append(&quot;     &lt;CONTACT &quot;);
<span style="color:teal;">@ Registration.java:318 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> public class Registration {</span>
	
	// Append the buddy list to the contact.
        for( int i=0; i&lt;buddyList.size();i++) {
<span style="color:red;font-weight:bold;">	     retval.append(&quot; &lt;BUDDY  uri= \&quot;&quot;).append(buddyList.elementAt(i).toString()).append(&quot;/&gt;</span><span style="color:red;font-weight:bold;text-decoration:blink;">\n</span><span style="color:red;font-weight:bold;">&quot;);</span>
<span style="color:green;font-weight:bold;">	     retval.append(&quot; &lt;BUDDY  uri= \&quot;&quot;).append(buddyList.elementAt(i).toString()).append(&quot;/&gt;</span><span style="color:green;font-weight:bold;text-decoration:blink;"> </span><span style="color:green;font-weight:bold;">&quot;);</span>
	}
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">      // Append the new fields as well 27-1-2017 update</span>
<span style="color:green;"></span><span style="color:green;">        if (this.getForwardToUser()!=null) {</span>
<span style="color:green;"></span><span style="color:green;">            retval.append(&quot;&lt;FORWARD_TO uri=\&quot;&quot;+this.getForwardToUser()+&quot;\&quot;/&gt; &quot;);</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        if (this.BlockedUsersList != null){</span>
<span style="color:green;"></span>	<span style="color:green;">        Iterator itr = this.BlockedUsersList.iterator();</span>
<span style="color:green;"></span>	<span style="background-color:red;">    </span>	<span style="color:green;">while (itr.hasNext()){</span>
<span style="color:green;"></span>	<span style="background-color:red;">    </span>		<span style="color:green;">String CurrentBlockedUser = itr.next().toString();</span>
<span style="color:green;"></span>	<span style="background-color:red;">    </span>		<span style="color:green;">retval.append(&quot;&lt;BLOCKED_USER uri=\&quot;&quot;+CurrentBlockedUser+&quot;\&quot;/&gt; &quot;);</span>
<span style="color:green;"></span>	<span style="background-color:red;">    </span>	<span style="color:green;">}</span><span style="background-color:red;">          </span>
<span style="color:green;"></span><span style="color:green;">        }</span>

<span style="color:red;font-weight:bold;">        retval.append(&quot;</span><span style="color:red;font-weight:bold;text-decoration:blink;"></span><span style="color:red;font-weight:bold;">&lt;/REGISTRATION&gt;\n&quot;);</span>
<span style="color:green;font-weight:bold;">        retval.append(&quot;</span><span style="color:green;font-weight:bold;text-decoration:blink;">\n</span><span style="color:green;font-weight:bold;">&lt;/REGISTRATION&gt;\n&quot;);</span>
	return retval.toString();
    }
    
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/registrar/RegistrationsTable.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ RegistrationsTable.java:169 @</span><span style="font-weight:bold;text-decoration:blink;"> throws RemoteException</span>
	FromHeader fromHeader = (FromHeader)request.getHeader(FromHeader.NAME);
	registration.fromHeader = fromHeader;
        
<span style="color:green;"></span><span style="background-color:red;">	</span>
<span style="color:green;"></span>	<span style="color:green;">//set password</span>
<span style="color:green;"></span>	<span style="color:green;">String content = new String( request.getRawContent());</span>
<span style="color:green;"></span>	<span style="color:green;">String pass = content;</span>
<span style="color:green;"></span>	<span style="color:green;">try{</span>
<span style="color:green;"></span>		<span style="color:green;">pass = content.split(&quot;Password:&quot;)[1];</span>
<span style="color:green;"></span>		<span style="color:green;">pass = pass.replace(&quot;\n&quot;,&quot;&quot;);</span>
<span style="color:green;"></span>		<span style="color:green;">registration.setPassword(pass);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
<span style="color:green;"></span>	<span style="color:green;">catch(Exception e){</span>
<span style="color:green;"></span>		<span style="color:green;">e.printStackTrace();</span>
<span style="color:green;"></span>		<span style="color:green;"> ProxyDebug.println(&quot;Add Registration Exception&quot;);</span>
<span style="color:green;"></span>	<span style="color:green;">}</span>
        
<span style="color:green;"></span><span style="background-color:red;">		</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span>		<span style="color:green;">ProxyDebug.println(&quot;Registration Request: &quot; + request.toString());</span>
        registrations.put(key,registration);
        ProxyDebug.println
	(&quot;RegistrationsTable, addRegistration(), registration &quot;+
<span style="color:teal;">@ RegistrationsTable.java:225 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> throws RemoteException</span>
	(&quot;RegistrationsTable, addRegistration(), registration &quot;+
        &quot; added for the key: &quot;+key);
        
<span style="color:green;"></span><span style="color:green;">        //initialize forward and block values</span><span style="background-color:red;"> </span>
<span style="color:green;"></span><span style="color:green;">        //registration.setBlockedUsersList(null);</span>
<span style="color:green;"></span><span style="color:green;">        //registration.setForwardToUser(null);</span>
<span style="color:green;"></span><span style="background-color:red;">       </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
        printRegistrations();
        
        updateGUI(registration,false);
<span style="color:teal;">@ RegistrationsTable.java:263 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> throws RemoteException</span>
            }
        }
    }
<span style="color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">     </span>
<span style="color:green;"></span><span style="color:green;">    //Update REgistration does not update all values but ONLY CONTACT LIST!!!!!!!!</span>
    public void updateRegistration(String key,Request request) throws Exception {
        ProxyDebug.println(&quot;RegistrationsTable, updateRegistration(), registration updated&quot;+
        &quot; for the key: &quot;+key);
<span style="color:teal;">@ RegistrationsTable.java:383 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> throws RemoteException</span>
            String keyTable=(String)e.nextElement();
            Registration registration=(Registration)registrations.get(keyTable);
            ProxyDebug.println(&quot;registered user: \&quot;&quot;+keyTable+&quot;\&quot;&quot;);
<span style="color:red;">            registration.print();</span>
<span style="color:green;"></span><span style="color:green;">            ProxyDebug.println(&quot;Forward To User: \&quot;&quot;+registration.getForwardToUser()+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>
<span style="color:green;"></span><span style="background-color:red;">            </span>
<span style="color:green;"></span><span style="color:green;">            //ProxyDebug.println(&quot;Blocked Users List: \&quot;&quot;+registration.getBlockedUsersList().toString()+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            Vector BlockedList = registration.getBlockedUsersList();</span>
<span style="color:green;"></span><span style="color:green;">            ProxyDebug.println(&quot;Blocked Users List: &quot;);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">// check if this block is inside the list</span>
<span style="color:green;"></span><span style="color:green;">            if (BlockedList != null){</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">Iterator itr = BlockedList.iterator();</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">while (itr.hasNext()){</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>		<span style="color:green;">String CurrentBlockedUser = itr.next().toString();</span>
<span style="color:green;"></span><span style="color:green;">                    ProxyDebug.println(&quot;	Blocked User: &quot;+CurrentBlockedUser);</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">}</span><span style="background-color:red;">           </span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="background-color:red;">        	</span>
            ProxyDebug.println();
        }
        ProxyDebug.println(&quot;************************************************&quot;);
<span style="color:teal;">@ RegistrationsTable.java:427 @</span><span style="color:teal;font-weight:bold;"></span><span style="font-weight:bold;text-decoration:blink;"> throws RemoteException</span>
        }
    }
    
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    // Implement some functions in order to update the registration tables for Forward and Block Requests</span>
<span style="color:green;"></span><span style="color:green;">    public boolean updateForwardRegistration(String key, String NewUserToForward){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">ProxyDebug.println(&quot;RegistrationsTable, updateForwardRegistration(), registration updated&quot;+</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">        &quot; for the key: &quot;+key);</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">boolean result = true;</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">String newDesignatedUserToForward = NewUserToForward;</span>
<span style="color:green;"></span><span style="color:green;">        Registration registration=(Registration)registrations.get(key);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">// TODO check if this Forward should be done (according to graph)</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">registration.setForwardToUser(newDesignatedUserToForward);</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">        printRegistrations();</span>
<span style="color:green;"></span><span style="color:green;">        //see if GUI is mandatory to be updated</span>
<span style="color:green;"></span><span style="color:green;">        return result;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public boolean insertToBlockedUsersListRegistration(String key, String NewBlockedUser){</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">String newDesignatedBlockUser = NewBlockedUser;</span>
<span style="color:green;"></span><span style="color:green;">        Registration registration=(Registration)registrations.get(key);</span><span style="background-color:red;">   	</span>
<span style="color:green;"></span><span style="color:green;">        return registration.insertToBlockedUsersListRegistration(NewBlockedUser);</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public boolean deleteFromBlockedUsersListRegistration(String key, String NewBlockedUser){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">ProxyDebug.println(&quot;RegistrationsTable, deleteFromBlockedUsersListRegistration(), &quot;</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>			<span style="color:green;">+ &quot;registration updated&quot;+&quot; for the key: &quot;+key);</span>
<span style="color:green;"></span><span style="background-color:red;">    	</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">String newDesignatedBlockUser = NewBlockedUser;</span>
<span style="color:green;"></span><span style="color:green;">        Registration registration=(Registration)registrations.get(key);</span>
<span style="color:green;"></span><span style="color:green;">        return registration.deleteFromBlockedUsersListRegistration(NewBlockedUser);</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="color:green;">    public boolean inBlockedUsersListRegistration(String key, String blockedUser){</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">Registration registration=(Registration)registrations.get(key);</span>
<span style="color:green;"></span><span style="color:green;">        ProxyDebug.println(&quot;inBlockedUsersListRegistration registered user: &quot;+key+&quot;\&quot;&quot;);</span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        //ProxyDebug.println(&quot;Blocked Users List: \&quot;&quot;+registration.getBlockedUsersList().toString()+&quot;\&quot;&quot;);</span>
<span style="color:green;"></span><span style="color:green;">        Vector BlockedList = registration.getBlockedUsersList();</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>	<span style="color:green;">// check if this blocked is inside the list</span>
<span style="color:green;"></span><span style="color:green;">        if (BlockedList != null){</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">Iterator itr = BlockedList.iterator();</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">while (itr.hasNext()){</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>		<span style="color:green;">String CurrentBlockedUser = itr.next().toString();</span>
<span style="color:green;"></span><span style="color:green;">                ProxyDebug.println(&quot;	Blocked User: &quot;+CurrentBlockedUser);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>		<span style="color:green;">if (CurrentBlockedUser.equals(blockedUser)){</span>
<span style="color:green;"></span><span style="color:green;">                    ProxyDebug.println(&quot;FOUND HIM!!  &quot;+CurrentBlockedUser);</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>			<span style="color:green;">return true;</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>		<span style="color:green;">}</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">}</span><span style="background-color:red;">           </span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="color:green;">        return false;</span>
<span style="color:green;"></span><span style="color:green;">    }</span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
<span style="color:green;"></span><span style="background-color:red;">    </span>
}
<span style="font-weight:bold;">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
modified: sip-proxy/src/gov/nist/sip/proxy/registrar/XMLRegistrationsParser.java
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</span><span style="color:teal;font-weight:bold;">@ XMLRegistrationsParser.java:132 @</span><span style="font-weight:bold;text-decoration:blink;"> public class XMLRegistrationsParser extends DefaultHandler {</span>
                 &quot;the uri attribute has not been specified for the &quot;+
		  &quot;registration tag.&quot;);
            }
<span style="color:green;"></span><span style="color:green;">            String category=attrs.getValue(&quot;category&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            if (category!=null &amp;&amp; !category.trim().equals(&quot;&quot;) ) {</span>
<span style="color:green;"></span><span style="color:green;">                   registration.setuserCategory(category);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            else {</span>
<span style="color:green;"></span><span style="color:green;">                  ProxyDebug.println</span>
<span style="color:green;"></span>		<span style="color:green;">(&quot;WARNING, XMLRegistrationsParser, startElement()&quot;+</span>
<span style="color:green;"></span><span style="color:green;">                &quot; the userCategory attribute is not set for the registration tag!!!&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            String password=attrs.getValue(&quot;password&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            if (password!=null &amp;&amp; !password.trim().equals(&quot;&quot;) ) {</span>
<span style="color:green;"></span><span style="color:green;">                   registration.setPassword(password);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            else {</span>
<span style="color:green;"></span><span style="color:green;">                  ProxyDebug.println</span>
<span style="color:green;"></span>		<span style="color:green;">(&quot;WARNING, XMLRegistrationsParser, startElement()&quot;+</span>
<span style="color:green;"></span><span style="color:green;">                &quot; the password attribute is not set for the registration tag!!!&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:gray;background-color:black;"></span><span style="color:green;background-color:black;"> </span>
<span style="color:green;"></span><span style="color:green;">        if (element.compareToIgnoreCase(&quot;forward_to&quot;) ==0 ) {</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>
<span style="color:green;"></span><span style="color:green;">            String forwardTo=attrs.getValue(&quot;uri&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            if (forwardTo!=null &amp;&amp; !forwardTo.trim().equals(&quot;&quot;) ) {</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">registration.setForwardToUser(forwardTo);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            else {</span>
<span style="color:green;"></span><span style="color:green;">                  ProxyDebug.println</span>
<span style="color:green;"></span>		<span style="color:green;">(&quot;WARNING, XMLRegistrationsParser, startElement()&quot;+</span>
<span style="color:green;"></span><span style="color:green;">                &quot; the forwardTo user is not set for the element forwardTo!!!&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">        }</span>
<span style="color:green;"></span><span style="background-color:red;">        </span>
<span style="color:green;"></span><span style="color:green;">        if (element.compareToIgnoreCase(&quot;blocked_user&quot;) ==0 ) {</span>
<span style="color:green;"></span><span style="background-color:red;">           </span>
<span style="color:green;"></span><span style="background-color:red;">        </span>	<span style="color:green;">ProxyDebug.println(&quot;Papotsi: &quot; + element);</span>
<span style="color:green;"></span><span style="color:green;">            String blockUser=attrs.getValue(&quot;uri&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            if (blockUser!=null &amp;&amp; !blockUser.trim().equals(&quot;&quot;) ) {</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">ProxyDebug.println(&quot;Papotsi: &quot; + blockUser);</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">registration.insertToBlockedUsersListRegistration(blockUser);</span>
<span style="color:green;"></span><span style="background-color:red;">            </span>	<span style="color:green;">ProxyDebug.println(&quot;Papotsi: &quot; + registration.getBlockedUsersList().toString());</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
<span style="color:green;"></span><span style="color:green;">            else {</span>
<span style="color:green;"></span><span style="color:green;">                  ProxyDebug.println</span>
<span style="color:green;"></span>		<span style="color:green;">(&quot;WARNING, XMLRegistrationsParser, startElement()&quot;+</span>
<span style="color:green;"></span><span style="color:green;">                &quot; the uri at the blocked_user element is wrong!!!&quot;);</span>
<span style="color:green;"></span><span style="color:green;">            }</span>
        }
        
     
</pre>
</body>
</html>
